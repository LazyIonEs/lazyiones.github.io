<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Android CameraX的基本使用 | LazyIonEs</title><meta name="author" content="LazyIonEs"><meta name="copyright" content="LazyIonEs"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="前言虽然网上有很多CameraX的教程，但是每次用CameraX的时候总要在翻一翻官方的文档或者网上的教程之类的，这次就自己记一下吧，翻自己的总比翻别人的好吧🤪 声明依赖项要添加 CameraX 的依赖项，您必须将 Google Maven 代码库添加到项目中。 打开项目的 settings.gradle 文件并添加 google() 代码库，如下所示： GroovyKotlin1234567d">
<meta property="og:type" content="article">
<meta property="og:title" content="Android CameraX的基本使用">
<meta property="og:url" content="https://blog.lazyiones.top/post/ff52020d.html">
<meta property="og:site_name" content="LazyIonEs">
<meta property="og:description" content="前言虽然网上有很多CameraX的教程，但是每次用CameraX的时候总要在翻一翻官方的文档或者网上的教程之类的，这次就自己记一下吧，翻自己的总比翻别人的好吧🤪 声明依赖项要添加 CameraX 的依赖项，您必须将 Google Maven 代码库添加到项目中。 打开项目的 settings.gradle 文件并添加 google() 代码库，如下所示： GroovyKotlin1234567d">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.lazyiones.top/img/cover/img_cover_1.png">
<meta property="article:published_time" content="2023-08-14T11:31:06.000Z">
<meta property="article:modified_time" content="2023-09-01T06:57:42.182Z">
<meta property="article:author" content="LazyIonEs">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="CameraX">
<meta property="article:tag" content="Jetpack">
<meta property="article:tag" content="相机">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.lazyiones.top/img/cover/img_cover_1.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://blog.lazyiones.top/post/ff52020d.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":230},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'mediumZoom',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: true,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Android CameraX的基本使用',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-09-01 14:57:42'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 8 || hour >= 22
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "/img/loading.gif" data-lazy-src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">7</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">12</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 娱乐</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 相册</span></a></li><li><a class="site-page child" href="/bangumis/"><i class="fa-fw fa-brands fa-youtube"></i><span> 番剧</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/top_banner_2.png')"><nav id="nav"><span id="blog-info"><a href="/" title="LazyIonEs"><span class="site-name">LazyIonEs</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 娱乐</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 相册</span></a></li><li><a class="site-page child" href="/bangumis/"><i class="fa-fw fa-brands fa-youtube"></i><span> 番剧</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Android CameraX的基本使用</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-08-14T11:31:06.000Z" title="发表于 2023-08-14 19:31:06">2023-08-14</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-09-01T06:57:42.182Z" title="更新于 2023-09-01 14:57:42">2023-09-01</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Android/">Android</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Android/CameraX/">CameraX</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">8.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>31分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Android CameraX的基本使用"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/post/ff52020d.html#post-comment"><span class="waline-comment-count" data-path="/post/ff52020d.html"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>虽然网上有很多<code>CameraX</code>的教程，但是每次用<code>CameraX</code>的时候总要在翻一翻官方的文档或者网上的教程之类的，这次就自己记一下吧，翻自己的总比翻别人的好吧🤪</p>
<h2 id="声明依赖项"><a href="#声明依赖项" class="headerlink" title="声明依赖项"></a>声明依赖项</h2><p>要添加 CameraX 的依赖项，您必须将 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/studio/build/dependencies?hl=zh-cn#google-maven">Google Maven 代码库</a>添加到项目中。</p>
<p>打开项目的 <code>settings.gradle</code> 文件并添加 <code>google()</code> 代码库，如下所示：</p>
<div class="tabs" id="添加-`google()`"><ul class="nav-tabs"><button type="button" class="tab  active" data-href="添加-`google()`-1">Groovy</button><button type="button" class="tab " data-href="添加-`google()`-2">Kotlin</button></ul><div class="tab-contents"><div class="tab-item-content active" id="添加-`google()`-1"><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dependencyResolutionManagement &#123;</span><br><span class="line">    repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)</span><br><span class="line">    repositories &#123;</span><br><span class="line">        google()</span><br><span class="line">        mavenCentral()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="tab-item-content" id="添加-`google()`-2"><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dependencyResolutionManagement &#123;</span><br><span class="line">    repositoriesMode.<span class="keyword">set</span>(RepositoriesMode.FAIL_ON_PROJECT_REPOS)</span><br><span class="line">    repositories &#123;</span><br><span class="line">        google()</span><br><span class="line">        mavenCentral()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div>

<p>将以下内容添加到 Android 代码块的末尾：</p>
<div class="tabs" id="添加-jvmtarget"><ul class="nav-tabs"><button type="button" class="tab  active" data-href="添加-jvmtarget-1">Groovy</button><button type="button" class="tab " data-href="添加-jvmtarget-2">Kotlin</button></ul><div class="tab-contents"><div class="tab-item-content active" id="添加-jvmtarget-1"><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    compileOptions &#123;</span><br><span class="line">        sourceCompatibility JavaVersion.VERSION_1_8</span><br><span class="line">        targetCompatibility JavaVersion.VERSION_1_8</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// For Kotlin projects</span></span><br><span class="line">    kotlinOptions &#123;</span><br><span class="line">        jvmTarget = <span class="string">&quot;1.8&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="tab-item-content" id="添加-jvmtarget-2"><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    compileOptions &#123;</span><br><span class="line">        sourceCompatibility = JavaVersion.VERSION_1_8</span><br><span class="line">        targetCompatibility = JavaVersion.VERSION_1_8</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// For Kotlin projects</span></span><br><span class="line">    kotlinOptions &#123;</span><br><span class="line">        jvmTarget = <span class="string">&quot;1.8&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div>

<p>将以下内容添加到应用的每个模块的 <code>build.gradle</code> 文件中：</p>
<div class="tabs" id="添加-`build.gradle`"><ul class="nav-tabs"><button type="button" class="tab  active" data-href="添加-`build.gradle`-1">Groovy</button><button type="button" class="tab " data-href="添加-`build.gradle`-2">Kotlin</button></ul><div class="tab-contents"><div class="tab-item-content active" id="添加-`build.gradle`-1"><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">  <span class="comment">// CameraX核心库使用camera2实现</span></span><br><span class="line">  <span class="keyword">def</span> camerax_version = <span class="string">&quot;1.2.3&quot;</span></span><br><span class="line">  <span class="comment">// 以下行是可选的，因为核心库是由camera-camera2间接包含的</span></span><br><span class="line">  implementation <span class="string">&quot;androidx.camera:camera-core:$&#123;camerax_version&#125;&quot;</span></span><br><span class="line">  implementation <span class="string">&quot;androidx.camera:camera-camera2:$&#123;camerax_version&#125;&quot;</span></span><br><span class="line">  <span class="comment">// 如果您想另外使用 CameraX Lifecycle 库</span></span><br><span class="line">  implementation <span class="string">&quot;androidx.camera:camera-lifecycle:$&#123;camerax_version&#125;&quot;</span></span><br><span class="line">  <span class="comment">// 如果您想另外使用 CameraX VideoCapture 库</span></span><br><span class="line">  implementation <span class="string">&quot;androidx.camera:camera-video:$&#123;camerax_version&#125;&quot;</span></span><br><span class="line">  <span class="comment">// 如果您想另外使用 CameraX View 类</span></span><br><span class="line">  implementation <span class="string">&quot;androidx.camera:camera-view:$&#123;camerax_version&#125;&quot;</span></span><br><span class="line">  <span class="comment">// 如果您想另外添加 CameraX ML Kit Vision Integration</span></span><br><span class="line">  implementation <span class="string">&quot;androidx.camera:camera-mlkit-vision:$&#123;camerax_version&#125;&quot;</span></span><br><span class="line">  <span class="comment">// 如果您想另外使用 CameraX Extensions 库</span></span><br><span class="line">  implementation <span class="string">&quot;androidx.camera:camera-extensions:$&#123;camerax_version&#125;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="tab-item-content" id="添加-`build.gradle`-2"><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    <span class="comment">// CameraX核心库使用camera2实现</span></span><br><span class="line">    <span class="keyword">val</span> camerax_version = <span class="string">&quot;1.2.3&quot;</span></span><br><span class="line">    <span class="comment">// 以下行是可选的，因为核心库是由camera-camera2间接包含的</span></span><br><span class="line">    implementation(<span class="string">&quot;androidx.camera:camera-core:<span class="subst">$&#123;camerax_version&#125;</span>&quot;</span>)</span><br><span class="line">    implementation(<span class="string">&quot;androidx.camera:camera-camera2:<span class="subst">$&#123;camerax_version&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="comment">// 如果您想另外使用 CameraX Lifecycle 库</span></span><br><span class="line">    implementation(<span class="string">&quot;androidx.camera:camera-lifecycle:<span class="subst">$&#123;camerax_version&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="comment">// 如果您想另外使用 CameraX VideoCapture 库</span></span><br><span class="line">    implementation(<span class="string">&quot;androidx.camera:camera-video:<span class="subst">$&#123;camerax_version&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="comment">// 如果您想另外使用 CameraX View 类</span></span><br><span class="line">    implementation(<span class="string">&quot;androidx.camera:camera-view:<span class="subst">$&#123;camerax_version&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="comment">// 如果您想另外添加 CameraX ML Kit Vision Integration</span></span><br><span class="line">    implementation(<span class="string">&quot;androidx.camera:camera-mlkit-vision:<span class="subst">$&#123;camerax_version&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="comment">// 如果您想另外使用 CameraX Extensions 库</span></span><br><span class="line">    implementation(<span class="string">&quot;androidx.camera:camera-extensions:<span class="subst">$&#123;camerax_version&#125;</span>&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div>

<p>如需详细了解如何配置应用以满足上述要求或查看CameraX最新版本号，请参阅<a target="_blank" rel="noopener" href="https://developer.android.google.cn/jetpack/androidx/releases/camera">声明依赖项</a>。</p>
<h2 id="实现预览"><a href="#实现预览" class="headerlink" title="实现预览"></a>实现预览</h2><p>在向应用添加预览时，请使用 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/kotlin/androidx/camera/view/PreviewView?hl=zh-cn"><code>PreviewView</code></a>，这是一种可以剪裁、缩放和旋转以确保正确显示的 <code>View</code>。</p>
<p>当相机处于活动状态时，图片预览会流式传输到 <code>PreviewView</code> 中的 Surface。</p>
<h3 id="将-PreviewView-添加到布局"><a href="#将-PreviewView-添加到布局" class="headerlink" title="将 PreviewView 添加到布局"></a>将 PreviewView 添加到布局</h3><p>以下示例显示了布局中的 <code>PreviewView</code>：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">FrameLayout</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">&quot;@+id/container&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">androidx.camera.view.PreviewView</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">&quot;@+id/previewView&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">FrameLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="初始化相机"><a href="#初始化相机" class="headerlink" title="初始化相机"></a>初始化相机</h3><p>以下代码展示了如何初始化预览需要 <code>CameraProvider</code>：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> androidx.camera.lifecycle.ProcessCameraProvider</span><br><span class="line"><span class="keyword">import</span> com.google.common.util.concurrent.ListenableFuture</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CameraActivity</span> : <span class="type">AppCompatActivity</span>() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> cameraProviderFuture : ListenableFuture&lt;ProcessCameraProvider&gt;</span><br><span class="line">  	<span class="keyword">private</span> <span class="keyword">var</span> cameraProvider: ProcessCameraProvider? = <span class="literal">null</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化相机，可在onCreate()内调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">initCamera</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// 检查权限</span></span><br><span class="line">      	checkPermission() &#123;</span><br><span class="line">          	cameraProviderFuture = ProcessCameraProvider.getInstance(<span class="keyword">this</span>)</span><br><span class="line">          	cameraProviderFuture.addListener(&#123;</span><br><span class="line">                cameraProvider = cameraProviderFuture.<span class="keyword">get</span>()</span><br><span class="line">            		<span class="comment">// 检查摄像头</span></span><br><span class="line">                lensFacing = <span class="keyword">when</span> &#123;</span><br><span class="line">                    hasBackCamera() -&gt; CameraSelector.LENS_FACING_BACK</span><br><span class="line">                    hasFrontCamera() -&gt; CameraSelector.LENS_FACING_FRONT</span><br><span class="line">                    <span class="keyword">else</span> -&gt; &#123;</span><br><span class="line">                        toast(<span class="string">&quot;前后摄像头不可用&quot;</span>)</span><br><span class="line">                        <span class="keyword">return</span><span class="symbol">@addListener</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            		<span class="comment">// (可忽略) 将PreviewView的预览View改为TextureView</span></span><br><span class="line">                binding.previewView.implementationMode = PreviewView.ImplementationMode.COMPATIBLE</span><br><span class="line">                <span class="comment">// 	绑定相机</span></span><br><span class="line">                bindPreview(cameraProvider ?: <span class="keyword">return</span><span class="symbol">@addListener</span>)</span><br><span class="line">            &#125;, ContextCompat.getMainExecutor(requireContext()))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="检查摄像头"><a href="#检查摄像头" class="headerlink" title="检查摄像头"></a>检查摄像头</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 如果设备有可用的后置摄像头，则返回 true。否则为假 */</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">hasBackCamera</span><span class="params">()</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> cameraProvider?.hasCamera(CameraSelector.DEFAULT_BACK_CAMERA) ?: <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 如果设备有可用的前置摄像头，则返回 true。否则为假 */</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">hasFrontCamera</span><span class="params">()</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> cameraProvider?.hasCamera(CameraSelector.DEFAULT_FRONT_CAMERA) ?: <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="绑定相机"><a href="#绑定相机" class="headerlink" title="绑定相机"></a>绑定相机</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Camera</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> camera: Camera? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建Preview</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> preview <span class="keyword">by</span> lazy &#123;</span><br><span class="line">		Preview.Builder().build()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当前摄像头</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> lensFacing: <span class="built_in">Int</span> = CameraSelector.LENS_FACING_BACK</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 绑定相机</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">bindPreview</span><span class="params">(cameraProvider: <span class="type">ProcessCameraProvider</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 选择摄像头</span></span><br><span class="line">		<span class="keyword">val</span> cameraSelector = CameraSelector.Builder().requireLensFacing(lensFacing).build()</span><br><span class="line">		<span class="comment">// 解除所有绑定</span></span><br><span class="line">		cameraProvider.unbindAll()</span><br><span class="line">		<span class="comment">// 将所选相机和任意用例绑定到生命周期</span></span><br><span class="line">		camera = cameraProvider.bindToLifecycle(<span class="keyword">this</span>, cameraSelector, preview)</span><br><span class="line">		<span class="comment">// 将 Preview 连接到 PreviewView</span></span><br><span class="line">		preview.setSurfaceProvider(binding.previewView.surfaceProvider)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>请注意，<a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/lifecycle/ProcessCameraProvider#bindToLifecycle(androidx.lifecycle.LifecycleOwner,%20androidx.camera.core.CameraSelector,%20androidx.camera.core.UseCase...)"><code>bindToLifecycle()</code></a> 会返回一个 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/Camera?hl=zh-cn"><code>Camera</code></a> 对象。如需详细了解如何控制相机输出（例如变焦和曝光），请参阅<a target="_blank" rel="noopener" href="https://developer.android.google.cn/training/camerax/configuration?hl=zh-cn#camera-output">相机输出</a>。</p>
<h2 id="图片拍摄"><a href="#图片拍摄" class="headerlink" title="图片拍摄"></a>图片拍摄</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> imageCapture <span class="keyword">by</span> lazy &#123;</span><br><span class="line">		ImageCapture.Builder().setCaptureMode(ImageCapture.CAPTURE_MODE_MAXIMIZE_QUALITY)</span><br><span class="line">				.setTargetAspectRatio(AspectRatio.RATIO_4_3).build()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 方向</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> orientationEventListener: OrientationEventListener? = <span class="literal">null</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在<code>cameraProviderFuture.addListener</code>内部添加 调用<code>bindPreview() </code>方法之前</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">orientationEventListener = <span class="keyword">object</span> : OrientationEventListener(<span class="keyword">this</span>) &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onOrientationChanged</span><span class="params">(orientation: <span class="type">Int</span>)</span></span> &#123; <span class="comment">// Monitors orientation values to determine the target rotation value</span></span><br><span class="line">        <span class="keyword">val</span> rotation = <span class="keyword">when</span> (orientation) &#123;</span><br><span class="line">            <span class="keyword">in</span> <span class="number">45.</span><span class="number">.134</span> -&gt; Surface.ROTATION_270</span><br><span class="line">            <span class="keyword">in</span> <span class="number">135.</span><span class="number">.224</span> -&gt; Surface.ROTATION_180</span><br><span class="line">            <span class="keyword">in</span> <span class="number">225.</span><span class="number">.314</span> -&gt; Surface.ROTATION_90</span><br><span class="line">            <span class="keyword">else</span> -&gt; Surface.ROTATION_0</span><br><span class="line">        &#125;</span><br><span class="line">        imageCapture.targetRotation = rotation</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在bindPreview()方法内启用<br><code>orientationEventListener?.enable()</code></p>
<p>及时暂停</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onPause</span><span class="params">()</span></span> &#123;</span><br><span class="line">    orientationEventListener?.disable()</span><br><span class="line">    <span class="keyword">super</span>.onPause()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>bindToLifecycle</code>内加入<code>UseCase</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">camera = cameraProvider.bindToLifecycle(viewLifecycleOwner, cameraSelector, preview, imageCapture)</span><br></pre></td></tr></table></figure>

<p>拍照</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 拍照</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressLint(<span class="string">&quot;RestrictedApi&quot;</span>)</span></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">takePicture</span><span class="params">(save: (<span class="type">uri</span>: <span class="type">Uri</span>?) -&gt; <span class="type">Unit</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 存储照片的路径</span></span><br><span class="line">    <span class="keyword">val</span> dir = File(ConfigConstant.PATH)</span><br><span class="line">    <span class="keyword">if</span> (!dir.exists()) dir.mkdirs()</span><br><span class="line">    <span class="keyword">val</span> srcFile = File(dir, ConfigConstant.BITMAP_NAME)</span><br><span class="line">    <span class="keyword">val</span> outputFileOptions = ImageCapture.OutputFileOptions.Builder(srcFile).build()</span><br><span class="line">    imageCapture.takePicture(outputFileOptions, cameraExecutor, <span class="keyword">object</span> : ImageCapture.OnImageSavedCallback &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onImageSaved</span><span class="params">(outputFileResults: <span class="type">ImageCapture</span>.<span class="type">OutputFileResults</span>)</span></span> &#123;</span><br><span class="line">            save(outputFileResults?.savedUri)</span><br><span class="line">            <span class="comment">// outputFileResults可以拿到图片的Uri</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onError</span><span class="params">(exception: <span class="type">ImageCaptureException</span>)</span></span> &#123;</span><br><span class="line">            save(<span class="literal">null</span>)</span><br><span class="line">            toast(<span class="string">&quot;拍照异常&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到这里基本上就能实现正常的拍摄，再来介绍一些小功能吧</p>
<h2 id="部分功能"><a href="#部分功能" class="headerlink" title="部分功能"></a>部分功能</h2><h3 id="切换摄像头"><a href="#切换摄像头" class="headerlink" title="切换摄像头"></a>切换摄像头</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 切换摄像头</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">switchCamera</span><span class="params">()</span></span> &#123;</span><br><span class="line">    orientationEventListener?.disable()</span><br><span class="line">    lensFacing = <span class="keyword">if</span> (CameraSelector.LENS_FACING_FRONT == lensFacing) &#123;</span><br><span class="line">        CameraSelector.LENS_FACING_BACK</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        CameraSelector.LENS_FACING_FRONT</span><br><span class="line">    &#125;</span><br><span class="line">    bindPreview(cameraProvider ?: <span class="keyword">return</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="手电筒"><a href="#手电筒" class="headerlink" title="手电筒"></a>手电筒</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 切换手电筒,可能打开失败</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">flashlight</span><span class="params">()</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">    camera?.let &#123;</span><br><span class="line">        <span class="keyword">val</span> mode = <span class="keyword">if</span> (imageCapture.flashMode == ImageCapture.FLASH_MODE_OFF) ImageCapture.FLASH_MODE_ON</span><br><span class="line">        <span class="keyword">else</span> ImageCapture.FLASH_MODE_OFF</span><br><span class="line">        imageCapture.flashMode = mode</span><br><span class="line">        <span class="keyword">return</span> imageCapture.flashMode == ImageCapture.FLASH_MODE_ON</span><br><span class="line">    &#125; ?: toast(<span class="string">&quot;闪光灯开启失败,请检查相机能否正常使用&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="曝光补偿"><a href="#曝光补偿" class="headerlink" title="曝光补偿"></a>曝光补偿</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 设置曝光补偿, 可能设置失败</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">setExposureCompensationIndex</span><span class="params">(value: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    camera?.let &#123; camera -&gt;</span><br><span class="line">        <span class="keyword">val</span> cameraInfo = camera.cameraInfo</span><br><span class="line">        <span class="keyword">if</span> (cameraInfo.exposureState.exposureCompensationRange.upper == <span class="number">0</span> &amp;&amp; cameraInfo.exposureState.exposureCompensationRange.lower == <span class="number">0</span>) &#123;</span><br><span class="line">            toast(<span class="string">&quot;当前设备不支持设置曝光补偿&quot;</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cameraInfo.exposureState.exposureCompensationRange.contains(value)) &#123;</span><br><span class="line">            <span class="keyword">val</span> index = (value / camera.cameraInfo.exposureState.exposureCompensationStep.toFloat()).roundToInt()</span><br><span class="line">            camera.cameraControl.setExposureCompensationIndex(index)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; ?: toast(<span class="string">&quot;设置曝光补偿失败,请检查相机能否正常使用&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面的内容来源于<a target="_blank" rel="noopener" href="https://developer.android.google.cn/training/camerax">Android官网文档</a></p>
<h2 id="PreviewView-的其他API"><a href="#PreviewView-的其他API" class="headerlink" title="PreviewView 的其他API"></a>PreviewView 的其他API</h2><p>CameraX <code>PreviewView</code> 提供了一些其他 API 来用于配置属性，例如：</p>
<ul>
<li>用于渲染预览流的<a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/view/PreviewView.ImplementationMode?hl=zh-cn">实现模式</a>。</li>
<li>预览图片的<a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/view/PreviewView.ScaleType?hl=zh-cn">缩放类型</a>。</li>
</ul>
<h3 id="实现模式"><a href="#实现模式" class="headerlink" title="实现模式"></a>实现模式</h3><p><code>PreviewView</code> 可以使用以下模式之一将预览流渲染到目标 <code>View</code> 上：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/view/PreviewView.ImplementationMode?hl=zh-cn#PERFORMANCE"><code>PERFORMANCE</code></a> 是默认模式。<code>PreviewView</code> 会使用 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/android/view/SurfaceView?hl=zh-cn"><code>SurfaceView</code></a> 显示视频串流，但在<a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/view/PreviewView.ImplementationMode?hl=zh-cn#PERFORMANCE">某些情况下</a>会回退为使用 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/android/view/TextureView?hl=zh-cn"><code>TextureView</code></a>。<code>SurfaceView</code> 具有专用的绘图界面，该对象更有可能通过<a target="_blank" rel="noopener" href="https://source.android.google.cn/devices/graphics/hwc?hl=zh-cn">内部硬件合成器</a>实现硬件叠加层，尤其是当预览视频上面没有其他界面元素（如按钮）时。通过使用硬件叠加层进行渲染，视频帧会避开 GPU 路径，从而能降低平台功耗并缩短延迟时间。</li>
<li><a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/view/PreviewView.ImplementationMode?hl=zh-cn#COMPATIBLE"><code>COMPATIBLE</code></a> 模式。在此模式下，<code>PreviewView</code> 会使用 <code>TextureView</code>；不同于 <code>SurfaceView</code>，该对象没有专用的绘图表面。因此，视频要通过混合渲染，才能显示。在这个额外的步骤中，应用可以执行额外的处理工作，例如不受限制地缩放和旋转视频。</li>
</ul>
<p>您可以使用 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/view/PreviewView?hl=zh-cn#setImplementationMode(androidx.camera.view.PreviewView.ImplementationMode)"><code>PreviewView.setImplementationMode()</code></a> 选择适合具体应用的实现模式。如果默认的 <code>PERFORMANCE</code> 模式不适合您的应用，请参阅以下代码示例，了解如何设置 <code>COMPATIBLE</code> 模式：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// viewFinder 是一个 PreviewView 实例</span></span><br><span class="line">viewFinder.implementationMode = PreviewView.ImplementationMode.COMPATIBLE</span><br></pre></td></tr></table></figure>

<h3 id="缩放类型"><a href="#缩放类型" class="headerlink" title="缩放类型"></a>缩放类型</h3><p>当预览视频分辨率与目标 <code>PreviewView</code> 的尺寸不同时，视频内容需要通过剪裁操作或添加遮幅式黑边来适应视图（保持原始宽高比）。为此，<code>PreviewView</code> 提供了以下 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/view/PreviewView.ScaleType?hl=zh-cn"><code>ScaleTypes</code></a>：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/view/PreviewView.ScaleType?hl=zh-cn#FIT_CENTER"><code>FIT_CENTER</code></a>、<a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/view/PreviewView.ScaleType?hl=zh-cn#FIT_START"><code>FIT_START</code></a> 和 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/view/PreviewView.ScaleType?hl=zh-cn#FIT_END"><code>FIT_END</code></a>，用于添加遮幅式黑边。整个视频内容会调整（放大或缩小）为可在目标 <code>PreviewView</code> 中显示的最大尺寸。不过，虽然整个视频帧会完整显示，但屏幕画面中可能会出现空白部分。视频帧会与目标视图的中心、起始或结束位置对齐，具体取决于您在上述三种缩放类型中选择了哪一种。</li>
<li><a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/view/PreviewView.ScaleType?hl=zh-cn#FILL_CENTER"><code>FILL_CENTER</code></a>、<a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/view/PreviewView.ScaleType?hl=zh-cn#FILL_START"><code>FILL_START</code></a> 和 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/view/PreviewView.ScaleType?hl=zh-cn#FILL_END"><code>FILL_END</code></a>，用于进行剪裁。如果视频的宽高比与 <code>PreviewView</code> 不匹配，画面中只会显示部分内容，但视频仍会填满整个 <code>PreviewView</code>。</li>
</ul>
<p>CameraX 使用的默认缩放类型是 <code>FILL_CENTER</code>。您可以使用 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/view/PreviewView?hl=zh-cn#setScaleType(androidx.camera.view.PreviewView.ScaleType)"><code>PreviewView.setScaleType()</code></a> 设置最适合具体应用的缩放类型。下面的代码示例设置了 <code>FIT_CENTER</code> 缩放类型：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// viewFinder 是一个 PreviewView 实例</span></span><br><span class="line">viewFinder.scaleType = PreviewView.ScaleType.FIT_CENTER</span><br></pre></td></tr></table></figure>

<p>视频显示过程包括以下步骤：</p>
<ol>
<li>缩放视频：<ul>
<li>如果您选择的缩放类型是 <code>FIT_*</code>，请使用 <code>min(dst.width/src.width, dst.height/src.height)</code> 缩放视频。</li>
<li>如果您选择的缩放类型是 <code>FILL_*</code>，请使用 <code>max(dst.width/src.width, dst.height/src.height)</code> 缩放视频。</li>
</ul>
</li>
<li>将经过缩放的视频与目标PreviewView对齐：<ul>
<li>对于 <code>FIT_CENTER/FILL_CENTER</code>，请将经过缩放的视频与目标 <code>PreviewView</code> 居中对齐。</li>
<li>对于 <code>FIT_START/FILL_START</code>，请以每个视频的左上角为准，将经过缩放的视频与目标 <code>PreviewView</code> 对齐。</li>
<li>对于 <code>FIT_END/FILL_END</code>，请以每个视频的右下角为准，将经过缩放的视频与目标 <code>PreviewView</code> 对齐。</li>
</ul>
</li>
</ol>
<h2 id="配置选项"><a href="#配置选项" class="headerlink" title="配置选项"></a>配置选项</h2><p>您可以配置每个 CameraX 用例，以控制用例操作的不同方面。</p>
<p>例如，对于图片拍摄用例，您可以设置目标宽高比和闪光灯模式。以下代码显示了一个示例：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> imageCapture = ImageCapture.Builder()</span><br><span class="line">    .setFlashMode(...)</span><br><span class="line">    .setTargetAspectRatio(...)</span><br><span class="line">    .build()</span><br></pre></td></tr></table></figure>

<p>除配置选项之外，一些用例会公开 API 以便在创建后动态更改设置。如需了解各个用例的专属配置，请参阅<a target="_blank" rel="noopener" href="https://developer.android.google.cn/training/camerax/preview?hl=zh-cn">实现预览</a>、<a target="_blank" rel="noopener" href="https://developer.android.google.cn/training/camerax/analyze?hl=zh-cn">分析图片</a>和<a target="_blank" rel="noopener" href="https://developer.android.google.cn/training/camerax/take-photo?hl=zh-cn">图片拍摄</a>。</p>
<h3 id="CameraXConfig"><a href="#CameraXConfig" class="headerlink" title="CameraXConfig"></a>CameraXConfig</h3><p>为简单起见，CameraX 具有适合大多数使用场景的默认配置（例如内部执行器和处理程序）。但是，如果您的应用有特殊要求或希望自定义这些配置，可使用 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/CameraXConfig?hl=zh-cn"><code>CameraXConfig</code></a> 接口实现此目的。</p>
<p>借助 <code>CameraXConfig</code>，应用可以执行以下操作：</p>
<ul>
<li>使用 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/CameraXConfig.Builder?hl=zh-cn#setAvailableCamerasLimiter(androidx.camera.core.CameraSelector)"><code>setAvailableCameraLimiter()</code></a> 优化启动延迟时间。</li>
<li>使用 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/CameraXConfig.Builder?hl=zh-cn#setCameraExecutor(java.util.concurrent.Executor)"><code>setCameraExecutor()</code></a> 向 CameraX 提供应用执行器。</li>
<li>将默认调度器处理程序替换为 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/CameraXConfig.Builder?hl=zh-cn#setSchedulerHandler(android.os.Handler)"><code>setSchedulerHandler()</code></a>。</li>
<li>使用 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/CameraXConfig.Builder?hl=zh-cn#setMinimumLoggingLevel(int)"><code>setMinimumLoggingLevel()</code></a> 更改日志记录级别。</li>
</ul>
<h4 id="使用模式"><a href="#使用模式" class="headerlink" title="使用模式"></a>使用模式</h4><p>以下程序说明了如何使用 <code>CameraXConfig</code>：</p>
<ol>
<li>使用您的自定义配置创建一个 <code>CameraXConfig</code> 对象。</li>
<li>在 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/android/app/Application?hl=zh-cn"><code>Application</code></a> 中实现 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/CameraXConfig.Provider?hl=zh-cn"><code>CameraXConfig.Provider</code></a> 接口，并在 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/CameraXConfig.Provider?hl=zh-cn#getCameraXConfig()"><code>getCameraXConfig()</code></a> 中返回 <code>CameraXConfig</code> 对象。</li>
<li>按照<a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/android/app/Application?hl=zh-cn">此处</a>的说明，将您的 <code>Application</code> 类添加到 <code>AndroidManifest.xml</code> 文件中。</li>
</ol>
<p>例如，以下代码示例将 CameraX 日志记录限制为仅记录错误消息：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CameraApplication</span> : <span class="type">Application</span>(), CameraXConfig.Provider &#123;</span><br><span class="line">   <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getCameraXConfig</span><span class="params">()</span></span>: CameraXConfig &#123;</span><br><span class="line">       <span class="keyword">return</span> CameraXConfig.Builder.fromConfig(Camera2Config.defaultConfig())</span><br><span class="line">           .setMinimumLoggingLevel(Log.ERROR).build()</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果您的应用需要在设置 CameraX 配置后了解该配置，请保留 <code>CameraXConfig</code> 对象的本地副本。</p>
<h4 id="摄像头限制器"><a href="#摄像头限制器" class="headerlink" title="摄像头限制器"></a>摄像头限制器</h4><p>在第一次调用 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/lifecycle/ProcessCameraProvider?hl=zh-cn#getInstance(android.content.Context)"><code>ProcessCameraProvider.getInstance()</code></a> 期间，CameraX 会枚举和查询设备上可用摄像头的特性。由于 CameraX 需要与硬件组件通信，因此对每个摄像头执行此过程可能需要较长时间，尤其是在低端设备上。如果您的应用仅使用设备上的特定摄像头（例如默认前置摄像头），您可以将 CameraX 设置为忽略其他摄像头，从而缩短应用所用摄像头的启动延迟时间。</p>
<p>如果传递给 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/CameraXConfig.Builder?hl=zh-cn#setAvailableCamerasLimiter(androidx.camera.core.CameraSelector)"><code>CameraXConfig.Builder.setAvailableCamerasLimiter()</code></a> 的 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/CameraSelector?hl=zh-cn"><code>CameraSelector</code></a> 过滤掉了某个摄像头，则 CameraX 在运行时会假定该摄像头不存在。例如，以下代码会限制应用只能使用设备的默认后置摄像头：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MainApplication</span> : <span class="type">Application</span>(), CameraXConfig.Provider &#123;</span><br><span class="line">   <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getCameraXConfig</span><span class="params">()</span></span>: CameraXConfig &#123;</span><br><span class="line">       <span class="keyword">return</span> CameraXConfig.Builder.fromConfig(Camera2Config.defaultConfig())</span><br><span class="line">              .setAvailableCamerasLimiter(CameraSelector.DEFAULT_BACK_CAMERA)</span><br><span class="line">              .build()</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h4><p>构建 CameraX 时所采用的很多平台 API 都要求阻塞与硬件之间的进程间通信 (IPC)，此类通信有时可能需要数百毫秒的响应时间。因此，CameraX 仅从后台线程调用这些 API，从而避免主线程发生阻塞，使界面保持流畅。CameraX 会在内部管理这些后台线程，因此这类行为显得比较透明。但是，某些应用需要严格控制线程。<code>CameraXConfig</code> 允许应用设置通过 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/CameraXConfig.Builder?hl=zh-cn#setCameraExecutor(java.util.concurrent.Executor)"><code>CameraXConfig.Builder.setCameraExecutor()</code></a> 和 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/CameraXConfig.Builder?hl=zh-cn#setSchedulerHandler(android.os.Handler)"><code>CameraXConfig.Builder.setSchedulerHandler()</code></a> 使用的后台线程。</p>
<p><strong>注意</strong>：提供自定义执行器或调度器处理程序时，请使用不会在主线程上执行代码的处理程序。</p>
<h4 id="摄像头执行器"><a href="#摄像头执行器" class="headerlink" title="摄像头执行器"></a>摄像头执行器</h4><p>摄像头执行器用于所有内部摄像头平台 API 调用，以及来自这些 API 的回调。CameraX 会分配和管理内部 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/java/util/concurrent/Executor?hl=zh-cn"><code>Executor</code></a> 来执行这些任务。 但是，如果您的应用需要更严格的线程控制，请使用 <code>CameraXConfig.Builder.setCameraExecutor()</code>。</p>
<h4 id="调度器处理程序"><a href="#调度器处理程序" class="headerlink" title="调度器处理程序"></a>调度器处理程序</h4><p>调度器处理程序用于按固定的时间间隔调度内部任务，例如在摄像头不可用时再次尝试打开该摄像头。该处理程序不执行作业，而是仅将作业分派给摄像头执行器。有时，该处理程序还用于需要使用 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/android/os/Handler?hl=zh-cn"><code>Handler</code></a> 进行回调的旧版 API 平台。在这些情况下，回调仍仅直接分派给摄像头执行器。CameraX 会分配和管理内部 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/android/os/HandlerThread?hl=zh-cn"><code>HandlerThread</code></a> 来执行这些任务，但您可以将其替换为 <code>CameraXConfig.Builder.setSchedulerHandler()</code>。</p>
<h4 id="日志记录"><a href="#日志记录" class="headerlink" title="日志记录"></a>日志记录</h4><p>借助 CameraX 日志记录，应用可以过滤 logcat 消息，因为在正式版代码中应尽量避免包含详细消息。CameraX 支持四种日志记录级别（从最详细到最严重）：</p>
<ul>
<li><code>Log.DEBUG</code>（默认）</li>
<li><code>Log.INFO</code></li>
<li><code>Log.WARN</code></li>
<li><code>Log.ERROR</code></li>
</ul>
<p>如需详细了解这些日志级别，请参阅 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/android/util/Log?hl=zh-cn#DEBUG">Android 日志文档</a>。您可以使用 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/CameraXConfig.Builder?hl=zh-cn#setMinimumLoggingLevel(int)"><code>CameraXConfig.Builder.setMinimumLoggingLevel(int)</code></a> 为您的应用设置适当的日志记录级别。</p>
<h3 id="自动选择"><a href="#自动选择" class="headerlink" title="自动选择"></a>自动选择</h3><p>CameraX 会根据运行您的应用的设备自动提供专用的功能。例如，如果您未指定分辨率或您指定的分辨率不受支持，CameraX 会自动确定要使用的最佳分辨率。所有这些操作均由库进行处理，无需您编写设备专属代码。</p>
<p>CameraX 的目标是成功初始化摄像头会话。这意味着，CameraX 会根据设备功能降低分辨率和宽高比。发生这种情况的原因如下：</p>
<ul>
<li>设备不支持请求的分辨率。</li>
<li>设备存在兼容性问题，例如需要特定分辨率才能正常运行的旧设备。</li>
<li>在某些设备上，某些格式仅在某些宽高比下可用。</li>
<li>对于 JPEG 或视频编码，设备首选“最近的 mod16”。如需了解详情，请参阅 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/android/hardware/camera2/CameraCharacteristics?hl=zh-cn#SCALER_STREAM_CONFIGURATION_MAP"><code>SCALER_STREAM_CONFIGURATION_MAP</code></a>。</li>
</ul>
<p>尽管 CameraX 会创建并管理会话，您也应始终在代码中检查用例输出所返回的图片大小，并进行相应调整。</p>
<h3 id="旋转"><a href="#旋转" class="headerlink" title="旋转"></a>旋转</h3><p>默认情况下，在用例创建期间，摄像头的旋转角度会设置为与默认的显示屏旋转角度保持一致。在此默认情况下，CameraX 会生成输出，确保应用与您预期在预览中看到的内容保持一致。通过在配置用例对象时传入当前显示屏方向或在创建用例对象之后动态传入显示屏方向，您可以将旋转角度更改为自定义值以支持多显示屏设备。</p>
<p>您的应用可以使用配置设置来设置目标旋转角度。然后，即使生命周期处于运行状态，应用也可以通过使用用例 API 中的方法（例如 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis?hl=zh-cn#setTargetRotation(int)"><code>ImageAnalysis.setTargetRotation()</code></a>）更新旋转设置。您可以在应用锁定为纵向模式时执行上述操作，这样就无需重新配置旋转角度，但是照片或分析用例需要了解设备当前的旋转角度。例如，用例可能需要了解旋转角度才能以正确的方向进行人脸检测，或者将照片设置为横向或纵向。</p>
<p>存储所拍摄图片的数据时可能不会包含旋转信息。Exif 数据包含旋转信息，以便图库应用在保存后以正确的屏幕方向显示图片。</p>
<p>如需以正确的屏幕方向显示预览数据，您可以使用 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/Preview.PreviewOutput?hl=zh-cn"><code>Preview.PreviewOutput()</code></a> 的元数据输出创建转换。</p>
<p>以下代码示例展示了如何为屏幕方向事件设置旋转角度：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> imageCapture = ImageCapture.Builder().build()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> orientationEventListener = <span class="keyword">object</span> : OrientationEventListener(<span class="keyword">this</span> <span class="keyword">as</span> Context) &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onOrientationChanged</span><span class="params">(orientation : <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">            <span class="comment">// Monitors orientation values to determine the target rotation value</span></span><br><span class="line">            <span class="keyword">val</span> rotation : <span class="built_in">Int</span> = <span class="keyword">when</span> (orientation) &#123;</span><br><span class="line">                <span class="keyword">in</span> <span class="number">45.</span><span class="number">.134</span> -&gt; Surface.ROTATION_270</span><br><span class="line">                <span class="keyword">in</span> <span class="number">135.</span><span class="number">.224</span> -&gt; Surface.ROTATION_180</span><br><span class="line">                <span class="keyword">in</span> <span class="number">225.</span><span class="number">.314</span> -&gt; Surface.ROTATION_90</span><br><span class="line">                <span class="keyword">else</span> -&gt; Surface.ROTATION_0</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            imageCapture.targetRotation = rotation</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    orientationEventListener.enable()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每个用例都会根据设定的旋转角度直接旋转图片数据，或者向用户提供未旋转图片数据的旋转元数据。</p>
<ul>
<li><strong>Preview</strong>：提供元数据输出，以便使用 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/Preview?hl=zh-cn#getTargetRotation()"><code>Preview.getTargetRotation()</code></a> 了解目标分辨率的旋转设置。</li>
<li><strong>ImageAnalysis</strong>：提供元数据输出，以便了解图片缓冲区坐标相对于显示坐标的位置。</li>
<li><strong>ImageCapture</strong>：更改图片 Exif 元数据、缓冲区或同时更改两者，从而反映旋转设置。更改的值取决于 HAL 实现。</li>
</ul>
<h3 id="剪裁矩形"><a href="#剪裁矩形" class="headerlink" title="剪裁矩形"></a>剪裁矩形</h3><p>默认情况下，剪裁矩形是完整的缓冲区矩形，您可通过 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/ViewPort?hl=zh-cn"><code>ViewPort</code></a> 和 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/UseCaseGroup?hl=zh-cn"><code>UseCaseGroup</code></a> 对其进行自定义。通过对用例进行分组并设置视口，CameraX 可保证一个组中的所有用例的剪裁矩形都指向摄像头传感器中的同一个区域。</p>
<p>以下代码段展示了这两个类的使用方法：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> viewPort =  ViewPort.Builder(Rational(width, height), display.rotation).build()</span><br><span class="line"><span class="keyword">val</span> useCaseGroup = UseCaseGroup.Builder()</span><br><span class="line">    .addUseCase(preview)</span><br><span class="line">    .addUseCase(imageAnalysis)</span><br><span class="line">    .addUseCase(imageCapture)</span><br><span class="line">    .setViewPort(viewPort)</span><br><span class="line">    .build()</span><br><span class="line">cameraProvider.bindToLifecycle(lifecycleOwner, cameraSelector, useCaseGroup)</span><br></pre></td></tr></table></figure>

<p><code>ViewPort</code> 用于指定最终用户可看到的缓冲区矩形。CameraX 会根据视口的属性及附加的用例计算出可能的最大剪裁矩形。一般情况下，为了达到 WYSIWYG 效果，您应根据预览用例来配置视口。获取视口的一种简单方法是使用 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/training/camerax/preview?hl=zh-cn#implementation"><code>PreviewView</code></a>。</p>
<p>以下代码段展示了如何获取 <code>ViewPort</code> 对象：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> viewport = findViewById&lt;PreviewView&gt;(R.id.preview_view).viewPort</span><br></pre></td></tr></table></figure>

<p>在前面的示例中，应用通过 <code>ImageAnalysis</code> 和 <code>ImageCapture</code> 获取的内容与最终用户在 <code>PreviewView</code> 中看到的内容相同（假定 <code>PreviewView</code> 的缩放类型设为默认值 <code>FILL_CENTER</code>）。将剪裁矩形和旋转角度应用到输出缓冲区后，图片将在所有用例中保持一致，但分辨率可能会有所不同。如需详细了解如何应用转换信息，请参阅<a target="_blank" rel="noopener" href="https://developer.android.google.cn/training/camerax/transform-output?hl=zh-cn">转换输出</a>。</p>
<h3 id="摄像头分辨率"><a href="#摄像头分辨率" class="headerlink" title="摄像头分辨率"></a>摄像头分辨率</h3><p>您可以选择让 CameraX 根据设备功能、设备支持的<a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/android/hardware/camera2/CameraCharacteristics?hl=zh-cn#INFO_SUPPORTED_HARDWARE_LEVEL">硬件级别</a>、用例和所提供的宽高比组合设置图片分辨率。或者，您也可以在支持相应配置的用例中设置特定目标分辨率或特定宽高比。</p>
<h4 id="自动分辨率"><a href="#自动分辨率" class="headerlink" title="自动分辨率"></a>自动分辨率</h4><p>CameraX 可以根据 <code>cameraProcessProvider.bindToLifecycle()</code> 中指定的用例自动确定最佳分辨率设置。请尽可能在单个 <code>bindToLifecycle()</code> 调用的单个会话中指定需要同时运行的所有用例。CameraX 会考虑设备支持的硬件级别以及设备专属变化（设备超出或不满足<a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/android/hardware/camera2/CameraDevice?hl=zh-cn#createCaptureSession(android.hardware.camera2.params.SessionConfiguration)">可用的信息流配置</a>），根据绑定的成组用例确定分辨率。 这样做是为了确保应用在各种设备上运行时，能够最大限度地减少设备专属代码路径。</p>
<p>图片拍摄和图片分析用例的默认宽高比为 4:3。</p>
<p>对于具有可配置宽高比的用例，可让应用根据界面设计来指定所需的宽高比。CameraX 会按照请求的宽高比生成输出，并尽可能匹配设备支持的宽高比。如果没有任何支持的完全匹配分辨率，则选择满足最多条件的分辨率。也就是说，应用会决定摄像头在应用中的显示方式，CameraX 则会决定最佳摄像头分辨率设置，以满足不同设备的具体要求。</p>
<p>例如，应用可以执行以下任一操作：</p>
<ul>
<li>为用例指定 4:3 或 16:9 的目标分辨率</li>
<li>指定自定义分辨率，CameraX 会尝试查找与该分辨率最接近的分辨率</li>
<li>为 <code>ImageCapture</code> 指定剪裁宽高比</li>
</ul>
<p>CameraX 会自动选择内部 Camera2 界面的分辨率。下表显示了这些分辨率：</p>
<table>
<thead>
<tr>
<th align="left"><strong>用例</strong></th>
<th align="left"><strong>内部界面分辨率</strong></th>
<th align="left"><strong>输出数据分辨率</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">预览</td>
<td align="left"><strong>宽高比</strong>：使目标与设置最相符的分辨率。</td>
<td align="left">内部界面分辨率。通过提供元数据，可让视图针对目标宽高比进行剪裁、缩放和旋转。</td>
</tr>
<tr>
<td align="left"><strong>默认分辨率：</strong>最高的预览分辨率，或与预览宽高比匹配的最高设备首选分辨率。</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left"><strong>最大分辨率：</strong>预览大小，指的是与设备的屏幕分辨率或 1080p (1920x1080)（以较低者为准）匹配的最佳尺寸。</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">图片分析</td>
<td align="left"><strong>宽高比</strong>：使目标与设置最相符的分辨率。</td>
<td align="left">内部界面分辨率。</td>
</tr>
<tr>
<td align="left"><strong>默认分辨率</strong>：默认目标分辨率设置为 640x480。同时调整目标分辨率和相应的宽高比可获得支持的最佳分辨率。</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left"><strong>最大分辨率</strong>：从 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/android/hardware/camera2/params/StreamConfigurationMap?hl=zh-cn#getOutputSizes(int)"><code>StreamConfigurationMap.getOutputSizes()</code></a> 中检索到的 YUV_420_888 格式的摄像头设备最大输出分辨率。 目标分辨率默认设置为 640x480。因此，如果您希望分辨率大于 640x480，必须使用 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/kotlin/androidx/camera/core/ImageAnalysis.Builder?hl=zh-cn#settargetresolution"><code>setTargetResolution()</code></a> 和 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/kotlin/androidx/camera/core/ImageAnalysis.Builder?hl=zh-cn#settargetaspectratio"><code>setTargetAspectRatio()</code></a> 从支持的分辨率中选择最接近的一个。</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">图片拍摄</td>
<td align="left"><strong>宽高比</strong>：最适合设置的宽高比。</td>
<td align="left">内部界面分辨率。</td>
</tr>
<tr>
<td align="left"><strong>默认分辨率</strong>：最高可用分辨率，或与 ImageCapture 的宽高比匹配的最高设备首选分辨率。</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left"><strong>最大分辨率</strong>：JPEG 格式的摄像头设备最大输出分辨率。请使用 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/android/hardware/camera2/params/StreamConfigurationMap?hl=zh-cn#getOutputSizes(int)"><code>StreamConfigurationMap.getOutputSizes()</code></a> 检索此分辨率。</td>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody></table>
<h4 id="指定分辨率"><a href="#指定分辨率" class="headerlink" title="指定分辨率"></a>指定分辨率</h4><p>使用 <code>setTargetResolution(Size resolution)</code> 方法构建用例时，您可以设置特定分辨率，如以下代码示例所示：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> imageAnalysis = ImageAnalysis.Builder()</span><br><span class="line">    .setTargetResolution(Size(<span class="number">1280</span>, <span class="number">720</span>))</span><br><span class="line">    .build()</span><br></pre></td></tr></table></figure>

<p>您无法针对同一个用例设置目标宽高比和目标分辨率。如果这样做，则会在构建配置对象时抛出 <code>IllegalArgumentException</code>。</p>
<p>按照目标旋转角度旋转支持的大小后，请在坐标系中表示分辨率 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/android/util/Size?hl=zh-cn"><code>Size</code></a>。例如，自然屏幕方向为纵向并采用自然目标旋转角度的设备如果请求纵向图片，可指定 480x640；而同一设备旋转 90 度并以横向屏幕方向为目标后，可指定 640x480。</p>
<p>目标分辨率会尝试制定图片分辨率的下限。实际的图片分辨率是最接近的可用分辨率，其大小不小于由摄像头实现所决定的目标分辨率。</p>
<p>但是，如果不存在等于或大于目标分辨率的分辨率，就会从小于目标分辨率的可用分辨率中选择最接近的一个。与提供的 <code>Size</code> 具有相同宽高比的分辨率，其优先级高于具有不同宽高比的分辨率。</p>
<p>CameraX 会根据请求应用最合适的分辨率。如果主要需求是满足宽高比要求，则仅指定 <code>setTargetAspectRatio</code>，CameraX 会根据设备确定合适的特定分辨率。 如果应用的主要需求是指定分辨率以提高图片处理效率（例如根据设备处理能力处理较小或中等大小的图片），请使用 <code>setTargetResolution(Size resolution)</code>。</p>
<p><strong>注意：</strong>如果使用 <code>setTargetResolution()</code>，可能会得到宽高比与其他用例不匹配的缓冲区。如果宽高比必须匹配，请检查两个用例返回的缓冲区尺寸，然后剪裁或缩放其中一个以与另一个匹配。</p>
<p>如果您的应用需要精确的分辨率，请参阅 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/android/hardware/camera2/CameraDevice?hl=zh-cn#regular-capture"><code>createCaptureSession()</code></a> 内的表格，以确定每个硬件级别支持的最大分辨率。如需查看当前设备支持的特定分辨率，请参阅 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/android/hardware/camera2/params/StreamConfigurationMap?hl=zh-cn#getOutputSizes(int)"><code>StreamConfigurationMap.getOutputSizes(int)</code></a>。</p>
<p>如果您的应用在 Android 10 或更高版本上运行，您可以使用 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/android/hardware/camera2/CameraDevice?hl=zh-cn#isSessionConfigurationSupported(android.hardware.camera2.params.SessionConfiguration)"><code>isSessionConfigurationSupported()</code></a> 验证特定的 <code>SessionConfiguration</code>。</p>
<h3 id="控制摄像头输出"><a href="#控制摄像头输出" class="headerlink" title="控制摄像头输出"></a>控制摄像头输出</h3><p>CameraX 不仅让您可以视需要为每个单独的用例配置摄像头输出，还实现了以下接口，从而支持所有绑定用例中通用的摄像头操作：</p>
<ul>
<li>利用 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/CameraControl?hl=zh-cn"><code>CameraControl</code></a>，您可以配置通用摄像头功能。</li>
<li>利用 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/CameraInfo?hl=zh-cn"><code>CameraInfo</code></a>，您可以查询这些通用摄像头功能的状态。</li>
</ul>
<p>以下是 CameraControl 支持的摄像头功能：</p>
<ul>
<li>变焦</li>
<li>手电筒</li>
<li>对焦和测光（点按即可对焦）</li>
<li>曝光补偿</li>
</ul>
<h4 id="获取-CameraControl-和-CameraInfo-的实例"><a href="#获取-CameraControl-和-CameraInfo-的实例" class="headerlink" title="获取 CameraControl 和 CameraInfo 的实例"></a>获取 CameraControl 和 CameraInfo 的实例</h4><p>使用 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/lifecycle/ProcessCameraProvider?hl=zh-cn"><code>ProcessCameraProvider.bindToLifecycle()</code></a> 返回的 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/Camera?hl=zh-cn"><code>Camera</code></a> 对象检索 <code>CameraControl</code> 和 <code>CameraInfo</code> 的实例。 以下代码展示了一个示例：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> camera = processCameraProvider.bindToLifecycle(lifecycleOwner, cameraSelector, preview)</span><br><span class="line"></span><br><span class="line"><span class="comment">// For performing operations that affect all outputs.</span></span><br><span class="line"><span class="keyword">val</span> cameraControl = camera.cameraControl</span><br><span class="line"><span class="comment">// For querying information and states.</span></span><br><span class="line"><span class="keyword">val</span> cameraInfo = camera.cameraInfo</span><br></pre></td></tr></table></figure>

<p>例如，您可以在调用 <code>bindToLifecycle()</code> 后提交变焦操作及其他 <code>CameraControl</code> 操作。如果您停止或销毁用于绑定摄像头实例的 activity，<code>CameraControl</code> 无法再执行操作，并且会返回失败的 <code>ListenableFuture</code>。</p>
<p><strong>注意：</strong>如果 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/lifecycle/LifecycleOwner?hl=zh-cn"><code>LifecycleOwner</code></a> 被停止或销毁，<code>Camera</code> 就会关闭，之后变焦、手电筒、对焦和测光以及曝光补偿控件的所有状态更改均会还原成默认值。</p>
<h4 id="对焦和测光"><a href="#对焦和测光" class="headerlink" title="对焦和测光"></a>对焦和测光</h4><p><a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/CameraControl?hl=zh-cn#setExposureCompensationIndex(int)"><code>CameraControl.startFocusAndMetering()</code></a> 可根据指定的 FocusMeteringAction 设置 AF&#x2F;AE&#x2F;AWB 测光区域，以触发自动对焦和曝光测光。有许多摄像头应用通过这种方式实现“点按对焦”功能。</p>
<p><strong>MeteringPoint</strong></p>
<p>首先，使用 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/MeteringPointFactory#createPoint(float,%20float,%20float)"><code>MeteringPointFactory.createPoint(float x, float y, float size)</code></a> 创建 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/MeteringPoint?hl=zh-cn"><code>MeteringPoint</code></a>。 <code>MeteringPoint</code> 表示摄像头 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/android/view/Surface?hl=zh-cn"><code>Surface</code></a> 上的单个点。它以标准化形式存储，所以能轻松转换为传感器坐标，从而用于指定 AF&#x2F;AE&#x2F;AWB 区域。</p>
<p><code>MeteringPoint</code> 的大小介于 0 到 1 之间，默认大小为 0.15f。调用 <code>MeteringPointFactory.createPoint(float x, float y, float size)</code> 时，CameraX 会为提供的 <code>size</code> 创建以 <code>(x, y)</code> 为中心的矩形区域。</p>
<p>下面的代码演示了如何创建 <code>MeteringPoint</code>：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Use PreviewView.getMeteringPointFactory if PreviewView is used for preview.</span></span><br><span class="line">previewView.setOnTouchListener((view, motionEvent) -&gt;  &#123;</span><br><span class="line"><span class="keyword">val</span> meteringPoint = previewView.meteringPointFactory</span><br><span class="line">    .createPoint(motionEvent.x, motionEvent.y)</span><br><span class="line">…</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Use DisplayOrientedMeteringPointFactory if SurfaceView / TextureView is used for</span></span><br><span class="line"><span class="comment">// preview. Please note that if the preview is scaled or cropped in the View,</span></span><br><span class="line"><span class="comment">// it’s the application&#x27;s responsibility to transform the coordinates properly</span></span><br><span class="line"><span class="comment">// so that the width and height of this factory represents the full Preview FOV.</span></span><br><span class="line"><span class="comment">// And the (x,y) passed to create MeteringPoint might need to be adjusted with</span></span><br><span class="line"><span class="comment">// the offsets.</span></span><br><span class="line"><span class="keyword">val</span> meteringPointFactory = DisplayOrientedMeteringPointFactory(</span><br><span class="line">     surfaceView.display,</span><br><span class="line">     camera.cameraInfo,</span><br><span class="line">     surfaceView.width,</span><br><span class="line">     surfaceView.height</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Use SurfaceOrientedMeteringPointFactory if the point is specified in</span></span><br><span class="line"><span class="comment">// ImageAnalysis ImageProxy.</span></span><br><span class="line"><span class="keyword">val</span> meteringPointFactory = SurfaceOrientedMeteringPointFactory(</span><br><span class="line">     imageWidth,</span><br><span class="line">     imageHeight,</span><br><span class="line">     imageAnalysis)</span><br></pre></td></tr></table></figure>

<p><strong>startFocusAndMetering 和 FocusMeteringAction</strong></p>
<p>如需调用 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/CameraControl?hl=zh-cn#startFocusAndMetering(androidx.camera.core.FocusMeteringAction)"><code>startFocusAndMetering()</code></a>，应用必须构建 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/FocusMeteringAction?hl=zh-cn"><code>FocusMeteringAction</code></a>，其中包含一个或多个 <code>MeteringPoints</code>，后者由 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/FocusMeteringAction?hl=zh-cn#FLAG_AF"><code>FLAG_AF</code></a>、<a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/FocusMeteringAction?hl=zh-cn#FLAG_AE"><code>FLAG_AE</code></a>、<a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/FocusMeteringAction?hl=zh-cn#FLAG_AWB"><code>FLAG_AWB</code></a> 这些可选测光模式组合而成。下面的代码演示了这一用法：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> meteringPoint1 = meteringPointFactory.createPoint(x1, x1)</span><br><span class="line"><span class="keyword">val</span> meteringPoint2 = meteringPointFactory.createPoint(x2, y2)</span><br><span class="line"><span class="keyword">val</span> action = FocusMeteringAction.Builder(meteringPoint1) <span class="comment">// default AF|AE|AWB</span></span><br><span class="line">      <span class="comment">// Optionally add meteringPoint2 for AF/AE.</span></span><br><span class="line">      .addPoint(meteringPoint2, FLAG_AF | FLAG_AE)</span><br><span class="line">      <span class="comment">// The action is canceled in 3 seconds (if not set, default is 5s).</span></span><br><span class="line">      .setAutoCancelDuration(<span class="number">3</span>, TimeUnit.SECONDS)</span><br><span class="line">      .build()</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> result = cameraControl.startFocusAndMetering(action)</span><br><span class="line"><span class="comment">// Adds listener to the ListenableFuture if you need to know the focusMetering result.</span></span><br><span class="line">result.addListener(&#123;</span><br><span class="line">   <span class="comment">// result.get().isFocusSuccessful returns if the auto focus is successful or not.</span></span><br><span class="line">&#125;, ContextCompat.getMainExecutor(<span class="keyword">this</span>)</span><br></pre></td></tr></table></figure>

<p>如上面的代码所示，<a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/CameraControl?hl=zh-cn#startFocusAndMetering(androidx.camera.core.FocusMeteringAction)"><code>startFocusAndMetering()</code></a> 接受一个 <code>FocusMeteringAction</code>，后者包含一个用于 AF&#x2F;AE&#x2F;AWB 测光区域的 <code>MeteringPoint</code>，以及另一个仅用于 AF 和 AE 的 MeteringPoint。</p>
<p>在内部，CameraX 会将其转换为 Camera2 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/android/hardware/camera2/params/MeteringRectangle?hl=zh-cn"><code>MeteringRectangles</code></a>，并将相应的 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/android/hardware/camera2/CaptureRequest?hl=zh-cn#CONTROL_AF_REGIONS"><code>CONTROL_AF_REGIONS</code></a>&#x2F;<a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/android/hardware/camera2/CaptureRequest?hl=zh-cn#CONTROL_AE_REGIONS"><code>CONTROL_AE_REGIONS</code></a>&#x2F;<a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/android/hardware/camera2/CaptureRequest?hl=zh-cn#CONTROL_AWB_REGIONS"><code>CONTROL_AWB_REGIONS</code></a> 参数设置为拍摄请求。</p>
<p>由于并非所有设备都支持 AF&#x2F;AE&#x2F;AWB 和多个区域，CameraX 会尽最大努力执行 <code>FocusMeteringAction</code>。CameraX 会使用所支持的最大数量的 MeteringPoint，并按测光点的添加顺序依次使用。对于在超出支持的最大数量之外添加的所有 MeteringPoint，CameraX 会一律忽略。例如，如果您在仅支持 2 个 MeteringPoint 的平台上为 <code>FocusMeteringAction</code> 提供 3 个 MeteringPoint，那么 CameraX 只会使用前 2 个 MeteringPoint，并忽略最后一个 <code>MeteringPoint</code>。</p>
<h2 id="图像分析"><a href="#图像分析" class="headerlink" title="图像分析"></a>图像分析</h2><p><a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis.Analyzer?hl=zh-cn#analyze(androidx.camera.core.ImageProxy)">图像分析</a>用例为您的应用提供可供 CPU 访问的图像，您可以对这些图像执行图像处理、计算机视觉或机器学习推断。应用会实现对每个帧运行的 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis.Analyzer?hl=zh-cn#analyze(androidx.camera.core.ImageProxy)"><code>analyze()</code></a> 方法。</p>
<p>如需了解如何将 Google 的机器学习套件与 CameraX 应用集成，请参阅<a target="_blank" rel="noopener" href="https://developer.android.google.cn/training/camerax/mlkitanalyzer?hl=zh-cn">机器学习套件分析器</a>。</p>
<h3 id="操作模式"><a href="#操作模式" class="headerlink" title="操作模式"></a>操作模式</h3><p>当应用的分析流水线无法满足 CameraX 的帧速率要求时，您可以将 CameraX 配置为通过以下其中一种方式丢帧：</p>
<ul>
<li><strong>非阻塞</strong>（默认）：在该模式下，执行器始终会将最新的图像缓存到图像缓冲区（与深度为 1 的队列相似），与此同时，应用会分析上一个图像。如果 CameraX 在应用完成处理之前收到新图像，则新图像会保存到同一缓冲区，并覆盖上一个图像。 请注意，在这种情况下，<code>ImageAnalysis.Builder.setImageQueueDepth()</code> 不起任何作用，缓冲区内容始终会被覆盖。您可以通过使用 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis?hl=zh-cn#STRATEGY_KEEP_ONLY_LATEST"><code>STRATEGY_KEEP_ONLY_LATEST</code></a> 调用 <code>setBackpressureStrategy()</code> 来启用该非阻塞模式。如需详细了解执行器的相关影响，请参阅 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis?hl=zh-cn#STRATEGY_KEEP_ONLY_LATEST"><code>STRATEGY_KEEP_ONLY_LATEST</code></a> 的参考文档。</li>
<li><strong>阻塞</strong>：在该模式下，内部执行器可以向内部图像队列添加多个图像，并仅在队列已满时才开始丢帧。系统会在整个相机设备上进行屏蔽：如果相机设备具有多个绑定用例，那么在 CameraX 处理这些图像时，系统会屏蔽所有这些用例。例如，如果预览和图像分析都已绑定到某个相机设备，那么在 CameraX 处理图像时，系统也会屏蔽相应预览。您可以通过将 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis?hl=zh-cn#strategy_block_producer"><code>STRATEGY_BLOCK_PRODUCER</code></a> 传递到 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis.Builder?hl=zh-cn#setBackpressureStrategy(int)"><code>setBackpressureStrategy()</code></a> 来启用阻塞模式。此外，您还可以通过使用 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis.Builder?hl=zh-cn#setImageQueueDepth(int)">ImageAnalysis.Builder.setImageQueueDepth()</a> 来配置图像队列深度。</li>
</ul>
<p>如果分析器延迟低且性能高，在这种情况下用于分析图像的总时间低于 CameraX 帧的时长（例如，60fps 用时 16 毫秒），那么上述两种操作模式均可提供顺畅的总体体验。在某些情况下，阻塞模式仍非常有用，例如在处理非常短暂的系统抖动时。</p>
<p>如果分析器延迟高且性能高，则需要结合使用阻塞模式和较长的队列来抵补延迟。但请注意，在这种情况下，应用仍可以处理所有帧。</p>
<p>如果分析器延迟高且耗时长（分析器无法处理所有帧），非阻塞模式可能更为适用，因为在这种情况下，系统必须针对分析路径进行丢帧，但要让其他同时绑定的用例仍能看到所有帧。</p>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>如需在您的应用中使用图像分析，请按以下步骤操作：</p>
<ul>
<li>构建 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis?hl=zh-cn"><code>ImageAnalysis</code></a> 用例。</li>
<li>创建 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis.Analyzer?hl=zh-cn"><code>ImageAnalysis.Analyzer</code></a>。</li>
<li><a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis#setAnalyzer(java.util.concurrent.Executor,%20androidx.camera.core.ImageAnalysis.Analyzer)">将分析器设为</a> <code>ImageAnalysis</code>。</li>
<li>将生命周期所有者、相机选择器和 <code>ImageAnalysis</code> 用例<a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/lifecycle/ProcessCameraProvider#bindToLifecycle(androidx.lifecycle.LifecycleOwner,%20androidx.camera.core.CameraSelector,%20androidx.camera.core.UseCase...)">绑定</a>到生命周期。</li>
</ul>
<p>绑定后，CameraX 会立即将图像发送到已注册的分析器。 完成分析后，调用 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis?hl=zh-cn#clearAnalyzer()"><code>ImageAnalysis.clearAnalyzer()</code></a> 或解除绑定 <code>ImageAnalysis</code> 用例以停止分析。</p>
<h4 id="构建-ImageAnalysis-用例"><a href="#构建-ImageAnalysis-用例" class="headerlink" title="构建 ImageAnalysis 用例"></a>构建 ImageAnalysis 用例</h4><p><a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis?hl=zh-cn"><code>ImageAnalysis</code></a> 可将分析器（图像使用方）连接到 CameraX（图像生成方）。应用可以使用 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis.Builder?hl=zh-cn"><code>ImageAnalysis.Builder</code></a> 来构建 <code>ImageAnalysis</code> 对象。借助 <code>ImageAnalysis.Builder</code>，应用可以进行以下配置：</p>
<ul>
<li>图像输出参数：<ul>
<li>格式：CameraX 可通过 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/kotlin/androidx/camera/core/ImageAnalysis.Builder?hl=zh-cn#setOutputImageFormat(kotlin.Int)"><code>setOutputImageFormat(int)</code></a> 支持 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis?hl=zh-cn#OUTPUT_IMAGE_FORMAT_YUV_420_888"><code>YUV_420_888</code></a> 和 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis?hl=zh-cn#OUTPUT_IMAGE_FORMAT_RGBA_8888"><code>RGBA_8888</code></a>。默认格式为 <code>YUV_420_888</code>。</li>
<li><a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis.Builder?hl=zh-cn#setTargetResolution(android.util.Size)">Resolution</a> 和 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis.Builder?hl=zh-cn#setTargetAspectRatio(int)">AspectRatio</a>：您可以设置其中一个参数，但请注意，您不能同时设置这两个值。</li>
<li><a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis.Builder?hl=zh-cn#setTargetRotation(int)">旋转角度</a>。</li>
<li><a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis.Builder?hl=zh-cn#setTargetName(java.lang.String)">目标名称</a>：使用该参数进行调试。</li>
</ul>
</li>
<li>图像流控制：<ul>
<li><a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis.Builder?hl=zh-cn#setBackgroundExecutor(java.util.concurrent.Executor)">后台执行器</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis.Builder?hl=zh-cn#setImageQueueDepth(int)">图像队列深度（分析器和 CamaraX 之间）</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis.Builder?hl=zh-cn#setBackpressureStrategy(int)">背压策略</a></li>
</ul>
</li>
</ul>
<p>应用可以设置分辨率或宽高比，但不能同时设置这两个值。确切的输出分辨率取决于应用请求的大小（或宽高比）和硬件功能，并可能与请求的大小或宽高比不同。如需了解分辨率匹配算法，请参阅有关 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis.Builder?hl=zh-cn#setTargetResolution(android.util.Size)"><code>setTargetResolution()</code></a> 的文档</p>
<p>应用可以将输出图像像素配置为采用 YUV（默认）或 RGBA 颜色空间。设置 RGBA 输出格式时，CameraX 会在内部将图像从 YUV 颜色空间转换为 RGBA 颜色空间，并将图像位打包到 ImageProxy 第一个平面（其他两个平面未使用）的 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/ImageProxy.PlaneProxy?hl=zh-cn#getBuffer()"><code>ByteBuffer</code></a> 中，序列如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ImageProxy.getPlanes()[0].buffer[0]: alpha</span><br><span class="line">ImageProxy.getPlanes()[0].buffer[1]: red</span><br><span class="line">ImageProxy.getPlanes()[0].buffer[2]: green</span><br><span class="line">ImageProxy.getPlanes()[0].buffer[3]: blue</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>在执行设备无法满足帧速率要求的复杂图像分析时，您可以使用本主题的<a target="_blank" rel="noopener" href="https://developer.android.google.cn/training/camerax/analyze?hl=zh-cn#operating_modes">操作模式</a>部分所述的策略将 CameraX 配置为丢帧。</p>
<h4 id="创建分析器"><a href="#创建分析器" class="headerlink" title="创建分析器"></a>创建分析器</h4><p>应用可以通过实现 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis.Analyzer?hl=zh-cn"><code>ImageAnalysis.Analyzer</code></a> 接口并替换 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis.Analyzer?hl=zh-cn#analyze(androidx.camera.core.ImageProxy)"><code>analyze(ImageProxy image)</code></a> 来创建分析器。 在每个分析器中，应用都会收到一个 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/ImageProxy?hl=zh-cn"><code>ImageProxy</code></a>，它是 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/android/media/Image?hl=zh-cn">Media.Image</a> 的封装容器。可以使用 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/ImageProxy?hl=zh-cn#getFormat()"><code>ImageProxy.getFormat()</code></a> 来查询图像格式。该格式使用应用通过 <code>ImageAnalysis.Builder</code> 提供的以下值之一表示：</p>
<ul>
<li>如果应用请求了 <code>OUTPUT_IMAGE_FORMAT_RGBA_8888</code>，则为 <code>ImageFormat.RGBA_8888</code>。</li>
<li>如果应用请求了 <code>OUTPUT_IMAGE_FORMAT_YUV_420_888</code>，则为 <code>ImageFormat.YUV_420_888</code>。</li>
</ul>
<p>如需了解颜色空间配置以及可检索像素字节的位置，请参阅<a target="_blank" rel="noopener" href="https://developer.android.google.cn/training/camerax/analyze?hl=zh-cn#build_imageanalysis_use_case">构建 ImageAnalysis 用例</a>。</p>
<p>在分析器中，应用应执行以下操作：</p>
<ol>
<li>尽快分析给定的帧，最好在给定的帧速率时间限制内进行分析（例如，如果帧速率为 30 fps，则用时应低于 32 毫秒）。如果应用无法足够快地分析帧，请考虑采用一种<a target="_blank" rel="noopener" href="https://developer.android.google.cn/training/camerax/analyze?hl=zh-cn#operating_modes">受支持的丢帧机制</a>。</li>
<li>通过调用 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/ImageProxy?hl=zh-cn#close()"><code>ImageProxy.close()</code></a> 将 <code>ImageProxy</code> 发布到 CameraX。请注意，您不应调用已封装 Media.Image 的 close 函数 (<code>Media.Image.close()</code>)。</li>
</ol>
<p>应用可以直接使用 ImageProxy 中的已封装 <code>Media.Image</code>。 请不要对已封装的图像调用 <code>Media.Image.close()</code>，因为这会破坏 CameraX 中的图像分享机制；请改为使用 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/ImageProxy?hl=zh-cn#close()"><code>ImageProxy.close()</code></a> 将底层 <code>Media.Image</code> 发布到 CameraX。</p>
<h4 id="针对-ImageAnalysis-配置分析器"><a href="#针对-ImageAnalysis-配置分析器" class="headerlink" title="针对 ImageAnalysis 配置分析器"></a>针对 ImageAnalysis 配置分析器</h4><p>创建分析器后，使用 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis#setAnalyzer(java.util.concurrent.Executor,%20androidx.camera.core.ImageAnalysis.Analyzer)"><code>ImageAnalysis.setAnalyzer()</code></a> 注册该分析器以开始分析。完成分析后，使用 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis?hl=zh-cn#clearAnalyzer()"><code>ImageAnalysis.clearAnalyzer()</code></a> 移除已注册的分析器。</p>
<p>您只能将一个分析器配置为活动状态，用于分析图像。调用 <code>ImageAnalysis.setAnalyzer()</code> 会替换已注册的分析器（如果已存在该分析器）。应用可以在绑定用例之前或之后随时设置新的分析器。</p>
<h4 id="将-ImageAnalysis-绑定到生命周期"><a href="#将-ImageAnalysis-绑定到生命周期" class="headerlink" title="将 ImageAnalysis 绑定到生命周期"></a>将 ImageAnalysis 绑定到生命周期</h4><p><strong>注意</strong>：该步骤适用于所有 CameraX 用例。如需详细了解绑定和生命周期自定义，请参阅 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/training/camerax/architecture?hl=zh-cn#api-model">CameraX API 模型</a>。</p>
<p>强烈建议您使用 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/lifecycle/ProcessCameraProvider#bindToLifecycle(androidx.lifecycle.LifecycleOwner,%20androidx.camera.core.CameraSelector,%20androidx.camera.core.UseCase...)"><code>ProcessCameraProvider.bindToLifecycle()</code></a> 函数将 <code>ImageAnalysis</code> 绑定到现有的 AndroidX 生命周期。请注意，<code>bindToLifecycle()</code> 函数会返回选定的 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/camera/core/Camera?hl=zh-cn"><code>Camera</code></a> 设备，该函数可用于微调曝光等高级设置。如需详细了解如何控制相机输出，请参阅<a target="_blank" rel="noopener" href="https://developer.android.google.cn/training/camerax/configuration?hl=zh-cn#camera-output">此指南</a>。</p>
<p>以下示例结合了上述步骤中的所有操作，将 CameraX <code>ImageAnalysis</code> 和 <code>Preview</code> 用例绑定到了 <code>lifeCycle</code> 所有者：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> imageAnalysis = ImageAnalysis.Builder()</span><br><span class="line">    <span class="comment">// enable the following line if RGBA output is needed.</span></span><br><span class="line">    <span class="comment">// .setOutputImageFormat(ImageAnalysis.OUTPUT_IMAGE_FORMAT_RGBA_8888)</span></span><br><span class="line">    .setTargetResolution(Size(<span class="number">1280</span>, <span class="number">720</span>))</span><br><span class="line">    .setBackpressureStrategy(ImageAnalysis.STRATEGY_KEEP_ONLY_LATEST)</span><br><span class="line">    .build()</span><br><span class="line">imageAnalysis.setAnalyzer(executor, ImageAnalysis.Analyzer &#123; imageProxy -&gt;</span><br><span class="line">    <span class="keyword">val</span> rotationDegrees = imageProxy.imageInfo.rotationDegrees</span><br><span class="line">    <span class="comment">// insert your code here.</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// after done, release the ImageProxy object</span></span><br><span class="line">    imageProxy.close()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">cameraProvider.bindToLifecycle(<span class="keyword">this</span> <span class="keyword">as</span> LifecycleOwner, cameraSelector, imageAnalysis, preview)</span><br></pre></td></tr></table></figure>

<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://developer.android.google.cn/training/camerax">Android CameraX</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://blog.lazyiones.top">LazyIonEs</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://blog.lazyiones.top/post/ff52020d.html">https://blog.lazyiones.top/post/ff52020d.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.lazyiones.top" target="_blank">LazyIonEs</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android/">Android</a><a class="post-meta__tags" href="/tags/CameraX/">CameraX</a><a class="post-meta__tags" href="/tags/Jetpack/">Jetpack</a><a class="post-meta__tags" href="/tags/%E7%9B%B8%E6%9C%BA/">相机</a></div><div class="post_share"><div class="social-share" data-image="/img/cover/img_cover_1.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/post/627b7883.html" title="Android CameraX中使用Camera2"><img class="cover" src= "/img/loading.gif" data-lazy-src="/img/cover/img_cover_67.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Android CameraX中使用Camera2</div></div></a></div><div class="next-post pull-right"><a href="/post/b3b8a43c.html" title="使用 sourceSets 管理风味特定的 AndroidManifest.xml"><img class="cover" src= "/img/loading.gif" data-lazy-src="/img/cover/img_cover_80.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">使用 sourceSets 管理风味特定的 AndroidManifest.xml</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/post/d8629189.html" title="Android CameraX CameraController"><img class="cover" src= "/img/loading.gif" data-lazy-src="/img/cover/img_cover_5.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-08-30</div><div class="title">Android CameraX CameraController</div></div></a></div><div><a href="/post/627b7883.html" title="Android CameraX中使用Camera2"><img class="cover" src= "/img/loading.gif" data-lazy-src="/img/cover/img_cover_67.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-08-15</div><div class="title">Android CameraX中使用Camera2</div></div></a></div><div><a href="/post/779b2eb0.html" title="【自定义 View】相机预览点击聚焦框(带对焦动画，曝光调整)"><img class="cover" src= "/img/loading.gif" data-lazy-src="/img/cover/img_cover_27.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-05</div><div class="title">【自定义 View】相机预览点击聚焦框(带对焦动画，曝光调整)</div></div></a></div><div><a href="/post/b3b8a43c.html" title="使用 sourceSets 管理风味特定的 AndroidManifest.xml"><img class="cover" src= "/img/loading.gif" data-lazy-src="/img/cover/img_cover_80.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-08-04</div><div class="title">使用 sourceSets 管理风味特定的 AndroidManifest.xml</div></div></a></div><div><a href="/post/7482f6f9.html" title="仿墨迹24小时天气自定义View"><img class="cover" src= "/img/loading.gif" data-lazy-src="/img/cover/img_cover_73.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-06</div><div class="title">仿墨迹24小时天气自定义View</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="waline-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "/img/loading.gif" data-lazy-src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">LazyIonEs</div><div class="author-info__description">学习Android两年半的Android开发实习生</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">7</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">12</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/lazyiones" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:lazyiones@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">如果阅读过程中遇到了问题，请及时评论或者留言，看到了会在第一时间给出回复。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A3%B0%E6%98%8E%E4%BE%9D%E8%B5%96%E9%A1%B9"><span class="toc-number">2.</span> <span class="toc-text">声明依赖项</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E9%A2%84%E8%A7%88"><span class="toc-number">3.</span> <span class="toc-text">实现预览</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86-PreviewView-%E6%B7%BB%E5%8A%A0%E5%88%B0%E5%B8%83%E5%B1%80"><span class="toc-number">3.1.</span> <span class="toc-text">将 PreviewView 添加到布局</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E7%9B%B8%E6%9C%BA"><span class="toc-number">3.2.</span> <span class="toc-text">初始化相机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E6%91%84%E5%83%8F%E5%A4%B4"><span class="toc-number">3.3.</span> <span class="toc-text">检查摄像头</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%91%E5%AE%9A%E7%9B%B8%E6%9C%BA"><span class="toc-number">3.4.</span> <span class="toc-text">绑定相机</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%BE%E7%89%87%E6%8B%8D%E6%91%84"><span class="toc-number">4.</span> <span class="toc-text">图片拍摄</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E5%88%86%E5%8A%9F%E8%83%BD"><span class="toc-number">5.</span> <span class="toc-text">部分功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%87%E6%8D%A2%E6%91%84%E5%83%8F%E5%A4%B4"><span class="toc-number">5.1.</span> <span class="toc-text">切换摄像头</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%8B%E7%94%B5%E7%AD%92"><span class="toc-number">5.2.</span> <span class="toc-text">手电筒</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%9D%E5%85%89%E8%A1%A5%E5%81%BF"><span class="toc-number">5.3.</span> <span class="toc-text">曝光补偿</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PreviewView-%E7%9A%84%E5%85%B6%E4%BB%96API"><span class="toc-number">6.</span> <span class="toc-text">PreviewView 的其他API</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%A8%A1%E5%BC%8F"><span class="toc-number">6.1.</span> <span class="toc-text">实现模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%A9%E6%94%BE%E7%B1%BB%E5%9E%8B"><span class="toc-number">6.2.</span> <span class="toc-text">缩放类型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E9%80%89%E9%A1%B9"><span class="toc-number">7.</span> <span class="toc-text">配置选项</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CameraXConfig"><span class="toc-number">7.1.</span> <span class="toc-text">CameraXConfig</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%A8%A1%E5%BC%8F"><span class="toc-number">7.1.1.</span> <span class="toc-text">使用模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%91%84%E5%83%8F%E5%A4%B4%E9%99%90%E5%88%B6%E5%99%A8"><span class="toc-number">7.1.2.</span> <span class="toc-text">摄像头限制器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B"><span class="toc-number">7.1.3.</span> <span class="toc-text">线程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%91%84%E5%83%8F%E5%A4%B4%E6%89%A7%E8%A1%8C%E5%99%A8"><span class="toc-number">7.1.4.</span> <span class="toc-text">摄像头执行器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E5%BA%A6%E5%99%A8%E5%A4%84%E7%90%86%E7%A8%8B%E5%BA%8F"><span class="toc-number">7.1.5.</span> <span class="toc-text">调度器处理程序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95"><span class="toc-number">7.1.6.</span> <span class="toc-text">日志记录</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E9%80%89%E6%8B%A9"><span class="toc-number">7.2.</span> <span class="toc-text">自动选择</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%8B%E8%BD%AC"><span class="toc-number">7.3.</span> <span class="toc-text">旋转</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%AA%E8%A3%81%E7%9F%A9%E5%BD%A2"><span class="toc-number">7.4.</span> <span class="toc-text">剪裁矩形</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%91%84%E5%83%8F%E5%A4%B4%E5%88%86%E8%BE%A8%E7%8E%87"><span class="toc-number">7.5.</span> <span class="toc-text">摄像头分辨率</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%88%86%E8%BE%A8%E7%8E%87"><span class="toc-number">7.5.1.</span> <span class="toc-text">自动分辨率</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A%E5%88%86%E8%BE%A8%E7%8E%87"><span class="toc-number">7.5.2.</span> <span class="toc-text">指定分辨率</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E6%91%84%E5%83%8F%E5%A4%B4%E8%BE%93%E5%87%BA"><span class="toc-number">7.6.</span> <span class="toc-text">控制摄像头输出</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96-CameraControl-%E5%92%8C-CameraInfo-%E7%9A%84%E5%AE%9E%E4%BE%8B"><span class="toc-number">7.6.1.</span> <span class="toc-text">获取 CameraControl 和 CameraInfo 的实例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E7%84%A6%E5%92%8C%E6%B5%8B%E5%85%89"><span class="toc-number">7.6.2.</span> <span class="toc-text">对焦和测光</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%BE%E5%83%8F%E5%88%86%E6%9E%90"><span class="toc-number">8.</span> <span class="toc-text">图像分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E6%A8%A1%E5%BC%8F"><span class="toc-number">8.1.</span> <span class="toc-text">操作模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0"><span class="toc-number">8.2.</span> <span class="toc-text">实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA-ImageAnalysis-%E7%94%A8%E4%BE%8B"><span class="toc-number">8.2.1.</span> <span class="toc-text">构建 ImageAnalysis 用例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%88%86%E6%9E%90%E5%99%A8"><span class="toc-number">8.2.2.</span> <span class="toc-text">创建分析器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%92%88%E5%AF%B9-ImageAnalysis-%E9%85%8D%E7%BD%AE%E5%88%86%E6%9E%90%E5%99%A8"><span class="toc-number">8.2.3.</span> <span class="toc-text">针对 ImageAnalysis 配置分析器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86-ImageAnalysis-%E7%BB%91%E5%AE%9A%E5%88%B0%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">8.2.4.</span> <span class="toc-text">将 ImageAnalysis 绑定到生命周期</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">9.</span> <span class="toc-text">参考</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/post/d8629189.html" title="Android CameraX CameraController"><img src= "/img/loading.gif" data-lazy-src="/img/cover/img_cover_5.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android CameraX CameraController"/></a><div class="content"><a class="title" href="/post/d8629189.html" title="Android CameraX CameraController">Android CameraX CameraController</a><time datetime="2023-08-30T11:14:58.000Z" title="发表于 2023-08-30 19:14:58">2023-08-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/c054934f.html" title="HomeBrew 常用指令"><img src= "/img/loading.gif" data-lazy-src="/img/cover/img_cover_51.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="HomeBrew 常用指令"/></a><div class="content"><a class="title" href="/post/c054934f.html" title="HomeBrew 常用指令">HomeBrew 常用指令</a><time datetime="2023-08-30T10:50:42.000Z" title="发表于 2023-08-30 18:50:42">2023-08-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/627b7883.html" title="Android CameraX中使用Camera2"><img src= "/img/loading.gif" data-lazy-src="/img/cover/img_cover_67.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android CameraX中使用Camera2"/></a><div class="content"><a class="title" href="/post/627b7883.html" title="Android CameraX中使用Camera2">Android CameraX中使用Camera2</a><time datetime="2023-08-15T01:39:50.000Z" title="发表于 2023-08-15 09:39:50">2023-08-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/ff52020d.html" title="Android CameraX的基本使用"><img src= "/img/loading.gif" data-lazy-src="/img/cover/img_cover_1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android CameraX的基本使用"/></a><div class="content"><a class="title" href="/post/ff52020d.html" title="Android CameraX的基本使用">Android CameraX的基本使用</a><time datetime="2023-08-14T11:31:06.000Z" title="发表于 2023-08-14 19:31:06">2023-08-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/b3b8a43c.html" title="使用 sourceSets 管理风味特定的 AndroidManifest.xml"><img src= "/img/loading.gif" data-lazy-src="/img/cover/img_cover_80.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="使用 sourceSets 管理风味特定的 AndroidManifest.xml"/></a><div class="content"><a class="title" href="/post/b3b8a43c.html" title="使用 sourceSets 管理风味特定的 AndroidManifest.xml">使用 sourceSets 管理风味特定的 AndroidManifest.xml</a><time datetime="2023-08-04T03:57:22.000Z" title="发表于 2023-08-04 11:57:22">2023-08-04</time></div></div></div></div></div></div></main><footer id="footer" style="background: url(/img/footer_bg.png)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By LazyIonEs</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const initWaline = () => {
    const waline = Waline.init(Object.assign({
      el: '#waline-wrap',
      serverURL: 'https://waline.lazyiones.top',
      pageview: false,
      dark: 'html[data-theme="dark"]',
      path: window.location.pathname,
      comment: true,
    }, null))
  }

  const loadWaline = async () => {
    if (typeof Waline === 'object') initWaline()
    else {
      await getCSS('https://cdn.jsdelivr.net/npm/@waline/client/dist/waline.min.css')
      await getScript('https://cdn.jsdelivr.net/npm/@waline/client/dist/waline.min.js')
      initWaline()
    }
  }

  if ('Waline' === 'Waline' || !false) {
    if (false) btf.loadComment(document.getElementById('waline-wrap'),loadWaline)
    else setTimeout(loadWaline, 0)
  } else {
    window.loadOtherComment = loadWaline
  }
})()</script></div><script async src="https://npm.elemecdn.com/tzy-blog/lib/js/other/sakura.js"></script><script id="canvas_nest" defer="defer" color="42,81,144" opacity="1" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>