<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Android CameraX CameraController</title>
      <link href="/post/d8629189.html"/>
      <url>/post/d8629189.html</url>
      
        <content type="html"><![CDATA[<p><a href="https://developer.android.com/training/camerax">CameraX</a> currently provides <code>CameraView</code>, a <code>View</code> that displays a preview of the camera, while also providing methods to take pictures, control the camera, and query camera information. <code>CameraView</code> clearly takes on more responsibilities than a <code>View</code> should, as it participates in the <code>View</code> hierarchy and displays content, while also owning camera resources that exist outside the scope and lifecycle of the <code>View</code> hierarchy.</p><p><code>CameraView</code> violates the separation of concerns principle, making it harder to guarantee its robustness in all corner cases. As a result, it will be marked as deprecated and removed before CameraXâ€™s view artifact reaches Beta. It has been split up into two parts that you should use instead: <code>PreviewView</code> which handles its view-related tasks, and <code>CameraController</code> which handles the camera operations.</p><p><code>PreviewView</code> has been available in CameraXâ€™s view artifact for a while. <code>CameraController</code>, however, was introduced recently in version alpha19. Itâ€™s a high-level, all-in-one API that provides a way to easily access and manipulate core camera features, including displaying a camera preview, taking a picture, and analyzing camera frames. It does so while matching the output of its use cases to the viewfinderâ€™s preview, thus providing a â€œWhat You See Is What You Getâ€ (WYSIWYG) experience, a highly requested feature by developers that makes CameraXâ€™s usage very intuitive. It also takes care of initializing the camera and adapting its output to device rotation.</p><p>To offload the burden of starting, stopping, and closing the camera, CameraX also introduced <code>LifecycleCameraController</code>, which offers all the convenience of <code>CameraController</code> with the added benefit of binding the cameraâ€™s lifecycle to that of a <code>LifecycleOwner</code>, typically the lifecycle of a <code>Fragment</code> or <code>Activity</code>. This allows the lifecycleâ€™s state to control when the camera is opened, stopped, and closed.</p><p>Using <code>PreviewView</code> with <code>CameraController</code> is fairly simple, and can be done as follows:</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Set up the CameraController</span></span><br><span class="line"><span class="keyword">val</span> cameraController = LifecycleCameraController(context)</span><br><span class="line">cameraController.bindToLifecycle(lifecycleOwner)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Attach the CameraController to PreviewView</span></span><br><span class="line"><span class="keyword">val</span> previewView = findViewById(R.id.preview_view)</span><br><span class="line">previewView.setController(cameraController)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Use the CameraController</span></span><br><span class="line">cameraController.takePicture(â€¦)</span><br></pre></td></tr></table></figure><p>The following sections list the mappings from <code>CameraView</code> to <code>CameraController</code>. You can use them to migrate from <code>CameraView</code> to <code>PreviewView</code> and <code>CameraController</code>.</p><h1 id="Camera-Initialization"><a href="#Camera-Initialization" class="headerlink" title="Camera Initialization"></a>Camera Initialization</h1><table><thead><tr><th align="left">CameraView</th><th align="left">CameraController</th></tr></thead><tbody><tr><td align="left">-</td><td align="left">getInitializationFuture()</td></tr></tbody></table><p>Unlike <code>CameraView</code>, <code>CameraController</code> provides a <code>ListenableFuture</code> to monitor its initialization. Itâ€™s an asynchronous operation during which <code>CameraController</code> initializes CameraX and binds its use cases. The benefit of using this <code>ListenableFuture</code> is twofold:</p><ul><li>Once it successfully completes, you can allow your users to start interacting with the camera, for example by taking pictures and zooming in and out of the viewfinder.</li><li>In case it fails, you can gracefully handle the error and communicate it to your users.</li></ul><p>In case you arenâ€™t familiar with <code>ListenableFuture</code>: it wraps an asynchronous operation and allows you to attach a listener thatâ€™s invoked on its completion. In case the operation has already finished, the future returns immediately.</p><h1 id="Camera-Lifecycle"><a href="#Camera-Lifecycle" class="headerlink" title="Camera Lifecycle"></a>Camera Lifecycle</h1><table><thead><tr><th align="left">CameraView</th><th align="left">LifecycleCameraController</th></tr></thead><tbody><tr><td align="left">bindToLifecycle(LifecycleOwner)</td><td align="left">bindToLifecycle(LifecycleOwner)</td></tr></tbody></table><p>Similar to <code>CameraView</code>, <code>LifecycleCameraController</code> ties control of the camera to a lifecycle. You must bind a valid <code>LifecycleOwner</code> to the controller for it to be operational.</p><p><code>LifecycleCameraController</code> provides an additional <code>unbind()</code> method which allows you to prematurely close the camera before the lifecycle that itâ€™s bound to comes to an end. This is useful in cases in which the camera isnâ€™t integral to a screen and isnâ€™t needed for its entire lifecycle. Alternatively, you can define your custom <code>LifecycleOwner</code> to control when to close the camera, but <code>unbind()</code> can be more convenient in some cases.</p><h1 id="Camera-Control"><a href="#Camera-Control" class="headerlink" title="Camera Control"></a>Camera Control</h1><h2 id="Zoom"><a href="#Zoom" class="headerlink" title="- Zoom"></a><strong>- Zoom</strong></h2><table><thead><tr><th align="left">CameraView</th><th align="left">CameraController</th></tr></thead><tbody><tr><td align="left">isZoomSupported()</td><td align="left">-</td></tr><tr><td align="left">isPinchToZoomEnabled()</td><td align="left">isPinchToZoomEnabled()</td></tr><tr><td align="left">setPinchToZoomEnabled(Boolean)</td><td align="left">setPinchToZoomEnabled(Boolean)</td></tr><tr><td align="left">getZoomRatio()</td><td align="left">getZoomState().getZoomRatio()</td></tr><tr><td align="left">getMinZoomRatio()</td><td align="left">getZoomState().getMinZoomRatio()</td></tr><tr><td align="left">getMaxZoomRatio()</td><td align="left">getZoomState().getMaxZoomRatio()</td></tr><tr><td align="left">-</td><td align="left">getZoomState().getLinearZoom()</td></tr><tr><td align="left">setZoomRatio(float)</td><td align="left">setZoomRatio(float)</td></tr><tr><td align="left">-</td><td align="left">setLinearZoom(float)</td></tr></tbody></table><p><code>CameraController</code> allows you to observe the cameraâ€™s zoom state via a <code>LiveData</code> instance. This state becomes available once the camera is open, and holds both static information, like the maximum and minimum zoom ratios, and dynamic information, like the current zoom ratio. You can verify whether zoom is supported using the maximum zoom ratio as follows:</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> isZoomSupported = getZoomState().getValue().getMaxZoomRatio() != <span class="number">1</span></span><br></pre></td></tr></table></figure><p><code>CameraController</code> additionally provides methods to get and set linear zoom, which can vary between 0 (minimum zoom) and 1 (maximum zoom).</p><p>Finally, like <code>CameraView</code>, <code>CameraController</code> allows you to enable or disable pinch-to-zoom. When enabled, <code>CameraController</code> handles pinch gestures on its attached <code>PreviewView</code> to zoom the camera in and out.</p><table><thead><tr><th align="left">CameraView</th><th align="left">CameraController</th></tr></thead><tbody><tr><td align="left">enableTorch(boolean)</td><td align="left">enableTorch(boolean)</td></tr><tr><td align="left">isTorchOn()</td><td align="left">getTorchState()</td></tr><tr><td align="left">getFlash()</td><td align="left">getImageCaptureFlashMode()</td></tr><tr><td align="left">setFlash(int)</td><td align="left">setImageCaptureFlashMode(int)</td></tr></tbody></table><p><code>CameraController</code> provides similar methods as <code>CameraView</code> to set and query the image captureâ€™s flash mode, but unlike <code>CameraView</code>, it allows observing changes in the cameraâ€™s torch state via a <code>LiveData</code> instance, which emits <code>TorchState.OFF</code> and <code>TorchState.ON</code>.</p><h2 id="Focus-Metering"><a href="#Focus-Metering" class="headerlink" title="- Focus&#x2F;Metering"></a>- Focus&#x2F;Metering</h2><table><thead><tr><th align="left">CameraView</th><th align="left">CameraController</th></tr></thead><tbody><tr><td align="left">-</td><td align="left">isTapToFocusEnabled()</td></tr><tr><td align="left">-</td><td align="left">setTapToFocusEnabled(boolean)</td></tr></tbody></table><p>While <code>CameraView</code> automatically acquires focus on any region of the viewfinder that is tapped, <code>CameraController</code> provides more flexibility by allowing you to enable or disable tap-to-focus functionality. When enabled, <code>CameraController</code> handles touch events on its attached <code>PreviewView</code> by focusing the camera on tapped regions.</p><h1 id="Camera-Selection"><a href="#Camera-Selection" class="headerlink" title="Camera Selection"></a>Camera Selection</h1><table><thead><tr><th align="left">CameraView</th><th align="left">LifecycleCameraController</th></tr></thead><tbody><tr><td align="left">hasCameraWithLensFacing(int)</td><td align="left">hasCamera(CameraSelector)</td></tr><tr><td align="left">setCameraLensFacing(Integer)</td><td align="left">setCameraSelector(CameraSelector)</td></tr><tr><td align="left">getCameraLensFacing()</td><td align="left">getCameraSelector()</td></tr><tr><td align="left">toggleCamera()</td><td align="left">-</td></tr></tbody></table><p><code>CameraController</code> provides you with more control over which camera to use by allowing you to specify a <code>CameraSelector</code> to select the camera it uses. This allows you to rotate between various cameras when toggling cameras, instead of only the default front and back cameras, which was a limitation of <code>CameraView.toggleCamera()</code>. You can still implement this fairly easily, though, using <code>CameraController</code> as follows.</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">toggleCamera</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (cameraController.cameraSelector == CameraSelector.DEFAULT_BACK_CAMERA </span><br><span class="line">        &amp;&amp; cameraController.hasCamera(CameraSelector.DEFAULT_FRONT_CAMERA) &#123;</span><br><span class="line">        cameraController.cameraSelector = CameraSelector.DEFAULT_FRONT_CAMERA</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cameraController.cameraSelector == CameraSelector.DEFAULT_FRONT_CAMERA </span><br><span class="line">               &amp;&amp; cameraController.hasCamera(CameraSelector.DEFAULT_BACK_CAMERA) &#123;</span><br><span class="line">        cameraController.cameraSelector = CameraSelector.DEFAULT_BACK_CAMERA</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Camera-Use-Cases"><a href="#Camera-Use-Cases" class="headerlink" title="Camera Use Cases"></a>Camera Use Cases</h1><table><thead><tr><th align="left">CameraView</th><th align="left">CameraController</th></tr></thead><tbody><tr><td align="left">getCaptureMode()</td><td align="left">isImageCaptureEnabled()</td></tr><tr><td align="left">-</td><td align="left">isImageAnalysisEnabled()</td></tr><tr><td align="left">setCaptureMode(CaptureMode)</td><td align="left">setEnabledUseCases(int)</td></tr></tbody></table><p><code>CameraController</code> supports all of CameraXâ€™s <a href="https://developer.android.com/training/camerax/architecture#structure">use cases</a>: <code>Preview</code>, <code>ImageAnalysis</code>, and <code>ImageCapture</code>, thus making it a more robust camera solution compared to <code>CameraView</code>. It also matches the output of <code>ImageAnalysis</code> and <code>ImageCapture</code> to the previewâ€™s display, thereby providing a WYSIWYG experience.</p><p><code>CameraController</code>â€™s default state enables preview, image analysis, and image capture. The <code>Preview</code> use case is <strong>always</strong> enabled, so you can choose the remaining use cases to enable or disable depending on your camera usage needs.</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Enable image capture, equivalent to cameraView.setCaptureMode(IMAGE)</span></span><br><span class="line"><span class="comment">// CameraController&#x27;s enabled use cases: Preview + ImageCapture</span></span><br><span class="line">cameraController.setEnabledUseCases(IMAGE_CAPTURE)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Enable image capture and image analysis</span></span><br><span class="line"><span class="comment">// CameraController&#x27;s enabled use cases: Preview + ImageCapture + ImageAnalysis</span></span><br><span class="line">cameraController.setEnabledUseCases(IMAGE_CAPTURE|IMAGE_ANALYSIS)</span><br></pre></td></tr></table></figure><h2 id="Preview"><a href="#Preview" class="headerlink" title="- Preview"></a>- Preview</h2><table><thead><tr><th align="left">CameraView</th><th align="left">CameraController</th></tr></thead><tbody><tr><td align="left">getPreviewStreamState()</td><td align="left">Call directly on associated PreviewView</td></tr><tr><td align="left">getScaleType()</td><td align="left">Call directly on associated PreviewView</td></tr><tr><td align="left">setScaleType(ScaleType)</td><td align="left">Call directly on associated PreviewView</td></tr></tbody></table><p>Unlike <code>CameraView</code> which wraps (and thus hides) a <code>PreviewView</code> instance and forwards method calls to it, <code>CameraController</code> is decoupled from <code>PreviewView</code>. This means you have more control over the viewfinder, and can access and manipulate it directly.</p><h2 id="ImageAnalysis"><a href="#ImageAnalysis" class="headerlink" title="- ImageAnalysis"></a>- ImageAnalysis</h2><table><thead><tr><th align="left">CameraView</th><th align="left">CameraController</th></tr></thead><tbody><tr><td align="left">-</td><td align="left">setImageAnalysisAnalyzer(Executor, Analyzer)</td></tr><tr><td align="left">-</td><td align="left">clearImageAnalysisAnalyzer()</td></tr><tr><td align="left">-</td><td align="left">getImageAnalysisBackpressureStrategy()</td></tr><tr><td align="left">-</td><td align="left">setImageAnalysisBackpressureStrategy(int)</td></tr><tr><td align="left">-</td><td align="left">getImageAnalysisImageQueueDepth()</td></tr><tr><td align="left">-</td><td align="left">setImageAnalysisImageQueueDepth(int)</td></tr></tbody></table><p>Unlike <code>CameraView</code>, <code>CameraController</code> supports the <code>ImageAnalysis</code> use case. You can set and clear its <code>Analyzer</code>, while also configuring its image-processing pipeline.</p><h2 id="ImageCapture"><a href="#ImageCapture" class="headerlink" title="- ImageCapture"></a>- ImageCapture</h2><table><thead><tr><th align="left">CameraView</th><th align="left">CameraController</th></tr></thead><tbody><tr><td align="left">takePicture(Executor, OnImageCapturedCallback)</td><td align="left">takePicture(Executor, OnImageCapturedCallback)</td></tr><tr><td align="left">takePicture(OutputFileOptions, Executor, OnImageSavedCallback)</td><td align="left">takePicture(OutputFileOptions, Executor, OnImageSavedCallback)</td></tr></tbody></table><p><code>CameraController</code> provides the same methods as <code>CameraView</code> to take a picture, specify the image save destination, and provide the image capture callbacks.</p><p><em>One thing to note is that</em> <code>*CameraController*</code> <em>mirrors an image captured with a front-facing camera, unless you disable this in the</em> <code>*OutputFileOptions*</code><em>â€™s metadata by calling</em> <code>*Metadata.setReversedHorizontal(false)*</code>.</p><h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>In summary:</p><ul><li>Because <code>CameraView</code> is handling the responsibilities of both a view and a controller in the MVC sense, CameraX is deprecating it and splitting it into <code>PreviewView</code> and the newly introduced <code>CameraController</code>.</li><li><code>CameraController</code> handles camera initialization, as well as the creation and configuration of its use cases.</li><li><code>CameraController</code> provides a WYSIWYG experience by matching the output of its use cases to <code>PreviewView</code>â€™s display.</li><li><code>CameraController</code> listens to the deviceâ€™s motion sensor to correctly rotate the output of its use cases.</li><li><code>CameraController</code> adds support for the <code>ImageAnalysis</code> use case, making it a more robust camera solution that provides easy access to all of CameraXâ€™s use cases.</li><li><code>CameraController</code> supports all of <code>CameraView</code>â€™s features and more, such as enabling and disabling tap-to-focus, getting and setting linear zoom, and observing dynamic camera information like the zoom and torch states.</li><li><code>LifecycleCameraController</code> is a <code>CameraController</code> that binds the cameraâ€™s lifecycle to that of a <code>LifecycleOwner</code>, typically the lifecycle of the UI.</li></ul><p>Want more CameraX goodness? Check out:</p><ul><li><a href="https://developer.android.com/training/camerax">Official CameraX documentation</a></li><li><a href="https://codelabs.developers.google.com/codelabs/camerax-getting-started">Guided CameraX introduction codelab</a></li><li><a href="https://groups.google.com/a/android.com/g/camerax-developers">CameraX developer community</a></li><li><a href="https://github.com/android/camera-samples/tree/master/CameraXBasic">CameraX official sample app</a></li></ul><p>è½¬è½½è‡³<a href="https://medium.com/androiddevelopers/camerax-learn-how-to-use-cameracontroller-e3ed10fffecf">medium.com</a></p>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
          <category> CameraX </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> CameraX </tag>
            
            <tag> Jetpack </tag>
            
            <tag> ç›¸æœº </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HomeBrew å¸¸ç”¨æŒ‡ä»¤</title>
      <link href="/post/c054934f.html"/>
      <url>/post/c054934f.html</url>
      
        <content type="html"><![CDATA[<h3 id="ä¿¡æ¯æŸ¥è¯¢"><a href="#ä¿¡æ¯æŸ¥è¯¢" class="headerlink" title="ä¿¡æ¯æŸ¥è¯¢"></a>ä¿¡æ¯æŸ¥è¯¢</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ Homebrew ç‰ˆæœ¬</span></span><br><span class="line">brew -v</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ—å‡ºå·²å®‰è£…çš„è½¯ä»¶</span></span><br><span class="line">brew list</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨æµè§ˆå™¨æ‰“å¼€ Homebrew å®˜ç½‘</span></span><br><span class="line">brew home</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹åŒ…çš„è¯¦ç»†ä¿¡æ¯</span></span><br><span class="line">brew info åŒ…å</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æµ‹ç³»ç»Ÿä¸­ä¸Homebrewæœ‰å…³çš„æ½œåœ¨é—®é¢˜</span></span><br><span class="line">brew doctor</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹åŒ…çš„æ‰€æœ‰ç‰ˆæœ¬</span></span><br><span class="line">brew list --versions | grep åŒ…å</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹å·²å®‰è£…è½¯ä»¶ç‰ˆæœ¬å·</span></span><br><span class="line">brew list --versions</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»¥æ ‘å½¢å±•ç¤ºæ‰€æœ‰å·²å®‰è£…åŒ…çš„ä¾èµ–</span></span><br><span class="line">brew deps --installed --tree</span><br></pre></td></tr></table></figure><h3 id="æŸ¥æ‰¾è½¯ä»¶åŒ…"><a href="#æŸ¥æ‰¾è½¯ä»¶åŒ…" class="headerlink" title="æŸ¥æ‰¾è½¯ä»¶åŒ…"></a>æŸ¥æ‰¾è½¯ä»¶åŒ…</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">brew search git</span><br><span class="line">brew search /^git$/</span><br></pre></td></tr></table></figure><h3 id="å®‰è£…è½¯ä»¶åŒ…"><a href="#å®‰è£…è½¯ä»¶åŒ…" class="headerlink" title="å®‰è£…è½¯ä»¶åŒ…"></a>å®‰è£…è½¯ä»¶åŒ…</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é»˜è®¤å®‰è£…æœ€æ–°ç‰ˆ</span></span><br><span class="line">brew install åŒ…å</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…æŒ‡å®šç‰ˆæœ¬</span></span><br><span class="line">brew install node@14.16.8</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ‡æ¢ç‰ˆæœ¬</span></span><br><span class="line">brew switch node 16.0.0</span><br></pre></td></tr></table></figure><h3 id="å¸è½½è½¯ä»¶åŒ…"><a href="#å¸è½½è½¯ä»¶åŒ…" class="headerlink" title="å¸è½½è½¯ä»¶åŒ…"></a>å¸è½½è½¯ä»¶åŒ…</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew uninstall åŒ…å</span><br></pre></td></tr></table></figure><h3 id="è‡ªèº«æ›´æ–°"><a href="#è‡ªèº«æ›´æ–°" class="headerlink" title="è‡ªèº«æ›´æ–°"></a>è‡ªèº«æ›´æ–°</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew update</span><br></pre></td></tr></table></figure><h3 id="æ›´æ–°åŒ…"><a href="#æ›´æ–°åŒ…" class="headerlink" title="æ›´æ–°åŒ…"></a>æ›´æ–°åŒ…</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹å“ªäº›åŒ…æœ‰æ–°ç‰ˆæœ¬å¯æ›´æ–°</span></span><br><span class="line">brew outdated</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ›´æ–°æ‰€æœ‰åŒ…</span></span><br><span class="line">brew upgrade</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ›´æ–°æŒ‡å®šåŒ…</span></span><br><span class="line">brew upgrade åŒ…å</span><br></pre></td></tr></table></figure><h3 id="æ¸…ç†æ—§çš„å‡çº§åŒ…"><a href="#æ¸…ç†æ—§çš„å‡çº§åŒ…" class="headerlink" title="æ¸…ç†æ—§çš„å‡çº§åŒ…"></a>æ¸…ç†æ—§çš„å‡çº§åŒ…</h3><p>âš ï¸ æ³¨æ„ï¼šå¦‚æœä¸€ä¸ªåŒ…å½“å‰æœ‰å¯æ›´æ–°çš„ç‰ˆæœ¬æ²¡æœ‰æ›´æ–°ï¼Œæ‰§è¡Œæ¸…ç†æ—¶å€™åªä¼šæç¤ºä¸€ä¸ªè­¦å‘Šï¼Œè€Œä¸ä¼šæ‰§è¡Œæ¸…ç†æ“ä½œã€‚éœ€è¦å…ˆå‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬ï¼Œå€¼æ‰§è¡Œæ¸…ç†ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹å“ªäº›åŒ…å¯æ¸…ç†</span></span><br><span class="line">brew cleanup -n</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¸…ç†æ‰€æœ‰</span></span><br><span class="line">brew cleanup</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¸…ç†æŒ‡å®šåŒ…</span></span><br><span class="line">brew cleanup åŒ…å</span><br></pre></td></tr></table></figure><h3 id="é”å®šä¸æƒ³æ›´æ–°çš„åŒ…"><a href="#é”å®šä¸æƒ³æ›´æ–°çš„åŒ…" class="headerlink" title="é”å®šä¸æƒ³æ›´æ–°çš„åŒ…"></a>é”å®šä¸æƒ³æ›´æ–°çš„åŒ…</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é”å®š</span></span><br><span class="line">brew pin åŒ…å</span><br><span class="line"></span><br><span class="line"><span class="comment"># è§£é”</span></span><br><span class="line">brew unpin åŒ…å</span><br></pre></td></tr></table></figure><h3 id="æœåŠ¡"><a href="#æœåŠ¡" class="headerlink" title="æœåŠ¡"></a>æœåŠ¡</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è·å–servicesåˆ—è¡¨</span></span><br><span class="line">brew services list</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨/æš‚åœ/é‡å¯ æœåŠ¡</span></span><br><span class="line">brew services start/stop/restart serverName</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Mac </category>
          
          <category> Homebrew </category>
          
          <category> Homebrew </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Mac </tag>
            
            <tag> Homebrew </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android CameraXä¸­ä½¿ç”¨Camera2</title>
      <link href="/post/627b7883.html"/>
      <url>/post/627b7883.html</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>CameraX åŸºäº Camera2 æ„å»ºè€Œæˆï¼Œå¹¶ä¸” CameraX æä¾›äº†åœ¨ Camera2 å®ç°ä¸­è¯»å–ç”šè‡³å†™å…¥å±æ€§çš„æ–¹å¼ã€‚å¦‚éœ€äº†è§£å®Œæ•´è¯¦æƒ…ï¼Œè¯·å‚é˜…<a href="https://developer.android.google.cn/reference/androidx/camera/camera2/interop/package-summary?hl=zh-cn">äº’æ“ä½œæ€§è½¯ä»¶åŒ…</a>ã€‚</p><p>é‚£ä¹ˆè¯¥å¦‚ä½•ä½¿ç”¨å‘¢</p><p><strong>æ³¨æ„ï¼š</strong>åœ¨ CameraX ä¸­ï¼Œè®¾ç½®åº•å±‚ Camera2 å±æ€§ä¼šè¢«æ ‡è®°ä¸ºâ€œå®éªŒæ€§â€ï¼Œå› ä¸º Google å¸Œæœ›å¼€å‘è€…èƒ½äº†è§£å…¶ä½¿ç”¨æƒ…å†µã€‚æ‚¨è®¾ç½®çš„å€¼ä¼šæ›¿æ¢ CameraX æ‰€è®¾ç½®çš„ä»»ä½•å€¼ã€‚æˆ‘ä»¬å»ºè®®æ‚¨ä»…åœ¨ç»å¯¹å¿…è¦æ—¶æ‰§è¡Œæ­¤æ“ä½œï¼Œä¹Ÿå»ºè®®åœ¨æ‚¨è¿™ä¸€ç«¯è¿›è¡Œå…¶ä»–æµ‹è¯•ã€‚</p><h2 id="Camera2CameraInfo"><a href="#Camera2CameraInfo" class="headerlink" title="Camera2CameraInfo"></a><a href="https://developer.android.google.cn/reference/androidx/camera/camera2/interop/Camera2CameraInfo?hl=zh-cn"><code>Camera2CameraInfo</code></a></h2><p>ä½¿ç”¨ <a href="https://developer.android.google.cn/reference/androidx/camera/camera2/interop/Camera2CameraInfo?hl=zh-cn"><code>Camera2CameraInfo</code></a> è¯»å–åº•å±‚ <a href="https://developer.android.google.cn/reference/android/hardware/camera2/CameraCharacteristics?hl=zh-cn"><code>CameraCharacteristics</code></a></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> c2ci = Camera2CameraInfo.from(cameraInfo)</span><br><span class="line">c2ci.apply &#123;</span><br><span class="line">    <span class="comment">// è·å–è®¾å¤‡æ”¯æŒçš„ç¡¬ä»¶çº§åˆ«</span></span><br><span class="line">    <span class="keyword">val</span> level = getCameraCharacteristic(CameraCharacteristics.INFO_SUPPORTED_HARDWARE_LEVEL) ?: INFO_SUPPORTED_HARDWARE_LEVEL_LIMITED</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Camera2CameraControl"><a href="#Camera2CameraControl" class="headerlink" title="Camera2CameraControl"></a><a href="https://developer.android.google.cn/reference/androidx/camera/camera2/interop/Camera2CameraControl?hl=zh-cn"><code>Camera2CameraControl</code></a></h2><p>ä½¿ç”¨ <a href="https://developer.android.google.cn/reference/androidx/camera/camera2/interop/Camera2CameraControl?hl=zh-cn"><code>Camera2CameraControl</code></a>ï¼Œå®ƒè®©æ‚¨å¯ä»¥åœ¨åº•å±‚ <a href="https://developer.android.google.cn/reference/android/hardware/camera2/CaptureRequest?hl=zh-cn"><code>CaptureRequest</code></a> ä¸Šè®¾ç½®å±æ€§ï¼Œä¾‹å¦‚è‡ªåŠ¨AWBæ¨¡å¼ã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> c2cc = Camera2CameraControl.from(cameraControl)</span><br><span class="line">c2cc.captureRequestOptions = CaptureRequestOptions.Builder()</span><br><span class="line">    .setCaptureRequestOption(CaptureRequest.CONTROL_AWB_MODE, CaptureRequest.CONTROL_AWB_MODE_OFF)</span><br><span class="line">    .setCaptureRequestOption(CaptureRequest.COLOR_CORRECTION_MODE, CaptureRequest.COLOR_CORRECTION_MODE_TRANSFORM_MATRIX)</span><br><span class="line">    .setCaptureRequestOption(CaptureRequest.COLOR_CORRECTION_GAINS, ColorTemperatureConverter.colorTemperature(<span class="number">2000</span>))</span><br><span class="line">    .build()</span><br></pre></td></tr></table></figure><h2 id="Camera2Interop-Extender"><a href="#Camera2Interop-Extender" class="headerlink" title="Camera2Interop.Extender"></a><a href="https://developer.android.google.cn/reference/androidx/camera/camera2/interop/Camera2Interop.Extender?hl=zh-cn"><code>Camera2Interop.Extender</code></a></h2><p>ä½¿ç”¨ <a href="https://developer.android.google.cn/reference/androidx/camera/camera2/interop/Camera2Interop.Extender?hl=zh-cn"><code>Camera2Interop.Extender</code></a> æ‰©å±• CameraX <a href="https://developer.android.google.cn/reference/androidx/camera/core/UseCase?hl=zh-cn"><code>UseCase</code></a>ã€‚è¿™æ ·æ‚¨å°±å¯ä»¥åœ¨ CaptureRequest ä¸Šè®¾ç½®å±æ€§ï¼Œå°±åƒä½¿ç”¨ <a href="https://developer.android.google.cn/reference/androidx/camera/camera2/interop/Camera2CameraControl?hl=zh-cn"><code>Camera2CameraControl</code></a> ä¸€æ ·ã€‚å®ƒè¿˜æä¾›äº†ä¸€äº›é¢å¤–çš„æ§ä»¶ï¼Œä¾‹å¦‚è®¾ç½®æ•°æ®æµç”¨ä¾‹ä»¥æ ¹æ®æ‚¨çš„ä½¿ç”¨åœºæ™¯ä¼˜åŒ–ç›¸æœºã€‚</p><p>ä»¥ä¸‹ä»£ç ç¤ºä¾‹ä½¿ç”¨æ•°æ®æµç”¨ä¾‹æ¥ä¼˜åŒ–è§†é¢‘é€šè¯ã€‚ä½¿ç”¨ <a href="https://developer.android.google.cn/reference/androidx/camera/camera2/interop/Camera2CameraInfo?hl=zh-cn"><code>Camera2CameraInfo</code></a> å¯æå–è§†é¢‘é€šè¯æµç”¨ä¾‹æ˜¯å¦å¯ç”¨ã€‚ç„¶åï¼Œä½¿ç”¨ <a href="https://developer.android.google.cn/reference/androidx/camera/camera2/interop/Camera2Interop.Extender?hl=zh-cn"><code>Camera2Interop.Extender</code></a> è®¾ç½®åº•å±‚æ•°æ®æµç”¨ä¾‹ã€‚</p><div class="tabs" id="ä»£ç ç¤ºä¾‹"><ul class="nav-tabs"><button type="button" class="tab  active" data-href="ä»£ç ç¤ºä¾‹-1">Kotlin</button><button type="button" class="tab " data-href="ä»£ç ç¤ºä¾‹-2">Java</button></ul><div class="tab-contents"><div class="tab-item-content active" id="ä»£ç ç¤ºä¾‹-1"><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Set underlying Camera2 stream use case to optimize for video calls.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> videoCallStreamId =</span><br><span class="line">    CameraMetadata.SCALER_AVAILABLE_STREAM_USE_CASES_VIDEO_CALL.toLong()</span><br><span class="line"></span><br><span class="line"><span class="comment">// Check available CameraInfos to find the first one that supports</span></span><br><span class="line"><span class="comment">// the video call stream use case.</span></span><br><span class="line"><span class="keyword">val</span> frontCameraInfo = cameraProvider.getAvailableCameraInfos()</span><br><span class="line">    .first &#123; cameraInfo -&gt;</span><br><span class="line">        <span class="keyword">val</span> isVideoCallStreamingSupported = Camera2CameraInfo.from(cameraInfo)</span><br><span class="line">            .getCameraCharacteristic(</span><br><span class="line">                CameraCharacteristics.SCALER_AVAILABLE_STREAM_USE_CASES</span><br><span class="line">            )?.contains(videoCallStreamId)</span><br><span class="line">        <span class="keyword">val</span> isFrontFacing = (cameraInfo.getLensFacing() ==</span><br><span class="line">                             CameraSelector.LENS_FACING_FRONT)</span><br><span class="line">        (isVideoCallStreamingSupported == <span class="literal">true</span>) &amp;&amp; isFrontFacing</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> cameraSelector = frontCameraInfo.cameraSelector</span><br><span class="line"></span><br><span class="line"><span class="comment">// Start with a Preview Builder.</span></span><br><span class="line"><span class="keyword">val</span> previewBuilder = Preview.Builder()</span><br><span class="line">    .setTargetAspectRatio(screenAspectRatio)</span><br><span class="line">    .setTargetRotation(rotation)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Use Camera2Interop.Extender to set the video call stream use case.</span></span><br><span class="line">Camera2Interop.Extender(previewBuilder).setStreamUseCase(videoCallStreamId)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Bind the Preview UseCase and the corresponding CameraSelector.</span></span><br><span class="line"><span class="keyword">val</span> preview = previewBuilder.build()</span><br><span class="line">camera = cameraProvider.bindToLifecycle(<span class="keyword">this</span>, cameraSelector, preview)</span><br></pre></td></tr></table></figure></div><div class="tab-item-content" id="ä»£ç ç¤ºä¾‹-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Set underlying Camera2 stream use case to optimize for video calls.</span></span><br><span class="line"></span><br><span class="line"><span class="type">Long</span> <span class="variable">videoCallStreamId</span> <span class="operator">=</span></span><br><span class="line">    CameraMetadata.SCALER_AVAILABLE_STREAM_USE_CASES_VIDEO_CALL.toLong();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Check available CameraInfos to find the first one that supports</span></span><br><span class="line"><span class="comment">// the video call stream use case.</span></span><br><span class="line">List&lt;CameraInfo&gt; cameraInfos = cameraProvider.getAvailableCameraInfos();</span><br><span class="line"><span class="type">CameraInfo</span> <span class="variable">frontCameraInfo</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">for</span> (cameraInfo in cameraInfos) &#123;</span><br><span class="line">    Long[] availableStreamUseCases = Camera2CameraInfo.from(cameraInfo)</span><br><span class="line">        .getCameraCharacteristic(</span><br><span class="line">            CameraCharacteristics.SCALER_AVAILABLE_STREAM_USE_CASES</span><br><span class="line">        );</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isVideoCallStreamingSupported</span> <span class="operator">=</span> Arrays.List(availableStreamUseCases)</span><br><span class="line">                .contains(videoCallStreamId);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isFrontFacing</span> <span class="operator">=</span> (cameraInfo.getLensFacing() ==</span><br><span class="line">                             CameraSelector.LENS_FACING_FRONT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isVideoCallStreamingSupported &amp;&amp; isFrontFacing) &#123;</span><br><span class="line">        frontCameraInfo = cameraInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (frontCameraInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// Handle case where video call streaming is not supported.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">CameraSelector</span> <span class="variable">cameraSelector</span> <span class="operator">=</span> frontCameraInfo.getCameraSelector();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Start with a Preview Builder.</span></span><br><span class="line">Preview.<span class="type">Builder</span> <span class="variable">previewBuilder</span> <span class="operator">=</span> Preview.Builder()</span><br><span class="line">    .setTargetAspectRatio(screenAspectRatio)</span><br><span class="line">    .setTargetRotation(rotation);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Use Camera2Interop.Extender to set the video call stream use case.</span></span><br><span class="line">Camera2Interop.Extender(previewBuilder).setStreamUseCase(videoCallStreamId);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Bind the Preview UseCase and the corresponding CameraSelector.</span></span><br><span class="line"><span class="type">Preview</span> <span class="variable">preview</span> <span class="operator">=</span> previewBuilder.build()</span><br><span class="line"><span class="type">Camera</span> <span class="variable">camera</span> <span class="operator">=</span> cameraProvider.bindToLifecycle(<span class="built_in">this</span>, cameraSelector, preview)</span><br></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://developer.android.google.cn/training/camerax/architecture">Android CameraX æ¶æ„</a></p>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
          <category> CameraX </category>
          
          <category> Camera2 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> CameraX </tag>
            
            <tag> Jetpack </tag>
            
            <tag> ç›¸æœº </tag>
            
            <tag> Camera2 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android CameraXçš„åŸºæœ¬ä½¿ç”¨</title>
      <link href="/post/ff52020d.html"/>
      <url>/post/ff52020d.html</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>è™½ç„¶ç½‘ä¸Šæœ‰å¾ˆå¤š<code>CameraX</code>çš„æ•™ç¨‹ï¼Œä½†æ˜¯æ¯æ¬¡ç”¨<code>CameraX</code>çš„æ—¶å€™æ€»è¦åœ¨ç¿»ä¸€ç¿»å®˜æ–¹çš„æ–‡æ¡£æˆ–è€…ç½‘ä¸Šçš„æ•™ç¨‹ä¹‹ç±»çš„ï¼Œè¿™æ¬¡å°±è‡ªå·±è®°ä¸€ä¸‹å§ï¼Œç¿»è‡ªå·±çš„æ€»æ¯”ç¿»åˆ«äººçš„å¥½å§ğŸ¤ª</p><h2 id="å£°æ˜ä¾èµ–é¡¹"><a href="#å£°æ˜ä¾èµ–é¡¹" class="headerlink" title="å£°æ˜ä¾èµ–é¡¹"></a>å£°æ˜ä¾èµ–é¡¹</h2><p>è¦æ·»åŠ  CameraX çš„ä¾èµ–é¡¹ï¼Œæ‚¨å¿…é¡»å°† <a href="https://developer.android.google.cn/studio/build/dependencies?hl=zh-cn#google-maven">Google Maven ä»£ç åº“</a>æ·»åŠ åˆ°é¡¹ç›®ä¸­ã€‚</p><p>æ‰“å¼€é¡¹ç›®çš„ <code>settings.gradle</code> æ–‡ä»¶å¹¶æ·»åŠ  <code>google()</code> ä»£ç åº“ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class="tabs" id="æ·»åŠ -`google()`"><ul class="nav-tabs"><button type="button" class="tab  active" data-href="æ·»åŠ -`google()`-1">Groovy</button><button type="button" class="tab " data-href="æ·»åŠ -`google()`-2">Kotlin</button></ul><div class="tab-contents"><div class="tab-item-content active" id="æ·»åŠ -`google()`-1"><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dependencyResolutionManagement &#123;</span><br><span class="line">    repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)</span><br><span class="line">    repositories &#123;</span><br><span class="line">        google()</span><br><span class="line">        mavenCentral()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="tab-item-content" id="æ·»åŠ -`google()`-2"><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dependencyResolutionManagement &#123;</span><br><span class="line">    repositoriesMode.<span class="keyword">set</span>(RepositoriesMode.FAIL_ON_PROJECT_REPOS)</span><br><span class="line">    repositories &#123;</span><br><span class="line">        google()</span><br><span class="line">        mavenCentral()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div><p>å°†ä»¥ä¸‹å†…å®¹æ·»åŠ åˆ° Android ä»£ç å—çš„æœ«å°¾ï¼š</p><div class="tabs" id="æ·»åŠ -jvmtarget"><ul class="nav-tabs"><button type="button" class="tab  active" data-href="æ·»åŠ -jvmtarget-1">Groovy</button><button type="button" class="tab " data-href="æ·»åŠ -jvmtarget-2">Kotlin</button></ul><div class="tab-contents"><div class="tab-item-content active" id="æ·»åŠ -jvmtarget-1"><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    compileOptions &#123;</span><br><span class="line">        sourceCompatibility JavaVersion.VERSION_1_8</span><br><span class="line">        targetCompatibility JavaVersion.VERSION_1_8</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// For Kotlin projects</span></span><br><span class="line">    kotlinOptions &#123;</span><br><span class="line">        jvmTarget = <span class="string">&quot;1.8&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="tab-item-content" id="æ·»åŠ -jvmtarget-2"><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    compileOptions &#123;</span><br><span class="line">        sourceCompatibility = JavaVersion.VERSION_1_8</span><br><span class="line">        targetCompatibility = JavaVersion.VERSION_1_8</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// For Kotlin projects</span></span><br><span class="line">    kotlinOptions &#123;</span><br><span class="line">        jvmTarget = <span class="string">&quot;1.8&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div><p>å°†ä»¥ä¸‹å†…å®¹æ·»åŠ åˆ°åº”ç”¨çš„æ¯ä¸ªæ¨¡å—çš„ <code>build.gradle</code> æ–‡ä»¶ä¸­ï¼š</p><div class="tabs" id="æ·»åŠ -`build.gradle`"><ul class="nav-tabs"><button type="button" class="tab  active" data-href="æ·»åŠ -`build.gradle`-1">Groovy</button><button type="button" class="tab " data-href="æ·»åŠ -`build.gradle`-2">Kotlin</button></ul><div class="tab-contents"><div class="tab-item-content active" id="æ·»åŠ -`build.gradle`-1"><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">  <span class="comment">// CameraXæ ¸å¿ƒåº“ä½¿ç”¨camera2å®ç°</span></span><br><span class="line">  <span class="keyword">def</span> camerax_version = <span class="string">&quot;1.2.3&quot;</span></span><br><span class="line">  <span class="comment">// ä»¥ä¸‹è¡Œæ˜¯å¯é€‰çš„ï¼Œå› ä¸ºæ ¸å¿ƒåº“æ˜¯ç”±camera-camera2é—´æ¥åŒ…å«çš„</span></span><br><span class="line">  implementation <span class="string">&quot;androidx.camera:camera-core:$&#123;camerax_version&#125;&quot;</span></span><br><span class="line">  implementation <span class="string">&quot;androidx.camera:camera-camera2:$&#123;camerax_version&#125;&quot;</span></span><br><span class="line">  <span class="comment">// å¦‚æœæ‚¨æƒ³å¦å¤–ä½¿ç”¨ CameraX Lifecycle åº“</span></span><br><span class="line">  implementation <span class="string">&quot;androidx.camera:camera-lifecycle:$&#123;camerax_version&#125;&quot;</span></span><br><span class="line">  <span class="comment">// å¦‚æœæ‚¨æƒ³å¦å¤–ä½¿ç”¨ CameraX VideoCapture åº“</span></span><br><span class="line">  implementation <span class="string">&quot;androidx.camera:camera-video:$&#123;camerax_version&#125;&quot;</span></span><br><span class="line">  <span class="comment">// å¦‚æœæ‚¨æƒ³å¦å¤–ä½¿ç”¨ CameraX View ç±»</span></span><br><span class="line">  implementation <span class="string">&quot;androidx.camera:camera-view:$&#123;camerax_version&#125;&quot;</span></span><br><span class="line">  <span class="comment">// å¦‚æœæ‚¨æƒ³å¦å¤–æ·»åŠ  CameraX ML Kit Vision Integration</span></span><br><span class="line">  implementation <span class="string">&quot;androidx.camera:camera-mlkit-vision:$&#123;camerax_version&#125;&quot;</span></span><br><span class="line">  <span class="comment">// å¦‚æœæ‚¨æƒ³å¦å¤–ä½¿ç”¨ CameraX Extensions åº“</span></span><br><span class="line">  implementation <span class="string">&quot;androidx.camera:camera-extensions:$&#123;camerax_version&#125;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="tab-item-content" id="æ·»åŠ -`build.gradle`-2"><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    <span class="comment">// CameraXæ ¸å¿ƒåº“ä½¿ç”¨camera2å®ç°</span></span><br><span class="line">    <span class="keyword">val</span> camerax_version = <span class="string">&quot;1.2.3&quot;</span></span><br><span class="line">    <span class="comment">// ä»¥ä¸‹è¡Œæ˜¯å¯é€‰çš„ï¼Œå› ä¸ºæ ¸å¿ƒåº“æ˜¯ç”±camera-camera2é—´æ¥åŒ…å«çš„</span></span><br><span class="line">    implementation(<span class="string">&quot;androidx.camera:camera-core:<span class="subst">$&#123;camerax_version&#125;</span>&quot;</span>)</span><br><span class="line">    implementation(<span class="string">&quot;androidx.camera:camera-camera2:<span class="subst">$&#123;camerax_version&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="comment">// å¦‚æœæ‚¨æƒ³å¦å¤–ä½¿ç”¨ CameraX Lifecycle åº“</span></span><br><span class="line">    implementation(<span class="string">&quot;androidx.camera:camera-lifecycle:<span class="subst">$&#123;camerax_version&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="comment">// å¦‚æœæ‚¨æƒ³å¦å¤–ä½¿ç”¨ CameraX VideoCapture åº“</span></span><br><span class="line">    implementation(<span class="string">&quot;androidx.camera:camera-video:<span class="subst">$&#123;camerax_version&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="comment">// å¦‚æœæ‚¨æƒ³å¦å¤–ä½¿ç”¨ CameraX View ç±»</span></span><br><span class="line">    implementation(<span class="string">&quot;androidx.camera:camera-view:<span class="subst">$&#123;camerax_version&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="comment">// å¦‚æœæ‚¨æƒ³å¦å¤–æ·»åŠ  CameraX ML Kit Vision Integration</span></span><br><span class="line">    implementation(<span class="string">&quot;androidx.camera:camera-mlkit-vision:<span class="subst">$&#123;camerax_version&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="comment">// å¦‚æœæ‚¨æƒ³å¦å¤–ä½¿ç”¨ CameraX Extensions åº“</span></span><br><span class="line">    implementation(<span class="string">&quot;androidx.camera:camera-extensions:<span class="subst">$&#123;camerax_version&#125;</span>&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div><p>å¦‚éœ€è¯¦ç»†äº†è§£å¦‚ä½•é…ç½®åº”ç”¨ä»¥æ»¡è¶³ä¸Šè¿°è¦æ±‚æˆ–æŸ¥çœ‹CameraXæœ€æ–°ç‰ˆæœ¬å·ï¼Œè¯·å‚é˜…<a href="https://developer.android.google.cn/jetpack/androidx/releases/camera">å£°æ˜ä¾èµ–é¡¹</a>ã€‚</p><h2 id="å®ç°é¢„è§ˆ"><a href="#å®ç°é¢„è§ˆ" class="headerlink" title="å®ç°é¢„è§ˆ"></a>å®ç°é¢„è§ˆ</h2><p>åœ¨å‘åº”ç”¨æ·»åŠ é¢„è§ˆæ—¶ï¼Œè¯·ä½¿ç”¨ <a href="https://developer.android.google.cn/reference/kotlin/androidx/camera/view/PreviewView?hl=zh-cn"><code>PreviewView</code></a>ï¼Œè¿™æ˜¯ä¸€ç§å¯ä»¥å‰ªè£ã€ç¼©æ”¾å’Œæ—‹è½¬ä»¥ç¡®ä¿æ­£ç¡®æ˜¾ç¤ºçš„ <code>View</code>ã€‚</p><p>å½“ç›¸æœºå¤„äºæ´»åŠ¨çŠ¶æ€æ—¶ï¼Œå›¾ç‰‡é¢„è§ˆä¼šæµå¼ä¼ è¾“åˆ° <code>PreviewView</code> ä¸­çš„ Surfaceã€‚</p><h3 id="å°†-PreviewView-æ·»åŠ åˆ°å¸ƒå±€"><a href="#å°†-PreviewView-æ·»åŠ åˆ°å¸ƒå±€" class="headerlink" title="å°† PreviewView æ·»åŠ åˆ°å¸ƒå±€"></a>å°† PreviewView æ·»åŠ åˆ°å¸ƒå±€</h3><p>ä»¥ä¸‹ç¤ºä¾‹æ˜¾ç¤ºäº†å¸ƒå±€ä¸­çš„ <code>PreviewView</code>ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">FrameLayout</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">&quot;@+id/container&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">androidx.camera.view.PreviewView</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">&quot;@+id/previewView&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">FrameLayout</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="åˆå§‹åŒ–ç›¸æœº"><a href="#åˆå§‹åŒ–ç›¸æœº" class="headerlink" title="åˆå§‹åŒ–ç›¸æœº"></a>åˆå§‹åŒ–ç›¸æœº</h3><p>ä»¥ä¸‹ä»£ç å±•ç¤ºäº†å¦‚ä½•åˆå§‹åŒ–é¢„è§ˆéœ€è¦ <code>CameraProvider</code>ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> androidx.camera.lifecycle.ProcessCameraProvider</span><br><span class="line"><span class="keyword">import</span> com.google.common.util.concurrent.ListenableFuture</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CameraActivity</span> : <span class="type">AppCompatActivity</span>() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> cameraProviderFuture : ListenableFuture&lt;ProcessCameraProvider&gt;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> cameraProvider: ProcessCameraProvider? = <span class="literal">null</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆå§‹åŒ–ç›¸æœºï¼Œå¯åœ¨onCreate()å†…è°ƒç”¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">initCamera</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// æ£€æŸ¥æƒé™</span></span><br><span class="line">      checkPermission() &#123;</span><br><span class="line">          cameraProviderFuture = ProcessCameraProvider.getInstance(<span class="keyword">this</span>)</span><br><span class="line">          cameraProviderFuture.addListener(&#123;</span><br><span class="line">                cameraProvider = cameraProviderFuture.<span class="keyword">get</span>()</span><br><span class="line">            <span class="comment">// æ£€æŸ¥æ‘„åƒå¤´</span></span><br><span class="line">                lensFacing = <span class="keyword">when</span> &#123;</span><br><span class="line">                    hasBackCamera() -&gt; CameraSelector.LENS_FACING_BACK</span><br><span class="line">                    hasFrontCamera() -&gt; CameraSelector.LENS_FACING_FRONT</span><br><span class="line">                    <span class="keyword">else</span> -&gt; &#123;</span><br><span class="line">                        toast(<span class="string">&quot;å‰åæ‘„åƒå¤´ä¸å¯ç”¨&quot;</span>)</span><br><span class="line">                        <span class="keyword">return</span><span class="symbol">@addListener</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="comment">// (å¯å¿½ç•¥) å°†PreviewViewçš„é¢„è§ˆViewæ”¹ä¸ºTextureView</span></span><br><span class="line">                binding.previewView.implementationMode = PreviewView.ImplementationMode.COMPATIBLE</span><br><span class="line">                <span class="comment">// ç»‘å®šç›¸æœº</span></span><br><span class="line">                bindPreview(cameraProvider ?: <span class="keyword">return</span><span class="symbol">@addListener</span>)</span><br><span class="line">            &#125;, ContextCompat.getMainExecutor(requireContext()))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ£€æŸ¥æ‘„åƒå¤´"><a href="#æ£€æŸ¥æ‘„åƒå¤´" class="headerlink" title="æ£€æŸ¥æ‘„åƒå¤´"></a>æ£€æŸ¥æ‘„åƒå¤´</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** å¦‚æœè®¾å¤‡æœ‰å¯ç”¨çš„åç½®æ‘„åƒå¤´ï¼Œåˆ™è¿”å› trueã€‚å¦åˆ™ä¸ºå‡ */</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">hasBackCamera</span><span class="params">()</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> cameraProvider?.hasCamera(CameraSelector.DEFAULT_BACK_CAMERA) ?: <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** å¦‚æœè®¾å¤‡æœ‰å¯ç”¨çš„å‰ç½®æ‘„åƒå¤´ï¼Œåˆ™è¿”å› trueã€‚å¦åˆ™ä¸ºå‡ */</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">hasFrontCamera</span><span class="params">()</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> cameraProvider?.hasCamera(CameraSelector.DEFAULT_FRONT_CAMERA) ?: <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç»‘å®šç›¸æœº"><a href="#ç»‘å®šç›¸æœº" class="headerlink" title="ç»‘å®šç›¸æœº"></a>ç»‘å®šç›¸æœº</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Camera</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> camera: Camera? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºPreview</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> preview <span class="keyword">by</span> lazy &#123;</span><br><span class="line">Preview.Builder().build()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å½“å‰æ‘„åƒå¤´</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> lensFacing: <span class="built_in">Int</span> = CameraSelector.LENS_FACING_BACK</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç»‘å®šç›¸æœº</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">bindPreview</span><span class="params">(cameraProvider: <span class="type">ProcessCameraProvider</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">// é€‰æ‹©æ‘„åƒå¤´</span></span><br><span class="line"><span class="keyword">val</span> cameraSelector = CameraSelector.Builder().requireLensFacing(lensFacing).build()</span><br><span class="line"><span class="comment">// è§£é™¤æ‰€æœ‰ç»‘å®š</span></span><br><span class="line">cameraProvider.unbindAll()</span><br><span class="line"><span class="comment">// å°†æ‰€é€‰ç›¸æœºå’Œä»»æ„ç”¨ä¾‹ç»‘å®šåˆ°ç”Ÿå‘½å‘¨æœŸ</span></span><br><span class="line">camera = cameraProvider.bindToLifecycle(<span class="keyword">this</span>, cameraSelector, preview)</span><br><span class="line"><span class="comment">// å°† Preview è¿æ¥åˆ° PreviewView</span></span><br><span class="line">preview.setSurfaceProvider(binding.previewView.surfaceProvider)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯·æ³¨æ„ï¼Œ<a href="https://developer.android.google.cn/reference/androidx/camera/lifecycle/ProcessCameraProvider#bindToLifecycle(androidx.lifecycle.LifecycleOwner,%20androidx.camera.core.CameraSelector,%20androidx.camera.core.UseCase...)"><code>bindToLifecycle()</code></a> ä¼šè¿”å›ä¸€ä¸ª <a href="https://developer.android.google.cn/reference/androidx/camera/core/Camera?hl=zh-cn"><code>Camera</code></a> å¯¹è±¡ã€‚å¦‚éœ€è¯¦ç»†äº†è§£å¦‚ä½•æ§åˆ¶ç›¸æœºè¾“å‡ºï¼ˆä¾‹å¦‚å˜ç„¦å’Œæ›å…‰ï¼‰ï¼Œè¯·å‚é˜…<a href="https://developer.android.google.cn/training/camerax/configuration?hl=zh-cn#camera-output">ç›¸æœºè¾“å‡º</a>ã€‚</p><h2 id="å›¾ç‰‡æ‹æ‘„"><a href="#å›¾ç‰‡æ‹æ‘„" class="headerlink" title="å›¾ç‰‡æ‹æ‘„"></a>å›¾ç‰‡æ‹æ‘„</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> imageCapture <span class="keyword">by</span> lazy &#123;</span><br><span class="line">ImageCapture.Builder().setCaptureMode(ImageCapture.CAPTURE_MODE_MAXIMIZE_QUALITY)</span><br><span class="line">.setTargetAspectRatio(AspectRatio.RATIO_4_3).build()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ–¹å‘</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> orientationEventListener: OrientationEventListener? = <span class="literal">null</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åœ¨<code>cameraProviderFuture.addListener</code>å†…éƒ¨æ·»åŠ  è°ƒç”¨<code>bindPreview() </code>æ–¹æ³•ä¹‹å‰</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">orientationEventListener = <span class="keyword">object</span> : OrientationEventListener(<span class="keyword">this</span>) &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onOrientationChanged</span><span class="params">(orientation: <span class="type">Int</span>)</span></span> &#123; <span class="comment">// Monitors orientation values to determine the target rotation value</span></span><br><span class="line">        <span class="keyword">val</span> rotation = <span class="keyword">when</span> (orientation) &#123;</span><br><span class="line">            <span class="keyword">in</span> <span class="number">45.</span><span class="number">.134</span> -&gt; Surface.ROTATION_270</span><br><span class="line">            <span class="keyword">in</span> <span class="number">135.</span><span class="number">.224</span> -&gt; Surface.ROTATION_180</span><br><span class="line">            <span class="keyword">in</span> <span class="number">225.</span><span class="number">.314</span> -&gt; Surface.ROTATION_90</span><br><span class="line">            <span class="keyword">else</span> -&gt; Surface.ROTATION_0</span><br><span class="line">        &#125;</span><br><span class="line">        imageCapture.targetRotation = rotation</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨bindPreview()æ–¹æ³•å†…å¯ç”¨<br><code>orientationEventListener?.enable()</code></p><p>åŠæ—¶æš‚åœ</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onPause</span><span class="params">()</span></span> &#123;</span><br><span class="line">    orientationEventListener?.disable()</span><br><span class="line">    <span class="keyword">super</span>.onPause()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>bindToLifecycle</code>å†…åŠ å…¥<code>UseCase</code></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">camera = cameraProvider.bindToLifecycle(viewLifecycleOwner, cameraSelector, preview, imageCapture)</span><br></pre></td></tr></table></figure><p>æ‹ç…§</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ‹ç…§</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressLint(<span class="string">&quot;RestrictedApi&quot;</span>)</span></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">takePicture</span><span class="params">(save: (<span class="type">uri</span>: <span class="type">Uri</span>?) -&gt; <span class="type">Unit</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">// å­˜å‚¨ç…§ç‰‡çš„è·¯å¾„</span></span><br><span class="line">    <span class="keyword">val</span> dir = File(ConfigConstant.PATH)</span><br><span class="line">    <span class="keyword">if</span> (!dir.exists()) dir.mkdirs()</span><br><span class="line">    <span class="keyword">val</span> srcFile = File(dir, ConfigConstant.BITMAP_NAME)</span><br><span class="line">    <span class="keyword">val</span> outputFileOptions = ImageCapture.OutputFileOptions.Builder(srcFile).build()</span><br><span class="line">    imageCapture.takePicture(outputFileOptions, cameraExecutor, <span class="keyword">object</span> : ImageCapture.OnImageSavedCallback &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onImageSaved</span><span class="params">(outputFileResults: <span class="type">ImageCapture</span>.<span class="type">OutputFileResults</span>)</span></span> &#123;</span><br><span class="line">            save(outputFileResults?.savedUri)</span><br><span class="line">            <span class="comment">// outputFileResultså¯ä»¥æ‹¿åˆ°å›¾ç‰‡çš„Uri</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onError</span><span class="params">(exception: <span class="type">ImageCaptureException</span>)</span></span> &#123;</span><br><span class="line">            save(<span class="literal">null</span>)</span><br><span class="line">            toast(<span class="string">&quot;æ‹ç…§å¼‚å¸¸&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡ŒåŸºæœ¬ä¸Šå°±èƒ½å®ç°æ­£å¸¸çš„æ‹æ‘„ï¼Œå†æ¥ä»‹ç»ä¸€äº›å°åŠŸèƒ½å§</p><h2 id="éƒ¨åˆ†åŠŸèƒ½"><a href="#éƒ¨åˆ†åŠŸèƒ½" class="headerlink" title="éƒ¨åˆ†åŠŸèƒ½"></a>éƒ¨åˆ†åŠŸèƒ½</h2><h3 id="åˆ‡æ¢æ‘„åƒå¤´"><a href="#åˆ‡æ¢æ‘„åƒå¤´" class="headerlink" title="åˆ‡æ¢æ‘„åƒå¤´"></a>åˆ‡æ¢æ‘„åƒå¤´</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ‡æ¢æ‘„åƒå¤´</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">switchCamera</span><span class="params">()</span></span> &#123;</span><br><span class="line">    orientationEventListener?.disable()</span><br><span class="line">    lensFacing = <span class="keyword">if</span> (CameraSelector.LENS_FACING_FRONT == lensFacing) &#123;</span><br><span class="line">        CameraSelector.LENS_FACING_BACK</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        CameraSelector.LENS_FACING_FRONT</span><br><span class="line">    &#125;</span><br><span class="line">    bindPreview(cameraProvider ?: <span class="keyword">return</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ‰‹ç”µç­’"><a href="#æ‰‹ç”µç­’" class="headerlink" title="æ‰‹ç”µç­’"></a>æ‰‹ç”µç­’</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ‡æ¢æ‰‹ç”µç­’,å¯èƒ½æ‰“å¼€å¤±è´¥</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">flashlight</span><span class="params">()</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">    camera?.let &#123;</span><br><span class="line">        <span class="keyword">val</span> mode = <span class="keyword">if</span> (imageCapture.flashMode == ImageCapture.FLASH_MODE_OFF) ImageCapture.FLASH_MODE_ON</span><br><span class="line">        <span class="keyword">else</span> ImageCapture.FLASH_MODE_OFF</span><br><span class="line">        imageCapture.flashMode = mode</span><br><span class="line">        <span class="keyword">return</span> imageCapture.flashMode == ImageCapture.FLASH_MODE_ON</span><br><span class="line">    &#125; ?: toast(<span class="string">&quot;é—ªå…‰ç¯å¼€å¯å¤±è´¥,è¯·æ£€æŸ¥ç›¸æœºèƒ½å¦æ­£å¸¸ä½¿ç”¨&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ›å…‰è¡¥å¿"><a href="#æ›å…‰è¡¥å¿" class="headerlink" title="æ›å…‰è¡¥å¿"></a>æ›å…‰è¡¥å¿</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è®¾ç½®æ›å…‰è¡¥å¿, å¯èƒ½è®¾ç½®å¤±è´¥</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">setExposureCompensationIndex</span><span class="params">(value: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    camera?.let &#123; camera -&gt;</span><br><span class="line">        <span class="keyword">val</span> cameraInfo = camera.cameraInfo</span><br><span class="line">        <span class="keyword">if</span> (cameraInfo.exposureState.exposureCompensationRange.upper == <span class="number">0</span> &amp;&amp; cameraInfo.exposureState.exposureCompensationRange.lower == <span class="number">0</span>) &#123;</span><br><span class="line">            toast(<span class="string">&quot;å½“å‰è®¾å¤‡ä¸æ”¯æŒè®¾ç½®æ›å…‰è¡¥å¿&quot;</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cameraInfo.exposureState.exposureCompensationRange.contains(value)) &#123;</span><br><span class="line">            <span class="keyword">val</span> index = (value / camera.cameraInfo.exposureState.exposureCompensationStep.toFloat()).roundToInt()</span><br><span class="line">            camera.cameraControl.setExposureCompensationIndex(index)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; ?: toast(<span class="string">&quot;è®¾ç½®æ›å…‰è¡¥å¿å¤±è´¥,è¯·æ£€æŸ¥ç›¸æœºèƒ½å¦æ­£å¸¸ä½¿ç”¨&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢çš„å†…å®¹æ¥æºäº<a href="https://developer.android.google.cn/training/camerax">Androidå®˜ç½‘æ–‡æ¡£</a></p><h2 id="PreviewView-çš„å…¶ä»–API"><a href="#PreviewView-çš„å…¶ä»–API" class="headerlink" title="PreviewView çš„å…¶ä»–API"></a>PreviewView çš„å…¶ä»–API</h2><p>CameraX <code>PreviewView</code> æä¾›äº†ä¸€äº›å…¶ä»– API æ¥ç”¨äºé…ç½®å±æ€§ï¼Œä¾‹å¦‚ï¼š</p><ul><li>ç”¨äºæ¸²æŸ“é¢„è§ˆæµçš„<a href="https://developer.android.google.cn/reference/androidx/camera/view/PreviewView.ImplementationMode?hl=zh-cn">å®ç°æ¨¡å¼</a>ã€‚</li><li>é¢„è§ˆå›¾ç‰‡çš„<a href="https://developer.android.google.cn/reference/androidx/camera/view/PreviewView.ScaleType?hl=zh-cn">ç¼©æ”¾ç±»å‹</a>ã€‚</li></ul><h3 id="å®ç°æ¨¡å¼"><a href="#å®ç°æ¨¡å¼" class="headerlink" title="å®ç°æ¨¡å¼"></a>å®ç°æ¨¡å¼</h3><p><code>PreviewView</code> å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ¨¡å¼ä¹‹ä¸€å°†é¢„è§ˆæµæ¸²æŸ“åˆ°ç›®æ ‡ <code>View</code> ä¸Šï¼š</p><ul><li><a href="https://developer.android.google.cn/reference/androidx/camera/view/PreviewView.ImplementationMode?hl=zh-cn#PERFORMANCE"><code>PERFORMANCE</code></a> æ˜¯é»˜è®¤æ¨¡å¼ã€‚<code>PreviewView</code> ä¼šä½¿ç”¨ <a href="https://developer.android.google.cn/reference/android/view/SurfaceView?hl=zh-cn"><code>SurfaceView</code></a> æ˜¾ç¤ºè§†é¢‘ä¸²æµï¼Œä½†åœ¨<a href="https://developer.android.google.cn/reference/androidx/camera/view/PreviewView.ImplementationMode?hl=zh-cn#PERFORMANCE">æŸäº›æƒ…å†µä¸‹</a>ä¼šå›é€€ä¸ºä½¿ç”¨ <a href="https://developer.android.google.cn/reference/android/view/TextureView?hl=zh-cn"><code>TextureView</code></a>ã€‚<code>SurfaceView</code> å…·æœ‰ä¸“ç”¨çš„ç»˜å›¾ç•Œé¢ï¼Œè¯¥å¯¹è±¡æ›´æœ‰å¯èƒ½é€šè¿‡<a href="https://source.android.google.cn/devices/graphics/hwc?hl=zh-cn">å†…éƒ¨ç¡¬ä»¶åˆæˆå™¨</a>å®ç°ç¡¬ä»¶å åŠ å±‚ï¼Œå°¤å…¶æ˜¯å½“é¢„è§ˆè§†é¢‘ä¸Šé¢æ²¡æœ‰å…¶ä»–ç•Œé¢å…ƒç´ ï¼ˆå¦‚æŒ‰é’®ï¼‰æ—¶ã€‚é€šè¿‡ä½¿ç”¨ç¡¬ä»¶å åŠ å±‚è¿›è¡Œæ¸²æŸ“ï¼Œè§†é¢‘å¸§ä¼šé¿å¼€ GPU è·¯å¾„ï¼Œä»è€Œèƒ½é™ä½å¹³å°åŠŸè€—å¹¶ç¼©çŸ­å»¶è¿Ÿæ—¶é—´ã€‚</li><li><a href="https://developer.android.google.cn/reference/androidx/camera/view/PreviewView.ImplementationMode?hl=zh-cn#COMPATIBLE"><code>COMPATIBLE</code></a> æ¨¡å¼ã€‚åœ¨æ­¤æ¨¡å¼ä¸‹ï¼Œ<code>PreviewView</code> ä¼šä½¿ç”¨ <code>TextureView</code>ï¼›ä¸åŒäº <code>SurfaceView</code>ï¼Œè¯¥å¯¹è±¡æ²¡æœ‰ä¸“ç”¨çš„ç»˜å›¾è¡¨é¢ã€‚å› æ­¤ï¼Œè§†é¢‘è¦é€šè¿‡æ··åˆæ¸²æŸ“ï¼Œæ‰èƒ½æ˜¾ç¤ºã€‚åœ¨è¿™ä¸ªé¢å¤–çš„æ­¥éª¤ä¸­ï¼Œåº”ç”¨å¯ä»¥æ‰§è¡Œé¢å¤–çš„å¤„ç†å·¥ä½œï¼Œä¾‹å¦‚ä¸å—é™åˆ¶åœ°ç¼©æ”¾å’Œæ—‹è½¬è§†é¢‘ã€‚</li></ul><p>æ‚¨å¯ä»¥ä½¿ç”¨ <a href="https://developer.android.google.cn/reference/androidx/camera/view/PreviewView?hl=zh-cn#setImplementationMode(androidx.camera.view.PreviewView.ImplementationMode)"><code>PreviewView.setImplementationMode()</code></a> é€‰æ‹©é€‚åˆå…·ä½“åº”ç”¨çš„å®ç°æ¨¡å¼ã€‚å¦‚æœé»˜è®¤çš„ <code>PERFORMANCE</code> æ¨¡å¼ä¸é€‚åˆæ‚¨çš„åº”ç”¨ï¼Œè¯·å‚é˜…ä»¥ä¸‹ä»£ç ç¤ºä¾‹ï¼Œäº†è§£å¦‚ä½•è®¾ç½® <code>COMPATIBLE</code> æ¨¡å¼ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// viewFinder æ˜¯ä¸€ä¸ª PreviewView å®ä¾‹</span></span><br><span class="line">viewFinder.implementationMode = PreviewView.ImplementationMode.COMPATIBLE</span><br></pre></td></tr></table></figure><h3 id="ç¼©æ”¾ç±»å‹"><a href="#ç¼©æ”¾ç±»å‹" class="headerlink" title="ç¼©æ”¾ç±»å‹"></a>ç¼©æ”¾ç±»å‹</h3><p>å½“é¢„è§ˆè§†é¢‘åˆ†è¾¨ç‡ä¸ç›®æ ‡ <code>PreviewView</code> çš„å°ºå¯¸ä¸åŒæ—¶ï¼Œè§†é¢‘å†…å®¹éœ€è¦é€šè¿‡å‰ªè£æ“ä½œæˆ–æ·»åŠ é®å¹…å¼é»‘è¾¹æ¥é€‚åº”è§†å›¾ï¼ˆä¿æŒåŸå§‹å®½é«˜æ¯”ï¼‰ã€‚ä¸ºæ­¤ï¼Œ<code>PreviewView</code> æä¾›äº†ä»¥ä¸‹ <a href="https://developer.android.google.cn/reference/androidx/camera/view/PreviewView.ScaleType?hl=zh-cn"><code>ScaleTypes</code></a>ï¼š</p><ul><li><a href="https://developer.android.google.cn/reference/androidx/camera/view/PreviewView.ScaleType?hl=zh-cn#FIT_CENTER"><code>FIT_CENTER</code></a>ã€<a href="https://developer.android.google.cn/reference/androidx/camera/view/PreviewView.ScaleType?hl=zh-cn#FIT_START"><code>FIT_START</code></a> å’Œ <a href="https://developer.android.google.cn/reference/androidx/camera/view/PreviewView.ScaleType?hl=zh-cn#FIT_END"><code>FIT_END</code></a>ï¼Œç”¨äºæ·»åŠ é®å¹…å¼é»‘è¾¹ã€‚æ•´ä¸ªè§†é¢‘å†…å®¹ä¼šè°ƒæ•´ï¼ˆæ”¾å¤§æˆ–ç¼©å°ï¼‰ä¸ºå¯åœ¨ç›®æ ‡ <code>PreviewView</code> ä¸­æ˜¾ç¤ºçš„æœ€å¤§å°ºå¯¸ã€‚ä¸è¿‡ï¼Œè™½ç„¶æ•´ä¸ªè§†é¢‘å¸§ä¼šå®Œæ•´æ˜¾ç¤ºï¼Œä½†å±å¹•ç”»é¢ä¸­å¯èƒ½ä¼šå‡ºç°ç©ºç™½éƒ¨åˆ†ã€‚è§†é¢‘å¸§ä¼šä¸ç›®æ ‡è§†å›¾çš„ä¸­å¿ƒã€èµ·å§‹æˆ–ç»“æŸä½ç½®å¯¹é½ï¼Œå…·ä½“å–å†³äºæ‚¨åœ¨ä¸Šè¿°ä¸‰ç§ç¼©æ”¾ç±»å‹ä¸­é€‰æ‹©äº†å“ªä¸€ç§ã€‚</li><li><a href="https://developer.android.google.cn/reference/androidx/camera/view/PreviewView.ScaleType?hl=zh-cn#FILL_CENTER"><code>FILL_CENTER</code></a>ã€<a href="https://developer.android.google.cn/reference/androidx/camera/view/PreviewView.ScaleType?hl=zh-cn#FILL_START"><code>FILL_START</code></a> å’Œ <a href="https://developer.android.google.cn/reference/androidx/camera/view/PreviewView.ScaleType?hl=zh-cn#FILL_END"><code>FILL_END</code></a>ï¼Œç”¨äºè¿›è¡Œå‰ªè£ã€‚å¦‚æœè§†é¢‘çš„å®½é«˜æ¯”ä¸ <code>PreviewView</code> ä¸åŒ¹é…ï¼Œç”»é¢ä¸­åªä¼šæ˜¾ç¤ºéƒ¨åˆ†å†…å®¹ï¼Œä½†è§†é¢‘ä»ä¼šå¡«æ»¡æ•´ä¸ª <code>PreviewView</code>ã€‚</li></ul><p>CameraX ä½¿ç”¨çš„é»˜è®¤ç¼©æ”¾ç±»å‹æ˜¯ <code>FILL_CENTER</code>ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ <a href="https://developer.android.google.cn/reference/androidx/camera/view/PreviewView?hl=zh-cn#setScaleType(androidx.camera.view.PreviewView.ScaleType)"><code>PreviewView.setScaleType()</code></a> è®¾ç½®æœ€é€‚åˆå…·ä½“åº”ç”¨çš„ç¼©æ”¾ç±»å‹ã€‚ä¸‹é¢çš„ä»£ç ç¤ºä¾‹è®¾ç½®äº† <code>FIT_CENTER</code> ç¼©æ”¾ç±»å‹ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// viewFinder æ˜¯ä¸€ä¸ª PreviewView å®ä¾‹</span></span><br><span class="line">viewFinder.scaleType = PreviewView.ScaleType.FIT_CENTER</span><br></pre></td></tr></table></figure><p>è§†é¢‘æ˜¾ç¤ºè¿‡ç¨‹åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ï¼š</p><ol><li>ç¼©æ”¾è§†é¢‘ï¼š<ul><li>å¦‚æœæ‚¨é€‰æ‹©çš„ç¼©æ”¾ç±»å‹æ˜¯ <code>FIT_*</code>ï¼Œè¯·ä½¿ç”¨ <code>min(dst.width/src.width, dst.height/src.height)</code> ç¼©æ”¾è§†é¢‘ã€‚</li><li>å¦‚æœæ‚¨é€‰æ‹©çš„ç¼©æ”¾ç±»å‹æ˜¯ <code>FILL_*</code>ï¼Œè¯·ä½¿ç”¨ <code>max(dst.width/src.width, dst.height/src.height)</code> ç¼©æ”¾è§†é¢‘ã€‚</li></ul></li><li>å°†ç»è¿‡ç¼©æ”¾çš„è§†é¢‘ä¸ç›®æ ‡PreviewViewå¯¹é½ï¼š<ul><li>å¯¹äº <code>FIT_CENTER/FILL_CENTER</code>ï¼Œè¯·å°†ç»è¿‡ç¼©æ”¾çš„è§†é¢‘ä¸ç›®æ ‡ <code>PreviewView</code> å±…ä¸­å¯¹é½ã€‚</li><li>å¯¹äº <code>FIT_START/FILL_START</code>ï¼Œè¯·ä»¥æ¯ä¸ªè§†é¢‘çš„å·¦ä¸Šè§’ä¸ºå‡†ï¼Œå°†ç»è¿‡ç¼©æ”¾çš„è§†é¢‘ä¸ç›®æ ‡ <code>PreviewView</code> å¯¹é½ã€‚</li><li>å¯¹äº <code>FIT_END/FILL_END</code>ï¼Œè¯·ä»¥æ¯ä¸ªè§†é¢‘çš„å³ä¸‹è§’ä¸ºå‡†ï¼Œå°†ç»è¿‡ç¼©æ”¾çš„è§†é¢‘ä¸ç›®æ ‡ <code>PreviewView</code> å¯¹é½ã€‚</li></ul></li></ol><h2 id="é…ç½®é€‰é¡¹"><a href="#é…ç½®é€‰é¡¹" class="headerlink" title="é…ç½®é€‰é¡¹"></a>é…ç½®é€‰é¡¹</h2><p>æ‚¨å¯ä»¥é…ç½®æ¯ä¸ª CameraX ç”¨ä¾‹ï¼Œä»¥æ§åˆ¶ç”¨ä¾‹æ“ä½œçš„ä¸åŒæ–¹é¢ã€‚</p><p>ä¾‹å¦‚ï¼Œå¯¹äºå›¾ç‰‡æ‹æ‘„ç”¨ä¾‹ï¼Œæ‚¨å¯ä»¥è®¾ç½®ç›®æ ‡å®½é«˜æ¯”å’Œé—ªå…‰ç¯æ¨¡å¼ã€‚ä»¥ä¸‹ä»£ç æ˜¾ç¤ºäº†ä¸€ä¸ªç¤ºä¾‹ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> imageCapture = ImageCapture.Builder()</span><br><span class="line">    .setFlashMode(...)</span><br><span class="line">    .setTargetAspectRatio(...)</span><br><span class="line">    .build()</span><br></pre></td></tr></table></figure><p>é™¤é…ç½®é€‰é¡¹ä¹‹å¤–ï¼Œä¸€äº›ç”¨ä¾‹ä¼šå…¬å¼€ API ä»¥ä¾¿åœ¨åˆ›å»ºååŠ¨æ€æ›´æ”¹è®¾ç½®ã€‚å¦‚éœ€äº†è§£å„ä¸ªç”¨ä¾‹çš„ä¸“å±é…ç½®ï¼Œè¯·å‚é˜…<a href="https://developer.android.google.cn/training/camerax/preview?hl=zh-cn">å®ç°é¢„è§ˆ</a>ã€<a href="https://developer.android.google.cn/training/camerax/analyze?hl=zh-cn">åˆ†æå›¾ç‰‡</a>å’Œ<a href="https://developer.android.google.cn/training/camerax/take-photo?hl=zh-cn">å›¾ç‰‡æ‹æ‘„</a>ã€‚</p><h3 id="CameraXConfig"><a href="#CameraXConfig" class="headerlink" title="CameraXConfig"></a>CameraXConfig</h3><p>ä¸ºç®€å•èµ·è§ï¼ŒCameraX å…·æœ‰é€‚åˆå¤§å¤šæ•°ä½¿ç”¨åœºæ™¯çš„é»˜è®¤é…ç½®ï¼ˆä¾‹å¦‚å†…éƒ¨æ‰§è¡Œå™¨å’Œå¤„ç†ç¨‹åºï¼‰ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ‚¨çš„åº”ç”¨æœ‰ç‰¹æ®Šè¦æ±‚æˆ–å¸Œæœ›è‡ªå®šä¹‰è¿™äº›é…ç½®ï¼Œå¯ä½¿ç”¨ <a href="https://developer.android.google.cn/reference/androidx/camera/core/CameraXConfig?hl=zh-cn"><code>CameraXConfig</code></a> æ¥å£å®ç°æ­¤ç›®çš„ã€‚</p><p>å€ŸåŠ© <code>CameraXConfig</code>ï¼Œåº”ç”¨å¯ä»¥æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p><ul><li>ä½¿ç”¨ <a href="https://developer.android.google.cn/reference/androidx/camera/core/CameraXConfig.Builder?hl=zh-cn#setAvailableCamerasLimiter(androidx.camera.core.CameraSelector)"><code>setAvailableCameraLimiter()</code></a> ä¼˜åŒ–å¯åŠ¨å»¶è¿Ÿæ—¶é—´ã€‚</li><li>ä½¿ç”¨ <a href="https://developer.android.google.cn/reference/androidx/camera/core/CameraXConfig.Builder?hl=zh-cn#setCameraExecutor(java.util.concurrent.Executor)"><code>setCameraExecutor()</code></a> å‘ CameraX æä¾›åº”ç”¨æ‰§è¡Œå™¨ã€‚</li><li>å°†é»˜è®¤è°ƒåº¦å™¨å¤„ç†ç¨‹åºæ›¿æ¢ä¸º <a href="https://developer.android.google.cn/reference/androidx/camera/core/CameraXConfig.Builder?hl=zh-cn#setSchedulerHandler(android.os.Handler)"><code>setSchedulerHandler()</code></a>ã€‚</li><li>ä½¿ç”¨ <a href="https://developer.android.google.cn/reference/androidx/camera/core/CameraXConfig.Builder?hl=zh-cn#setMinimumLoggingLevel(int)"><code>setMinimumLoggingLevel()</code></a> æ›´æ”¹æ—¥å¿—è®°å½•çº§åˆ«ã€‚</li></ul><h4 id="ä½¿ç”¨æ¨¡å¼"><a href="#ä½¿ç”¨æ¨¡å¼" class="headerlink" title="ä½¿ç”¨æ¨¡å¼"></a>ä½¿ç”¨æ¨¡å¼</h4><p>ä»¥ä¸‹ç¨‹åºè¯´æ˜äº†å¦‚ä½•ä½¿ç”¨ <code>CameraXConfig</code>ï¼š</p><ol><li>ä½¿ç”¨æ‚¨çš„è‡ªå®šä¹‰é…ç½®åˆ›å»ºä¸€ä¸ª <code>CameraXConfig</code> å¯¹è±¡ã€‚</li><li>åœ¨ <a href="https://developer.android.google.cn/reference/android/app/Application?hl=zh-cn"><code>Application</code></a> ä¸­å®ç° <a href="https://developer.android.google.cn/reference/androidx/camera/core/CameraXConfig.Provider?hl=zh-cn"><code>CameraXConfig.Provider</code></a> æ¥å£ï¼Œå¹¶åœ¨ <a href="https://developer.android.google.cn/reference/androidx/camera/core/CameraXConfig.Provider?hl=zh-cn#getCameraXConfig()"><code>getCameraXConfig()</code></a> ä¸­è¿”å› <code>CameraXConfig</code> å¯¹è±¡ã€‚</li><li>æŒ‰ç…§<a href="https://developer.android.google.cn/reference/android/app/Application?hl=zh-cn">æ­¤å¤„</a>çš„è¯´æ˜ï¼Œå°†æ‚¨çš„ <code>Application</code> ç±»æ·»åŠ åˆ° <code>AndroidManifest.xml</code> æ–‡ä»¶ä¸­ã€‚</li></ol><p>ä¾‹å¦‚ï¼Œä»¥ä¸‹ä»£ç ç¤ºä¾‹å°† CameraX æ—¥å¿—è®°å½•é™åˆ¶ä¸ºä»…è®°å½•é”™è¯¯æ¶ˆæ¯ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CameraApplication</span> : <span class="type">Application</span>(), CameraXConfig.Provider &#123;</span><br><span class="line">   <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getCameraXConfig</span><span class="params">()</span></span>: CameraXConfig &#123;</span><br><span class="line">       <span class="keyword">return</span> CameraXConfig.Builder.fromConfig(Camera2Config.defaultConfig())</span><br><span class="line">           .setMinimumLoggingLevel(Log.ERROR).build()</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæ‚¨çš„åº”ç”¨éœ€è¦åœ¨è®¾ç½® CameraX é…ç½®åäº†è§£è¯¥é…ç½®ï¼Œè¯·ä¿ç•™ <code>CameraXConfig</code> å¯¹è±¡çš„æœ¬åœ°å‰¯æœ¬ã€‚</p><h4 id="æ‘„åƒå¤´é™åˆ¶å™¨"><a href="#æ‘„åƒå¤´é™åˆ¶å™¨" class="headerlink" title="æ‘„åƒå¤´é™åˆ¶å™¨"></a>æ‘„åƒå¤´é™åˆ¶å™¨</h4><p>åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨ <a href="https://developer.android.google.cn/reference/androidx/camera/lifecycle/ProcessCameraProvider?hl=zh-cn#getInstance(android.content.Context)"><code>ProcessCameraProvider.getInstance()</code></a> æœŸé—´ï¼ŒCameraX ä¼šæšä¸¾å’ŒæŸ¥è¯¢è®¾å¤‡ä¸Šå¯ç”¨æ‘„åƒå¤´çš„ç‰¹æ€§ã€‚ç”±äº CameraX éœ€è¦ä¸ç¡¬ä»¶ç»„ä»¶é€šä¿¡ï¼Œå› æ­¤å¯¹æ¯ä¸ªæ‘„åƒå¤´æ‰§è¡Œæ­¤è¿‡ç¨‹å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œå°¤å…¶æ˜¯åœ¨ä½ç«¯è®¾å¤‡ä¸Šã€‚å¦‚æœæ‚¨çš„åº”ç”¨ä»…ä½¿ç”¨è®¾å¤‡ä¸Šçš„ç‰¹å®šæ‘„åƒå¤´ï¼ˆä¾‹å¦‚é»˜è®¤å‰ç½®æ‘„åƒå¤´ï¼‰ï¼Œæ‚¨å¯ä»¥å°† CameraX è®¾ç½®ä¸ºå¿½ç•¥å…¶ä»–æ‘„åƒå¤´ï¼Œä»è€Œç¼©çŸ­åº”ç”¨æ‰€ç”¨æ‘„åƒå¤´çš„å¯åŠ¨å»¶è¿Ÿæ—¶é—´ã€‚</p><p>å¦‚æœä¼ é€’ç»™ <a href="https://developer.android.google.cn/reference/androidx/camera/core/CameraXConfig.Builder?hl=zh-cn#setAvailableCamerasLimiter(androidx.camera.core.CameraSelector)"><code>CameraXConfig.Builder.setAvailableCamerasLimiter()</code></a> çš„ <a href="https://developer.android.google.cn/reference/androidx/camera/core/CameraSelector?hl=zh-cn"><code>CameraSelector</code></a> è¿‡æ»¤æ‰äº†æŸä¸ªæ‘„åƒå¤´ï¼Œåˆ™ CameraX åœ¨è¿è¡Œæ—¶ä¼šå‡å®šè¯¥æ‘„åƒå¤´ä¸å­˜åœ¨ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹ä»£ç ä¼šé™åˆ¶åº”ç”¨åªèƒ½ä½¿ç”¨è®¾å¤‡çš„é»˜è®¤åç½®æ‘„åƒå¤´ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MainApplication</span> : <span class="type">Application</span>(), CameraXConfig.Provider &#123;</span><br><span class="line">   <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getCameraXConfig</span><span class="params">()</span></span>: CameraXConfig &#123;</span><br><span class="line">       <span class="keyword">return</span> CameraXConfig.Builder.fromConfig(Camera2Config.defaultConfig())</span><br><span class="line">              .setAvailableCamerasLimiter(CameraSelector.DEFAULT_BACK_CAMERA)</span><br><span class="line">              .build()</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="çº¿ç¨‹"><a href="#çº¿ç¨‹" class="headerlink" title="çº¿ç¨‹"></a>çº¿ç¨‹</h4><p>æ„å»º CameraX æ—¶æ‰€é‡‡ç”¨çš„å¾ˆå¤šå¹³å° API éƒ½è¦æ±‚é˜»å¡ä¸ç¡¬ä»¶ä¹‹é—´çš„è¿›ç¨‹é—´é€šä¿¡ (IPC)ï¼Œæ­¤ç±»é€šä¿¡æœ‰æ—¶å¯èƒ½éœ€è¦æ•°ç™¾æ¯«ç§’çš„å“åº”æ—¶é—´ã€‚å› æ­¤ï¼ŒCameraX ä»…ä»åå°çº¿ç¨‹è°ƒç”¨è¿™äº› APIï¼Œä»è€Œé¿å…ä¸»çº¿ç¨‹å‘ç”Ÿé˜»å¡ï¼Œä½¿ç•Œé¢ä¿æŒæµç•…ã€‚CameraX ä¼šåœ¨å†…éƒ¨ç®¡ç†è¿™äº›åå°çº¿ç¨‹ï¼Œå› æ­¤è¿™ç±»è¡Œä¸ºæ˜¾å¾—æ¯”è¾ƒé€æ˜ã€‚ä½†æ˜¯ï¼ŒæŸäº›åº”ç”¨éœ€è¦ä¸¥æ ¼æ§åˆ¶çº¿ç¨‹ã€‚<code>CameraXConfig</code> å…è®¸åº”ç”¨è®¾ç½®é€šè¿‡ <a href="https://developer.android.google.cn/reference/androidx/camera/core/CameraXConfig.Builder?hl=zh-cn#setCameraExecutor(java.util.concurrent.Executor)"><code>CameraXConfig.Builder.setCameraExecutor()</code></a> å’Œ <a href="https://developer.android.google.cn/reference/androidx/camera/core/CameraXConfig.Builder?hl=zh-cn#setSchedulerHandler(android.os.Handler)"><code>CameraXConfig.Builder.setSchedulerHandler()</code></a> ä½¿ç”¨çš„åå°çº¿ç¨‹ã€‚</p><p><strong>æ³¨æ„</strong>ï¼šæä¾›è‡ªå®šä¹‰æ‰§è¡Œå™¨æˆ–è°ƒåº¦å™¨å¤„ç†ç¨‹åºæ—¶ï¼Œè¯·ä½¿ç”¨ä¸ä¼šåœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œä»£ç çš„å¤„ç†ç¨‹åºã€‚</p><h4 id="æ‘„åƒå¤´æ‰§è¡Œå™¨"><a href="#æ‘„åƒå¤´æ‰§è¡Œå™¨" class="headerlink" title="æ‘„åƒå¤´æ‰§è¡Œå™¨"></a>æ‘„åƒå¤´æ‰§è¡Œå™¨</h4><p>æ‘„åƒå¤´æ‰§è¡Œå™¨ç”¨äºæ‰€æœ‰å†…éƒ¨æ‘„åƒå¤´å¹³å° API è°ƒç”¨ï¼Œä»¥åŠæ¥è‡ªè¿™äº› API çš„å›è°ƒã€‚CameraX ä¼šåˆ†é…å’Œç®¡ç†å†…éƒ¨ <a href="https://developer.android.google.cn/reference/java/util/concurrent/Executor?hl=zh-cn"><code>Executor</code></a> æ¥æ‰§è¡Œè¿™äº›ä»»åŠ¡ã€‚ ä½†æ˜¯ï¼Œå¦‚æœæ‚¨çš„åº”ç”¨éœ€è¦æ›´ä¸¥æ ¼çš„çº¿ç¨‹æ§åˆ¶ï¼Œè¯·ä½¿ç”¨ <code>CameraXConfig.Builder.setCameraExecutor()</code>ã€‚</p><h4 id="è°ƒåº¦å™¨å¤„ç†ç¨‹åº"><a href="#è°ƒåº¦å™¨å¤„ç†ç¨‹åº" class="headerlink" title="è°ƒåº¦å™¨å¤„ç†ç¨‹åº"></a>è°ƒåº¦å™¨å¤„ç†ç¨‹åº</h4><p>è°ƒåº¦å™¨å¤„ç†ç¨‹åºç”¨äºæŒ‰å›ºå®šçš„æ—¶é—´é—´éš”è°ƒåº¦å†…éƒ¨ä»»åŠ¡ï¼Œä¾‹å¦‚åœ¨æ‘„åƒå¤´ä¸å¯ç”¨æ—¶å†æ¬¡å°è¯•æ‰“å¼€è¯¥æ‘„åƒå¤´ã€‚è¯¥å¤„ç†ç¨‹åºä¸æ‰§è¡Œä½œä¸šï¼Œè€Œæ˜¯ä»…å°†ä½œä¸šåˆ†æ´¾ç»™æ‘„åƒå¤´æ‰§è¡Œå™¨ã€‚æœ‰æ—¶ï¼Œè¯¥å¤„ç†ç¨‹åºè¿˜ç”¨äºéœ€è¦ä½¿ç”¨ <a href="https://developer.android.google.cn/reference/android/os/Handler?hl=zh-cn"><code>Handler</code></a> è¿›è¡Œå›è°ƒçš„æ—§ç‰ˆ API å¹³å°ã€‚åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œå›è°ƒä»ä»…ç›´æ¥åˆ†æ´¾ç»™æ‘„åƒå¤´æ‰§è¡Œå™¨ã€‚CameraX ä¼šåˆ†é…å’Œç®¡ç†å†…éƒ¨ <a href="https://developer.android.google.cn/reference/android/os/HandlerThread?hl=zh-cn"><code>HandlerThread</code></a> æ¥æ‰§è¡Œè¿™äº›ä»»åŠ¡ï¼Œä½†æ‚¨å¯ä»¥å°†å…¶æ›¿æ¢ä¸º <code>CameraXConfig.Builder.setSchedulerHandler()</code>ã€‚</p><h4 id="æ—¥å¿—è®°å½•"><a href="#æ—¥å¿—è®°å½•" class="headerlink" title="æ—¥å¿—è®°å½•"></a>æ—¥å¿—è®°å½•</h4><p>å€ŸåŠ© CameraX æ—¥å¿—è®°å½•ï¼Œåº”ç”¨å¯ä»¥è¿‡æ»¤ logcat æ¶ˆæ¯ï¼Œå› ä¸ºåœ¨æ­£å¼ç‰ˆä»£ç ä¸­åº”å°½é‡é¿å…åŒ…å«è¯¦ç»†æ¶ˆæ¯ã€‚CameraX æ”¯æŒå››ç§æ—¥å¿—è®°å½•çº§åˆ«ï¼ˆä»æœ€è¯¦ç»†åˆ°æœ€ä¸¥é‡ï¼‰ï¼š</p><ul><li><code>Log.DEBUG</code>ï¼ˆé»˜è®¤ï¼‰</li><li><code>Log.INFO</code></li><li><code>Log.WARN</code></li><li><code>Log.ERROR</code></li></ul><p>å¦‚éœ€è¯¦ç»†äº†è§£è¿™äº›æ—¥å¿—çº§åˆ«ï¼Œè¯·å‚é˜… <a href="https://developer.android.google.cn/reference/android/util/Log?hl=zh-cn#DEBUG">Android æ—¥å¿—æ–‡æ¡£</a>ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ <a href="https://developer.android.google.cn/reference/androidx/camera/core/CameraXConfig.Builder?hl=zh-cn#setMinimumLoggingLevel(int)"><code>CameraXConfig.Builder.setMinimumLoggingLevel(int)</code></a> ä¸ºæ‚¨çš„åº”ç”¨è®¾ç½®é€‚å½“çš„æ—¥å¿—è®°å½•çº§åˆ«ã€‚</p><h3 id="è‡ªåŠ¨é€‰æ‹©"><a href="#è‡ªåŠ¨é€‰æ‹©" class="headerlink" title="è‡ªåŠ¨é€‰æ‹©"></a>è‡ªåŠ¨é€‰æ‹©</h3><p>CameraX ä¼šæ ¹æ®è¿è¡Œæ‚¨çš„åº”ç”¨çš„è®¾å¤‡è‡ªåŠ¨æä¾›ä¸“ç”¨çš„åŠŸèƒ½ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æœªæŒ‡å®šåˆ†è¾¨ç‡æˆ–æ‚¨æŒ‡å®šçš„åˆ†è¾¨ç‡ä¸å—æ”¯æŒï¼ŒCameraX ä¼šè‡ªåŠ¨ç¡®å®šè¦ä½¿ç”¨çš„æœ€ä½³åˆ†è¾¨ç‡ã€‚æ‰€æœ‰è¿™äº›æ“ä½œå‡ç”±åº“è¿›è¡Œå¤„ç†ï¼Œæ— éœ€æ‚¨ç¼–å†™è®¾å¤‡ä¸“å±ä»£ç ã€‚</p><p>CameraX çš„ç›®æ ‡æ˜¯æˆåŠŸåˆå§‹åŒ–æ‘„åƒå¤´ä¼šè¯ã€‚è¿™æ„å‘³ç€ï¼ŒCameraX ä¼šæ ¹æ®è®¾å¤‡åŠŸèƒ½é™ä½åˆ†è¾¨ç‡å’Œå®½é«˜æ¯”ã€‚å‘ç”Ÿè¿™ç§æƒ…å†µçš„åŸå› å¦‚ä¸‹ï¼š</p><ul><li>è®¾å¤‡ä¸æ”¯æŒè¯·æ±‚çš„åˆ†è¾¨ç‡ã€‚</li><li>è®¾å¤‡å­˜åœ¨å…¼å®¹æ€§é—®é¢˜ï¼Œä¾‹å¦‚éœ€è¦ç‰¹å®šåˆ†è¾¨ç‡æ‰èƒ½æ­£å¸¸è¿è¡Œçš„æ—§è®¾å¤‡ã€‚</li><li>åœ¨æŸäº›è®¾å¤‡ä¸Šï¼ŒæŸäº›æ ¼å¼ä»…åœ¨æŸäº›å®½é«˜æ¯”ä¸‹å¯ç”¨ã€‚</li><li>å¯¹äº JPEG æˆ–è§†é¢‘ç¼–ç ï¼Œè®¾å¤‡é¦–é€‰â€œæœ€è¿‘çš„ mod16â€ã€‚å¦‚éœ€äº†è§£è¯¦æƒ…ï¼Œè¯·å‚é˜… <a href="https://developer.android.google.cn/reference/android/hardware/camera2/CameraCharacteristics?hl=zh-cn#SCALER_STREAM_CONFIGURATION_MAP"><code>SCALER_STREAM_CONFIGURATION_MAP</code></a>ã€‚</li></ul><p>å°½ç®¡ CameraX ä¼šåˆ›å»ºå¹¶ç®¡ç†ä¼šè¯ï¼Œæ‚¨ä¹Ÿåº”å§‹ç»ˆåœ¨ä»£ç ä¸­æ£€æŸ¥ç”¨ä¾‹è¾“å‡ºæ‰€è¿”å›çš„å›¾ç‰‡å¤§å°ï¼Œå¹¶è¿›è¡Œç›¸åº”è°ƒæ•´ã€‚</p><h3 id="æ—‹è½¬"><a href="#æ—‹è½¬" class="headerlink" title="æ—‹è½¬"></a>æ—‹è½¬</h3><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œåœ¨ç”¨ä¾‹åˆ›å»ºæœŸé—´ï¼Œæ‘„åƒå¤´çš„æ—‹è½¬è§’åº¦ä¼šè®¾ç½®ä¸ºä¸é»˜è®¤çš„æ˜¾ç¤ºå±æ—‹è½¬è§’åº¦ä¿æŒä¸€è‡´ã€‚åœ¨æ­¤é»˜è®¤æƒ…å†µä¸‹ï¼ŒCameraX ä¼šç”Ÿæˆè¾“å‡ºï¼Œç¡®ä¿åº”ç”¨ä¸æ‚¨é¢„æœŸåœ¨é¢„è§ˆä¸­çœ‹åˆ°çš„å†…å®¹ä¿æŒä¸€è‡´ã€‚é€šè¿‡åœ¨é…ç½®ç”¨ä¾‹å¯¹è±¡æ—¶ä¼ å…¥å½“å‰æ˜¾ç¤ºå±æ–¹å‘æˆ–åœ¨åˆ›å»ºç”¨ä¾‹å¯¹è±¡ä¹‹ååŠ¨æ€ä¼ å…¥æ˜¾ç¤ºå±æ–¹å‘ï¼Œæ‚¨å¯ä»¥å°†æ—‹è½¬è§’åº¦æ›´æ”¹ä¸ºè‡ªå®šä¹‰å€¼ä»¥æ”¯æŒå¤šæ˜¾ç¤ºå±è®¾å¤‡ã€‚</p><p>æ‚¨çš„åº”ç”¨å¯ä»¥ä½¿ç”¨é…ç½®è®¾ç½®æ¥è®¾ç½®ç›®æ ‡æ—‹è½¬è§’åº¦ã€‚ç„¶åï¼Œå³ä½¿ç”Ÿå‘½å‘¨æœŸå¤„äºè¿è¡ŒçŠ¶æ€ï¼Œåº”ç”¨ä¹Ÿå¯ä»¥é€šè¿‡ä½¿ç”¨ç”¨ä¾‹ API ä¸­çš„æ–¹æ³•ï¼ˆä¾‹å¦‚ <a href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis?hl=zh-cn#setTargetRotation(int)"><code>ImageAnalysis.setTargetRotation()</code></a>ï¼‰æ›´æ–°æ—‹è½¬è®¾ç½®ã€‚æ‚¨å¯ä»¥åœ¨åº”ç”¨é”å®šä¸ºçºµå‘æ¨¡å¼æ—¶æ‰§è¡Œä¸Šè¿°æ“ä½œï¼Œè¿™æ ·å°±æ— éœ€é‡æ–°é…ç½®æ—‹è½¬è§’åº¦ï¼Œä½†æ˜¯ç…§ç‰‡æˆ–åˆ†æç”¨ä¾‹éœ€è¦äº†è§£è®¾å¤‡å½“å‰çš„æ—‹è½¬è§’åº¦ã€‚ä¾‹å¦‚ï¼Œç”¨ä¾‹å¯èƒ½éœ€è¦äº†è§£æ—‹è½¬è§’åº¦æ‰èƒ½ä»¥æ­£ç¡®çš„æ–¹å‘è¿›è¡Œäººè„¸æ£€æµ‹ï¼Œæˆ–è€…å°†ç…§ç‰‡è®¾ç½®ä¸ºæ¨ªå‘æˆ–çºµå‘ã€‚</p><p>å­˜å‚¨æ‰€æ‹æ‘„å›¾ç‰‡çš„æ•°æ®æ—¶å¯èƒ½ä¸ä¼šåŒ…å«æ—‹è½¬ä¿¡æ¯ã€‚Exif æ•°æ®åŒ…å«æ—‹è½¬ä¿¡æ¯ï¼Œä»¥ä¾¿å›¾åº“åº”ç”¨åœ¨ä¿å­˜åä»¥æ­£ç¡®çš„å±å¹•æ–¹å‘æ˜¾ç¤ºå›¾ç‰‡ã€‚</p><p>å¦‚éœ€ä»¥æ­£ç¡®çš„å±å¹•æ–¹å‘æ˜¾ç¤ºé¢„è§ˆæ•°æ®ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ <a href="https://developer.android.google.cn/reference/androidx/camera/core/Preview.PreviewOutput?hl=zh-cn"><code>Preview.PreviewOutput()</code></a> çš„å…ƒæ•°æ®è¾“å‡ºåˆ›å»ºè½¬æ¢ã€‚</p><p>ä»¥ä¸‹ä»£ç ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•ä¸ºå±å¹•æ–¹å‘äº‹ä»¶è®¾ç½®æ—‹è½¬è§’åº¦ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> imageCapture = ImageCapture.Builder().build()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> orientationEventListener = <span class="keyword">object</span> : OrientationEventListener(<span class="keyword">this</span> <span class="keyword">as</span> Context) &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onOrientationChanged</span><span class="params">(orientation : <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">            <span class="comment">// Monitors orientation values to determine the target rotation value</span></span><br><span class="line">            <span class="keyword">val</span> rotation : <span class="built_in">Int</span> = <span class="keyword">when</span> (orientation) &#123;</span><br><span class="line">                <span class="keyword">in</span> <span class="number">45.</span><span class="number">.134</span> -&gt; Surface.ROTATION_270</span><br><span class="line">                <span class="keyword">in</span> <span class="number">135.</span><span class="number">.224</span> -&gt; Surface.ROTATION_180</span><br><span class="line">                <span class="keyword">in</span> <span class="number">225.</span><span class="number">.314</span> -&gt; Surface.ROTATION_90</span><br><span class="line">                <span class="keyword">else</span> -&gt; Surface.ROTATION_0</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            imageCapture.targetRotation = rotation</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    orientationEventListener.enable()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯ä¸ªç”¨ä¾‹éƒ½ä¼šæ ¹æ®è®¾å®šçš„æ—‹è½¬è§’åº¦ç›´æ¥æ—‹è½¬å›¾ç‰‡æ•°æ®ï¼Œæˆ–è€…å‘ç”¨æˆ·æä¾›æœªæ—‹è½¬å›¾ç‰‡æ•°æ®çš„æ—‹è½¬å…ƒæ•°æ®ã€‚</p><ul><li><strong>Preview</strong>ï¼šæä¾›å…ƒæ•°æ®è¾“å‡ºï¼Œä»¥ä¾¿ä½¿ç”¨ <a href="https://developer.android.google.cn/reference/androidx/camera/core/Preview?hl=zh-cn#getTargetRotation()"><code>Preview.getTargetRotation()</code></a> äº†è§£ç›®æ ‡åˆ†è¾¨ç‡çš„æ—‹è½¬è®¾ç½®ã€‚</li><li><strong>ImageAnalysis</strong>ï¼šæä¾›å…ƒæ•°æ®è¾“å‡ºï¼Œä»¥ä¾¿äº†è§£å›¾ç‰‡ç¼“å†²åŒºåæ ‡ç›¸å¯¹äºæ˜¾ç¤ºåæ ‡çš„ä½ç½®ã€‚</li><li><strong>ImageCapture</strong>ï¼šæ›´æ”¹å›¾ç‰‡ Exif å…ƒæ•°æ®ã€ç¼“å†²åŒºæˆ–åŒæ—¶æ›´æ”¹ä¸¤è€…ï¼Œä»è€Œåæ˜ æ—‹è½¬è®¾ç½®ã€‚æ›´æ”¹çš„å€¼å–å†³äº HAL å®ç°ã€‚</li></ul><h3 id="å‰ªè£çŸ©å½¢"><a href="#å‰ªè£çŸ©å½¢" class="headerlink" title="å‰ªè£çŸ©å½¢"></a>å‰ªè£çŸ©å½¢</h3><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå‰ªè£çŸ©å½¢æ˜¯å®Œæ•´çš„ç¼“å†²åŒºçŸ©å½¢ï¼Œæ‚¨å¯é€šè¿‡ <a href="https://developer.android.google.cn/reference/androidx/camera/core/ViewPort?hl=zh-cn"><code>ViewPort</code></a> å’Œ <a href="https://developer.android.google.cn/reference/androidx/camera/core/UseCaseGroup?hl=zh-cn"><code>UseCaseGroup</code></a> å¯¹å…¶è¿›è¡Œè‡ªå®šä¹‰ã€‚é€šè¿‡å¯¹ç”¨ä¾‹è¿›è¡Œåˆ†ç»„å¹¶è®¾ç½®è§†å£ï¼ŒCameraX å¯ä¿è¯ä¸€ä¸ªç»„ä¸­çš„æ‰€æœ‰ç”¨ä¾‹çš„å‰ªè£çŸ©å½¢éƒ½æŒ‡å‘æ‘„åƒå¤´ä¼ æ„Ÿå™¨ä¸­çš„åŒä¸€ä¸ªåŒºåŸŸã€‚</p><p>ä»¥ä¸‹ä»£ç æ®µå±•ç¤ºäº†è¿™ä¸¤ä¸ªç±»çš„ä½¿ç”¨æ–¹æ³•ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> viewPort =  ViewPort.Builder(Rational(width, height), display.rotation).build()</span><br><span class="line"><span class="keyword">val</span> useCaseGroup = UseCaseGroup.Builder()</span><br><span class="line">    .addUseCase(preview)</span><br><span class="line">    .addUseCase(imageAnalysis)</span><br><span class="line">    .addUseCase(imageCapture)</span><br><span class="line">    .setViewPort(viewPort)</span><br><span class="line">    .build()</span><br><span class="line">cameraProvider.bindToLifecycle(lifecycleOwner, cameraSelector, useCaseGroup)</span><br></pre></td></tr></table></figure><p><code>ViewPort</code> ç”¨äºæŒ‡å®šæœ€ç»ˆç”¨æˆ·å¯çœ‹åˆ°çš„ç¼“å†²åŒºçŸ©å½¢ã€‚CameraX ä¼šæ ¹æ®è§†å£çš„å±æ€§åŠé™„åŠ çš„ç”¨ä¾‹è®¡ç®—å‡ºå¯èƒ½çš„æœ€å¤§å‰ªè£çŸ©å½¢ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸ºäº†è¾¾åˆ° WYSIWYG æ•ˆæœï¼Œæ‚¨åº”æ ¹æ®é¢„è§ˆç”¨ä¾‹æ¥é…ç½®è§†å£ã€‚è·å–è§†å£çš„ä¸€ç§ç®€å•æ–¹æ³•æ˜¯ä½¿ç”¨ <a href="https://developer.android.google.cn/training/camerax/preview?hl=zh-cn#implementation"><code>PreviewView</code></a>ã€‚</p><p>ä»¥ä¸‹ä»£ç æ®µå±•ç¤ºäº†å¦‚ä½•è·å– <code>ViewPort</code> å¯¹è±¡ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> viewport = findViewById&lt;PreviewView&gt;(R.id.preview_view).viewPort</span><br></pre></td></tr></table></figure><p>åœ¨å‰é¢çš„ç¤ºä¾‹ä¸­ï¼Œåº”ç”¨é€šè¿‡ <code>ImageAnalysis</code> å’Œ <code>ImageCapture</code> è·å–çš„å†…å®¹ä¸æœ€ç»ˆç”¨æˆ·åœ¨ <code>PreviewView</code> ä¸­çœ‹åˆ°çš„å†…å®¹ç›¸åŒï¼ˆå‡å®š <code>PreviewView</code> çš„ç¼©æ”¾ç±»å‹è®¾ä¸ºé»˜è®¤å€¼ <code>FILL_CENTER</code>ï¼‰ã€‚å°†å‰ªè£çŸ©å½¢å’Œæ—‹è½¬è§’åº¦åº”ç”¨åˆ°è¾“å‡ºç¼“å†²åŒºåï¼Œå›¾ç‰‡å°†åœ¨æ‰€æœ‰ç”¨ä¾‹ä¸­ä¿æŒä¸€è‡´ï¼Œä½†åˆ†è¾¨ç‡å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒã€‚å¦‚éœ€è¯¦ç»†äº†è§£å¦‚ä½•åº”ç”¨è½¬æ¢ä¿¡æ¯ï¼Œè¯·å‚é˜…<a href="https://developer.android.google.cn/training/camerax/transform-output?hl=zh-cn">è½¬æ¢è¾“å‡º</a>ã€‚</p><h3 id="æ‘„åƒå¤´åˆ†è¾¨ç‡"><a href="#æ‘„åƒå¤´åˆ†è¾¨ç‡" class="headerlink" title="æ‘„åƒå¤´åˆ†è¾¨ç‡"></a>æ‘„åƒå¤´åˆ†è¾¨ç‡</h3><p>æ‚¨å¯ä»¥é€‰æ‹©è®© CameraX æ ¹æ®è®¾å¤‡åŠŸèƒ½ã€è®¾å¤‡æ”¯æŒçš„<a href="https://developer.android.google.cn/reference/android/hardware/camera2/CameraCharacteristics?hl=zh-cn#INFO_SUPPORTED_HARDWARE_LEVEL">ç¡¬ä»¶çº§åˆ«</a>ã€ç”¨ä¾‹å’Œæ‰€æä¾›çš„å®½é«˜æ¯”ç»„åˆè®¾ç½®å›¾ç‰‡åˆ†è¾¨ç‡ã€‚æˆ–è€…ï¼Œæ‚¨ä¹Ÿå¯ä»¥åœ¨æ”¯æŒç›¸åº”é…ç½®çš„ç”¨ä¾‹ä¸­è®¾ç½®ç‰¹å®šç›®æ ‡åˆ†è¾¨ç‡æˆ–ç‰¹å®šå®½é«˜æ¯”ã€‚</p><h4 id="è‡ªåŠ¨åˆ†è¾¨ç‡"><a href="#è‡ªåŠ¨åˆ†è¾¨ç‡" class="headerlink" title="è‡ªåŠ¨åˆ†è¾¨ç‡"></a>è‡ªåŠ¨åˆ†è¾¨ç‡</h4><p>CameraX å¯ä»¥æ ¹æ® <code>cameraProcessProvider.bindToLifecycle()</code> ä¸­æŒ‡å®šçš„ç”¨ä¾‹è‡ªåŠ¨ç¡®å®šæœ€ä½³åˆ†è¾¨ç‡è®¾ç½®ã€‚è¯·å°½å¯èƒ½åœ¨å•ä¸ª <code>bindToLifecycle()</code> è°ƒç”¨çš„å•ä¸ªä¼šè¯ä¸­æŒ‡å®šéœ€è¦åŒæ—¶è¿è¡Œçš„æ‰€æœ‰ç”¨ä¾‹ã€‚CameraX ä¼šè€ƒè™‘è®¾å¤‡æ”¯æŒçš„ç¡¬ä»¶çº§åˆ«ä»¥åŠè®¾å¤‡ä¸“å±å˜åŒ–ï¼ˆè®¾å¤‡è¶…å‡ºæˆ–ä¸æ»¡è¶³<a href="https://developer.android.google.cn/reference/android/hardware/camera2/CameraDevice?hl=zh-cn#createCaptureSession(android.hardware.camera2.params.SessionConfiguration)">å¯ç”¨çš„ä¿¡æ¯æµé…ç½®</a>ï¼‰ï¼Œæ ¹æ®ç»‘å®šçš„æˆç»„ç”¨ä¾‹ç¡®å®šåˆ†è¾¨ç‡ã€‚ è¿™æ ·åšæ˜¯ä¸ºäº†ç¡®ä¿åº”ç”¨åœ¨å„ç§è®¾å¤‡ä¸Šè¿è¡Œæ—¶ï¼Œèƒ½å¤Ÿæœ€å¤§é™åº¦åœ°å‡å°‘è®¾å¤‡ä¸“å±ä»£ç è·¯å¾„ã€‚</p><p>å›¾ç‰‡æ‹æ‘„å’Œå›¾ç‰‡åˆ†æç”¨ä¾‹çš„é»˜è®¤å®½é«˜æ¯”ä¸º 4:3ã€‚</p><p>å¯¹äºå…·æœ‰å¯é…ç½®å®½é«˜æ¯”çš„ç”¨ä¾‹ï¼Œå¯è®©åº”ç”¨æ ¹æ®ç•Œé¢è®¾è®¡æ¥æŒ‡å®šæ‰€éœ€çš„å®½é«˜æ¯”ã€‚CameraX ä¼šæŒ‰ç…§è¯·æ±‚çš„å®½é«˜æ¯”ç”Ÿæˆè¾“å‡ºï¼Œå¹¶å°½å¯èƒ½åŒ¹é…è®¾å¤‡æ”¯æŒçš„å®½é«˜æ¯”ã€‚å¦‚æœæ²¡æœ‰ä»»ä½•æ”¯æŒçš„å®Œå…¨åŒ¹é…åˆ†è¾¨ç‡ï¼Œåˆ™é€‰æ‹©æ»¡è¶³æœ€å¤šæ¡ä»¶çš„åˆ†è¾¨ç‡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåº”ç”¨ä¼šå†³å®šæ‘„åƒå¤´åœ¨åº”ç”¨ä¸­çš„æ˜¾ç¤ºæ–¹å¼ï¼ŒCameraX åˆ™ä¼šå†³å®šæœ€ä½³æ‘„åƒå¤´åˆ†è¾¨ç‡è®¾ç½®ï¼Œä»¥æ»¡è¶³ä¸åŒè®¾å¤‡çš„å…·ä½“è¦æ±‚ã€‚</p><p>ä¾‹å¦‚ï¼Œåº”ç”¨å¯ä»¥æ‰§è¡Œä»¥ä¸‹ä»»ä¸€æ“ä½œï¼š</p><ul><li>ä¸ºç”¨ä¾‹æŒ‡å®š 4:3 æˆ– 16:9 çš„ç›®æ ‡åˆ†è¾¨ç‡</li><li>æŒ‡å®šè‡ªå®šä¹‰åˆ†è¾¨ç‡ï¼ŒCameraX ä¼šå°è¯•æŸ¥æ‰¾ä¸è¯¥åˆ†è¾¨ç‡æœ€æ¥è¿‘çš„åˆ†è¾¨ç‡</li><li>ä¸º <code>ImageCapture</code> æŒ‡å®šå‰ªè£å®½é«˜æ¯”</li></ul><p>CameraX ä¼šè‡ªåŠ¨é€‰æ‹©å†…éƒ¨ Camera2 ç•Œé¢çš„åˆ†è¾¨ç‡ã€‚ä¸‹è¡¨æ˜¾ç¤ºäº†è¿™äº›åˆ†è¾¨ç‡ï¼š</p><table><thead><tr><th align="left"><strong>ç”¨ä¾‹</strong></th><th align="left"><strong>å†…éƒ¨ç•Œé¢åˆ†è¾¨ç‡</strong></th><th align="left"><strong>è¾“å‡ºæ•°æ®åˆ†è¾¨ç‡</strong></th></tr></thead><tbody><tr><td align="left">é¢„è§ˆ</td><td align="left"><strong>å®½é«˜æ¯”</strong>ï¼šä½¿ç›®æ ‡ä¸è®¾ç½®æœ€ç›¸ç¬¦çš„åˆ†è¾¨ç‡ã€‚</td><td align="left">å†…éƒ¨ç•Œé¢åˆ†è¾¨ç‡ã€‚é€šè¿‡æä¾›å…ƒæ•°æ®ï¼Œå¯è®©è§†å›¾é’ˆå¯¹ç›®æ ‡å®½é«˜æ¯”è¿›è¡Œå‰ªè£ã€ç¼©æ”¾å’Œæ—‹è½¬ã€‚</td></tr><tr><td align="left"><strong>é»˜è®¤åˆ†è¾¨ç‡ï¼š</strong>æœ€é«˜çš„é¢„è§ˆåˆ†è¾¨ç‡ï¼Œæˆ–ä¸é¢„è§ˆå®½é«˜æ¯”åŒ¹é…çš„æœ€é«˜è®¾å¤‡é¦–é€‰åˆ†è¾¨ç‡ã€‚</td><td align="left"></td><td align="left"></td></tr><tr><td align="left"><strong>æœ€å¤§åˆ†è¾¨ç‡ï¼š</strong>é¢„è§ˆå¤§å°ï¼ŒæŒ‡çš„æ˜¯ä¸è®¾å¤‡çš„å±å¹•åˆ†è¾¨ç‡æˆ– 1080p (1920x1080)ï¼ˆä»¥è¾ƒä½è€…ä¸ºå‡†ï¼‰åŒ¹é…çš„æœ€ä½³å°ºå¯¸ã€‚</td><td align="left"></td><td align="left"></td></tr><tr><td align="left">å›¾ç‰‡åˆ†æ</td><td align="left"><strong>å®½é«˜æ¯”</strong>ï¼šä½¿ç›®æ ‡ä¸è®¾ç½®æœ€ç›¸ç¬¦çš„åˆ†è¾¨ç‡ã€‚</td><td align="left">å†…éƒ¨ç•Œé¢åˆ†è¾¨ç‡ã€‚</td></tr><tr><td align="left"><strong>é»˜è®¤åˆ†è¾¨ç‡</strong>ï¼šé»˜è®¤ç›®æ ‡åˆ†è¾¨ç‡è®¾ç½®ä¸º 640x480ã€‚åŒæ—¶è°ƒæ•´ç›®æ ‡åˆ†è¾¨ç‡å’Œç›¸åº”çš„å®½é«˜æ¯”å¯è·å¾—æ”¯æŒçš„æœ€ä½³åˆ†è¾¨ç‡ã€‚</td><td align="left"></td><td align="left"></td></tr><tr><td align="left"><strong>æœ€å¤§åˆ†è¾¨ç‡</strong>ï¼šä» <a href="https://developer.android.google.cn/reference/android/hardware/camera2/params/StreamConfigurationMap?hl=zh-cn#getOutputSizes(int)"><code>StreamConfigurationMap.getOutputSizes()</code></a> ä¸­æ£€ç´¢åˆ°çš„ YUV_420_888 æ ¼å¼çš„æ‘„åƒå¤´è®¾å¤‡æœ€å¤§è¾“å‡ºåˆ†è¾¨ç‡ã€‚ ç›®æ ‡åˆ†è¾¨ç‡é»˜è®¤è®¾ç½®ä¸º 640x480ã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨å¸Œæœ›åˆ†è¾¨ç‡å¤§äº 640x480ï¼Œå¿…é¡»ä½¿ç”¨ <a href="https://developer.android.google.cn/reference/kotlin/androidx/camera/core/ImageAnalysis.Builder?hl=zh-cn#settargetresolution"><code>setTargetResolution()</code></a> å’Œ <a href="https://developer.android.google.cn/reference/kotlin/androidx/camera/core/ImageAnalysis.Builder?hl=zh-cn#settargetaspectratio"><code>setTargetAspectRatio()</code></a> ä»æ”¯æŒçš„åˆ†è¾¨ç‡ä¸­é€‰æ‹©æœ€æ¥è¿‘çš„ä¸€ä¸ªã€‚</td><td align="left"></td><td align="left"></td></tr><tr><td align="left">å›¾ç‰‡æ‹æ‘„</td><td align="left"><strong>å®½é«˜æ¯”</strong>ï¼šæœ€é€‚åˆè®¾ç½®çš„å®½é«˜æ¯”ã€‚</td><td align="left">å†…éƒ¨ç•Œé¢åˆ†è¾¨ç‡ã€‚</td></tr><tr><td align="left"><strong>é»˜è®¤åˆ†è¾¨ç‡</strong>ï¼šæœ€é«˜å¯ç”¨åˆ†è¾¨ç‡ï¼Œæˆ–ä¸ ImageCapture çš„å®½é«˜æ¯”åŒ¹é…çš„æœ€é«˜è®¾å¤‡é¦–é€‰åˆ†è¾¨ç‡ã€‚</td><td align="left"></td><td align="left"></td></tr><tr><td align="left"><strong>æœ€å¤§åˆ†è¾¨ç‡</strong>ï¼šJPEG æ ¼å¼çš„æ‘„åƒå¤´è®¾å¤‡æœ€å¤§è¾“å‡ºåˆ†è¾¨ç‡ã€‚è¯·ä½¿ç”¨ <a href="https://developer.android.google.cn/reference/android/hardware/camera2/params/StreamConfigurationMap?hl=zh-cn#getOutputSizes(int)"><code>StreamConfigurationMap.getOutputSizes()</code></a> æ£€ç´¢æ­¤åˆ†è¾¨ç‡ã€‚</td><td align="left"></td><td align="left"></td></tr></tbody></table><h4 id="æŒ‡å®šåˆ†è¾¨ç‡"><a href="#æŒ‡å®šåˆ†è¾¨ç‡" class="headerlink" title="æŒ‡å®šåˆ†è¾¨ç‡"></a>æŒ‡å®šåˆ†è¾¨ç‡</h4><p>ä½¿ç”¨ <code>setTargetResolution(Size resolution)</code> æ–¹æ³•æ„å»ºç”¨ä¾‹æ—¶ï¼Œæ‚¨å¯ä»¥è®¾ç½®ç‰¹å®šåˆ†è¾¨ç‡ï¼Œå¦‚ä»¥ä¸‹ä»£ç ç¤ºä¾‹æ‰€ç¤ºï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> imageAnalysis = ImageAnalysis.Builder()</span><br><span class="line">    .setTargetResolution(Size(<span class="number">1280</span>, <span class="number">720</span>))</span><br><span class="line">    .build()</span><br></pre></td></tr></table></figure><p>æ‚¨æ— æ³•é’ˆå¯¹åŒä¸€ä¸ªç”¨ä¾‹è®¾ç½®ç›®æ ‡å®½é«˜æ¯”å’Œç›®æ ‡åˆ†è¾¨ç‡ã€‚å¦‚æœè¿™æ ·åšï¼Œåˆ™ä¼šåœ¨æ„å»ºé…ç½®å¯¹è±¡æ—¶æŠ›å‡º <code>IllegalArgumentException</code>ã€‚</p><p>æŒ‰ç…§ç›®æ ‡æ—‹è½¬è§’åº¦æ—‹è½¬æ”¯æŒçš„å¤§å°åï¼Œè¯·åœ¨åæ ‡ç³»ä¸­è¡¨ç¤ºåˆ†è¾¨ç‡ <a href="https://developer.android.google.cn/reference/android/util/Size?hl=zh-cn"><code>Size</code></a>ã€‚ä¾‹å¦‚ï¼Œè‡ªç„¶å±å¹•æ–¹å‘ä¸ºçºµå‘å¹¶é‡‡ç”¨è‡ªç„¶ç›®æ ‡æ—‹è½¬è§’åº¦çš„è®¾å¤‡å¦‚æœè¯·æ±‚çºµå‘å›¾ç‰‡ï¼Œå¯æŒ‡å®š 480x640ï¼›è€ŒåŒä¸€è®¾å¤‡æ—‹è½¬ 90 åº¦å¹¶ä»¥æ¨ªå‘å±å¹•æ–¹å‘ä¸ºç›®æ ‡åï¼Œå¯æŒ‡å®š 640x480ã€‚</p><p>ç›®æ ‡åˆ†è¾¨ç‡ä¼šå°è¯•åˆ¶å®šå›¾ç‰‡åˆ†è¾¨ç‡çš„ä¸‹é™ã€‚å®é™…çš„å›¾ç‰‡åˆ†è¾¨ç‡æ˜¯æœ€æ¥è¿‘çš„å¯ç”¨åˆ†è¾¨ç‡ï¼Œå…¶å¤§å°ä¸å°äºç”±æ‘„åƒå¤´å®ç°æ‰€å†³å®šçš„ç›®æ ‡åˆ†è¾¨ç‡ã€‚</p><p>ä½†æ˜¯ï¼Œå¦‚æœä¸å­˜åœ¨ç­‰äºæˆ–å¤§äºç›®æ ‡åˆ†è¾¨ç‡çš„åˆ†è¾¨ç‡ï¼Œå°±ä¼šä»å°äºç›®æ ‡åˆ†è¾¨ç‡çš„å¯ç”¨åˆ†è¾¨ç‡ä¸­é€‰æ‹©æœ€æ¥è¿‘çš„ä¸€ä¸ªã€‚ä¸æä¾›çš„ <code>Size</code> å…·æœ‰ç›¸åŒå®½é«˜æ¯”çš„åˆ†è¾¨ç‡ï¼Œå…¶ä¼˜å…ˆçº§é«˜äºå…·æœ‰ä¸åŒå®½é«˜æ¯”çš„åˆ†è¾¨ç‡ã€‚</p><p>CameraX ä¼šæ ¹æ®è¯·æ±‚åº”ç”¨æœ€åˆé€‚çš„åˆ†è¾¨ç‡ã€‚å¦‚æœä¸»è¦éœ€æ±‚æ˜¯æ»¡è¶³å®½é«˜æ¯”è¦æ±‚ï¼Œåˆ™ä»…æŒ‡å®š <code>setTargetAspectRatio</code>ï¼ŒCameraX ä¼šæ ¹æ®è®¾å¤‡ç¡®å®šåˆé€‚çš„ç‰¹å®šåˆ†è¾¨ç‡ã€‚ å¦‚æœåº”ç”¨çš„ä¸»è¦éœ€æ±‚æ˜¯æŒ‡å®šåˆ†è¾¨ç‡ä»¥æé«˜å›¾ç‰‡å¤„ç†æ•ˆç‡ï¼ˆä¾‹å¦‚æ ¹æ®è®¾å¤‡å¤„ç†èƒ½åŠ›å¤„ç†è¾ƒå°æˆ–ä¸­ç­‰å¤§å°çš„å›¾ç‰‡ï¼‰ï¼Œè¯·ä½¿ç”¨ <code>setTargetResolution(Size resolution)</code>ã€‚</p><p><strong>æ³¨æ„ï¼š</strong>å¦‚æœä½¿ç”¨ <code>setTargetResolution()</code>ï¼Œå¯èƒ½ä¼šå¾—åˆ°å®½é«˜æ¯”ä¸å…¶ä»–ç”¨ä¾‹ä¸åŒ¹é…çš„ç¼“å†²åŒºã€‚å¦‚æœå®½é«˜æ¯”å¿…é¡»åŒ¹é…ï¼Œè¯·æ£€æŸ¥ä¸¤ä¸ªç”¨ä¾‹è¿”å›çš„ç¼“å†²åŒºå°ºå¯¸ï¼Œç„¶åå‰ªè£æˆ–ç¼©æ”¾å…¶ä¸­ä¸€ä¸ªä»¥ä¸å¦ä¸€ä¸ªåŒ¹é…ã€‚</p><p>å¦‚æœæ‚¨çš„åº”ç”¨éœ€è¦ç²¾ç¡®çš„åˆ†è¾¨ç‡ï¼Œè¯·å‚é˜… <a href="https://developer.android.google.cn/reference/android/hardware/camera2/CameraDevice?hl=zh-cn#regular-capture"><code>createCaptureSession()</code></a> å†…çš„è¡¨æ ¼ï¼Œä»¥ç¡®å®šæ¯ä¸ªç¡¬ä»¶çº§åˆ«æ”¯æŒçš„æœ€å¤§åˆ†è¾¨ç‡ã€‚å¦‚éœ€æŸ¥çœ‹å½“å‰è®¾å¤‡æ”¯æŒçš„ç‰¹å®šåˆ†è¾¨ç‡ï¼Œè¯·å‚é˜… <a href="https://developer.android.google.cn/reference/android/hardware/camera2/params/StreamConfigurationMap?hl=zh-cn#getOutputSizes(int)"><code>StreamConfigurationMap.getOutputSizes(int)</code></a>ã€‚</p><p>å¦‚æœæ‚¨çš„åº”ç”¨åœ¨ Android 10 æˆ–æ›´é«˜ç‰ˆæœ¬ä¸Šè¿è¡Œï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ <a href="https://developer.android.google.cn/reference/android/hardware/camera2/CameraDevice?hl=zh-cn#isSessionConfigurationSupported(android.hardware.camera2.params.SessionConfiguration)"><code>isSessionConfigurationSupported()</code></a> éªŒè¯ç‰¹å®šçš„ <code>SessionConfiguration</code>ã€‚</p><h3 id="æ§åˆ¶æ‘„åƒå¤´è¾“å‡º"><a href="#æ§åˆ¶æ‘„åƒå¤´è¾“å‡º" class="headerlink" title="æ§åˆ¶æ‘„åƒå¤´è¾“å‡º"></a>æ§åˆ¶æ‘„åƒå¤´è¾“å‡º</h3><p>CameraX ä¸ä»…è®©æ‚¨å¯ä»¥è§†éœ€è¦ä¸ºæ¯ä¸ªå•ç‹¬çš„ç”¨ä¾‹é…ç½®æ‘„åƒå¤´è¾“å‡ºï¼Œè¿˜å®ç°äº†ä»¥ä¸‹æ¥å£ï¼Œä»è€Œæ”¯æŒæ‰€æœ‰ç»‘å®šç”¨ä¾‹ä¸­é€šç”¨çš„æ‘„åƒå¤´æ“ä½œï¼š</p><ul><li>åˆ©ç”¨ <a href="https://developer.android.google.cn/reference/androidx/camera/core/CameraControl?hl=zh-cn"><code>CameraControl</code></a>ï¼Œæ‚¨å¯ä»¥é…ç½®é€šç”¨æ‘„åƒå¤´åŠŸèƒ½ã€‚</li><li>åˆ©ç”¨ <a href="https://developer.android.google.cn/reference/androidx/camera/core/CameraInfo?hl=zh-cn"><code>CameraInfo</code></a>ï¼Œæ‚¨å¯ä»¥æŸ¥è¯¢è¿™äº›é€šç”¨æ‘„åƒå¤´åŠŸèƒ½çš„çŠ¶æ€ã€‚</li></ul><p>ä»¥ä¸‹æ˜¯ CameraControl æ”¯æŒçš„æ‘„åƒå¤´åŠŸèƒ½ï¼š</p><ul><li>å˜ç„¦</li><li>æ‰‹ç”µç­’</li><li>å¯¹ç„¦å’Œæµ‹å…‰ï¼ˆç‚¹æŒ‰å³å¯å¯¹ç„¦ï¼‰</li><li>æ›å…‰è¡¥å¿</li></ul><h4 id="è·å–-CameraControl-å’Œ-CameraInfo-çš„å®ä¾‹"><a href="#è·å–-CameraControl-å’Œ-CameraInfo-çš„å®ä¾‹" class="headerlink" title="è·å– CameraControl å’Œ CameraInfo çš„å®ä¾‹"></a>è·å– CameraControl å’Œ CameraInfo çš„å®ä¾‹</h4><p>ä½¿ç”¨ <a href="https://developer.android.google.cn/reference/androidx/camera/lifecycle/ProcessCameraProvider?hl=zh-cn"><code>ProcessCameraProvider.bindToLifecycle()</code></a> è¿”å›çš„ <a href="https://developer.android.google.cn/reference/androidx/camera/core/Camera?hl=zh-cn"><code>Camera</code></a> å¯¹è±¡æ£€ç´¢ <code>CameraControl</code> å’Œ <code>CameraInfo</code> çš„å®ä¾‹ã€‚ ä»¥ä¸‹ä»£ç å±•ç¤ºäº†ä¸€ä¸ªç¤ºä¾‹ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> camera = processCameraProvider.bindToLifecycle(lifecycleOwner, cameraSelector, preview)</span><br><span class="line"></span><br><span class="line"><span class="comment">// For performing operations that affect all outputs.</span></span><br><span class="line"><span class="keyword">val</span> cameraControl = camera.cameraControl</span><br><span class="line"><span class="comment">// For querying information and states.</span></span><br><span class="line"><span class="keyword">val</span> cameraInfo = camera.cameraInfo</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥åœ¨è°ƒç”¨ <code>bindToLifecycle()</code> åæäº¤å˜ç„¦æ“ä½œåŠå…¶ä»– <code>CameraControl</code> æ“ä½œã€‚å¦‚æœæ‚¨åœæ­¢æˆ–é”€æ¯ç”¨äºç»‘å®šæ‘„åƒå¤´å®ä¾‹çš„ activityï¼Œ<code>CameraControl</code> æ— æ³•å†æ‰§è¡Œæ“ä½œï¼Œå¹¶ä¸”ä¼šè¿”å›å¤±è´¥çš„ <code>ListenableFuture</code>ã€‚</p><p><strong>æ³¨æ„ï¼š</strong>å¦‚æœ <a href="https://developer.android.google.cn/reference/androidx/lifecycle/LifecycleOwner?hl=zh-cn"><code>LifecycleOwner</code></a> è¢«åœæ­¢æˆ–é”€æ¯ï¼Œ<code>Camera</code> å°±ä¼šå…³é—­ï¼Œä¹‹åå˜ç„¦ã€æ‰‹ç”µç­’ã€å¯¹ç„¦å’Œæµ‹å…‰ä»¥åŠæ›å…‰è¡¥å¿æ§ä»¶çš„æ‰€æœ‰çŠ¶æ€æ›´æ”¹å‡ä¼šè¿˜åŸæˆé»˜è®¤å€¼ã€‚</p><h4 id="å¯¹ç„¦å’Œæµ‹å…‰"><a href="#å¯¹ç„¦å’Œæµ‹å…‰" class="headerlink" title="å¯¹ç„¦å’Œæµ‹å…‰"></a>å¯¹ç„¦å’Œæµ‹å…‰</h4><p><a href="https://developer.android.google.cn/reference/androidx/camera/core/CameraControl?hl=zh-cn#setExposureCompensationIndex(int)"><code>CameraControl.startFocusAndMetering()</code></a> å¯æ ¹æ®æŒ‡å®šçš„ FocusMeteringAction è®¾ç½® AF&#x2F;AE&#x2F;AWB æµ‹å…‰åŒºåŸŸï¼Œä»¥è§¦å‘è‡ªåŠ¨å¯¹ç„¦å’Œæ›å…‰æµ‹å…‰ã€‚æœ‰è®¸å¤šæ‘„åƒå¤´åº”ç”¨é€šè¿‡è¿™ç§æ–¹å¼å®ç°â€œç‚¹æŒ‰å¯¹ç„¦â€åŠŸèƒ½ã€‚</p><p><strong>MeteringPoint</strong></p><p>é¦–å…ˆï¼Œä½¿ç”¨ <a href="https://developer.android.google.cn/reference/androidx/camera/core/MeteringPointFactory#createPoint(float,%20float,%20float)"><code>MeteringPointFactory.createPoint(float x, float y, float size)</code></a> åˆ›å»º <a href="https://developer.android.google.cn/reference/androidx/camera/core/MeteringPoint?hl=zh-cn"><code>MeteringPoint</code></a>ã€‚ <code>MeteringPoint</code> è¡¨ç¤ºæ‘„åƒå¤´ <a href="https://developer.android.google.cn/reference/android/view/Surface?hl=zh-cn"><code>Surface</code></a> ä¸Šçš„å•ä¸ªç‚¹ã€‚å®ƒä»¥æ ‡å‡†åŒ–å½¢å¼å­˜å‚¨ï¼Œæ‰€ä»¥èƒ½è½»æ¾è½¬æ¢ä¸ºä¼ æ„Ÿå™¨åæ ‡ï¼Œä»è€Œç”¨äºæŒ‡å®š AF&#x2F;AE&#x2F;AWB åŒºåŸŸã€‚</p><p><code>MeteringPoint</code> çš„å¤§å°ä»‹äº 0 åˆ° 1 ä¹‹é—´ï¼Œé»˜è®¤å¤§å°ä¸º 0.15fã€‚è°ƒç”¨ <code>MeteringPointFactory.createPoint(float x, float y, float size)</code> æ—¶ï¼ŒCameraX ä¼šä¸ºæä¾›çš„ <code>size</code> åˆ›å»ºä»¥ <code>(x, y)</code> ä¸ºä¸­å¿ƒçš„çŸ©å½¢åŒºåŸŸã€‚</p><p>ä¸‹é¢çš„ä»£ç æ¼”ç¤ºäº†å¦‚ä½•åˆ›å»º <code>MeteringPoint</code>ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Use PreviewView.getMeteringPointFactory if PreviewView is used for preview.</span></span><br><span class="line">previewView.setOnTouchListener((view, motionEvent) -&gt;  &#123;</span><br><span class="line"><span class="keyword">val</span> meteringPoint = previewView.meteringPointFactory</span><br><span class="line">    .createPoint(motionEvent.x, motionEvent.y)</span><br><span class="line">â€¦</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Use DisplayOrientedMeteringPointFactory if SurfaceView / TextureView is used for</span></span><br><span class="line"><span class="comment">// preview. Please note that if the preview is scaled or cropped in the View,</span></span><br><span class="line"><span class="comment">// itâ€™s the application&#x27;s responsibility to transform the coordinates properly</span></span><br><span class="line"><span class="comment">// so that the width and height of this factory represents the full Preview FOV.</span></span><br><span class="line"><span class="comment">// And the (x,y) passed to create MeteringPoint might need to be adjusted with</span></span><br><span class="line"><span class="comment">// the offsets.</span></span><br><span class="line"><span class="keyword">val</span> meteringPointFactory = DisplayOrientedMeteringPointFactory(</span><br><span class="line">     surfaceView.display,</span><br><span class="line">     camera.cameraInfo,</span><br><span class="line">     surfaceView.width,</span><br><span class="line">     surfaceView.height</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Use SurfaceOrientedMeteringPointFactory if the point is specified in</span></span><br><span class="line"><span class="comment">// ImageAnalysis ImageProxy.</span></span><br><span class="line"><span class="keyword">val</span> meteringPointFactory = SurfaceOrientedMeteringPointFactory(</span><br><span class="line">     imageWidth,</span><br><span class="line">     imageHeight,</span><br><span class="line">     imageAnalysis)</span><br></pre></td></tr></table></figure><p><strong>startFocusAndMetering å’Œ FocusMeteringAction</strong></p><p>å¦‚éœ€è°ƒç”¨ <a href="https://developer.android.google.cn/reference/androidx/camera/core/CameraControl?hl=zh-cn#startFocusAndMetering(androidx.camera.core.FocusMeteringAction)"><code>startFocusAndMetering()</code></a>ï¼Œåº”ç”¨å¿…é¡»æ„å»º <a href="https://developer.android.google.cn/reference/androidx/camera/core/FocusMeteringAction?hl=zh-cn"><code>FocusMeteringAction</code></a>ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª <code>MeteringPoints</code>ï¼Œåè€…ç”± <a href="https://developer.android.google.cn/reference/androidx/camera/core/FocusMeteringAction?hl=zh-cn#FLAG_AF"><code>FLAG_AF</code></a>ã€<a href="https://developer.android.google.cn/reference/androidx/camera/core/FocusMeteringAction?hl=zh-cn#FLAG_AE"><code>FLAG_AE</code></a>ã€<a href="https://developer.android.google.cn/reference/androidx/camera/core/FocusMeteringAction?hl=zh-cn#FLAG_AWB"><code>FLAG_AWB</code></a> è¿™äº›å¯é€‰æµ‹å…‰æ¨¡å¼ç»„åˆè€Œæˆã€‚ä¸‹é¢çš„ä»£ç æ¼”ç¤ºäº†è¿™ä¸€ç”¨æ³•ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> meteringPoint1 = meteringPointFactory.createPoint(x1, x1)</span><br><span class="line"><span class="keyword">val</span> meteringPoint2 = meteringPointFactory.createPoint(x2, y2)</span><br><span class="line"><span class="keyword">val</span> action = FocusMeteringAction.Builder(meteringPoint1) <span class="comment">// default AF|AE|AWB</span></span><br><span class="line">      <span class="comment">// Optionally add meteringPoint2 for AF/AE.</span></span><br><span class="line">      .addPoint(meteringPoint2, FLAG_AF | FLAG_AE)</span><br><span class="line">      <span class="comment">// The action is canceled in 3 seconds (if not set, default is 5s).</span></span><br><span class="line">      .setAutoCancelDuration(<span class="number">3</span>, TimeUnit.SECONDS)</span><br><span class="line">      .build()</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> result = cameraControl.startFocusAndMetering(action)</span><br><span class="line"><span class="comment">// Adds listener to the ListenableFuture if you need to know the focusMetering result.</span></span><br><span class="line">result.addListener(&#123;</span><br><span class="line">   <span class="comment">// result.get().isFocusSuccessful returns if the auto focus is successful or not.</span></span><br><span class="line">&#125;, ContextCompat.getMainExecutor(<span class="keyword">this</span>)</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šé¢çš„ä»£ç æ‰€ç¤ºï¼Œ<a href="https://developer.android.google.cn/reference/androidx/camera/core/CameraControl?hl=zh-cn#startFocusAndMetering(androidx.camera.core.FocusMeteringAction)"><code>startFocusAndMetering()</code></a> æ¥å—ä¸€ä¸ª <code>FocusMeteringAction</code>ï¼Œåè€…åŒ…å«ä¸€ä¸ªç”¨äº AF&#x2F;AE&#x2F;AWB æµ‹å…‰åŒºåŸŸçš„ <code>MeteringPoint</code>ï¼Œä»¥åŠå¦ä¸€ä¸ªä»…ç”¨äº AF å’Œ AE çš„ MeteringPointã€‚</p><p>åœ¨å†…éƒ¨ï¼ŒCameraX ä¼šå°†å…¶è½¬æ¢ä¸º Camera2 <a href="https://developer.android.google.cn/reference/android/hardware/camera2/params/MeteringRectangle?hl=zh-cn"><code>MeteringRectangles</code></a>ï¼Œå¹¶å°†ç›¸åº”çš„ <a href="https://developer.android.google.cn/reference/android/hardware/camera2/CaptureRequest?hl=zh-cn#CONTROL_AF_REGIONS"><code>CONTROL_AF_REGIONS</code></a>&#x2F;<a href="https://developer.android.google.cn/reference/android/hardware/camera2/CaptureRequest?hl=zh-cn#CONTROL_AE_REGIONS"><code>CONTROL_AE_REGIONS</code></a>&#x2F;<a href="https://developer.android.google.cn/reference/android/hardware/camera2/CaptureRequest?hl=zh-cn#CONTROL_AWB_REGIONS"><code>CONTROL_AWB_REGIONS</code></a> å‚æ•°è®¾ç½®ä¸ºæ‹æ‘„è¯·æ±‚ã€‚</p><p>ç”±äºå¹¶éæ‰€æœ‰è®¾å¤‡éƒ½æ”¯æŒ AF&#x2F;AE&#x2F;AWB å’Œå¤šä¸ªåŒºåŸŸï¼ŒCameraX ä¼šå°½æœ€å¤§åŠªåŠ›æ‰§è¡Œ <code>FocusMeteringAction</code>ã€‚CameraX ä¼šä½¿ç”¨æ‰€æ”¯æŒçš„æœ€å¤§æ•°é‡çš„ MeteringPointï¼Œå¹¶æŒ‰æµ‹å…‰ç‚¹çš„æ·»åŠ é¡ºåºä¾æ¬¡ä½¿ç”¨ã€‚å¯¹äºåœ¨è¶…å‡ºæ”¯æŒçš„æœ€å¤§æ•°é‡ä¹‹å¤–æ·»åŠ çš„æ‰€æœ‰ MeteringPointï¼ŒCameraX ä¼šä¸€å¾‹å¿½ç•¥ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨åœ¨ä»…æ”¯æŒ 2 ä¸ª MeteringPoint çš„å¹³å°ä¸Šä¸º <code>FocusMeteringAction</code> æä¾› 3 ä¸ª MeteringPointï¼Œé‚£ä¹ˆ CameraX åªä¼šä½¿ç”¨å‰ 2 ä¸ª MeteringPointï¼Œå¹¶å¿½ç•¥æœ€åä¸€ä¸ª <code>MeteringPoint</code>ã€‚</p><h2 id="å›¾åƒåˆ†æ"><a href="#å›¾åƒåˆ†æ" class="headerlink" title="å›¾åƒåˆ†æ"></a>å›¾åƒåˆ†æ</h2><p><a href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis.Analyzer?hl=zh-cn#analyze(androidx.camera.core.ImageProxy)">å›¾åƒåˆ†æ</a>ç”¨ä¾‹ä¸ºæ‚¨çš„åº”ç”¨æä¾›å¯ä¾› CPU è®¿é—®çš„å›¾åƒï¼Œæ‚¨å¯ä»¥å¯¹è¿™äº›å›¾åƒæ‰§è¡Œå›¾åƒå¤„ç†ã€è®¡ç®—æœºè§†è§‰æˆ–æœºå™¨å­¦ä¹ æ¨æ–­ã€‚åº”ç”¨ä¼šå®ç°å¯¹æ¯ä¸ªå¸§è¿è¡Œçš„ <a href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis.Analyzer?hl=zh-cn#analyze(androidx.camera.core.ImageProxy)"><code>analyze()</code></a> æ–¹æ³•ã€‚</p><p>å¦‚éœ€äº†è§£å¦‚ä½•å°† Google çš„æœºå™¨å­¦ä¹ å¥—ä»¶ä¸ CameraX åº”ç”¨é›†æˆï¼Œè¯·å‚é˜…<a href="https://developer.android.google.cn/training/camerax/mlkitanalyzer?hl=zh-cn">æœºå™¨å­¦ä¹ å¥—ä»¶åˆ†æå™¨</a>ã€‚</p><h3 id="æ“ä½œæ¨¡å¼"><a href="#æ“ä½œæ¨¡å¼" class="headerlink" title="æ“ä½œæ¨¡å¼"></a>æ“ä½œæ¨¡å¼</h3><p>å½“åº”ç”¨çš„åˆ†ææµæ°´çº¿æ— æ³•æ»¡è¶³ CameraX çš„å¸§é€Ÿç‡è¦æ±‚æ—¶ï¼Œæ‚¨å¯ä»¥å°† CameraX é…ç½®ä¸ºé€šè¿‡ä»¥ä¸‹å…¶ä¸­ä¸€ç§æ–¹å¼ä¸¢å¸§ï¼š</p><ul><li><strong>éé˜»å¡</strong>ï¼ˆé»˜è®¤ï¼‰ï¼šåœ¨è¯¥æ¨¡å¼ä¸‹ï¼Œæ‰§è¡Œå™¨å§‹ç»ˆä¼šå°†æœ€æ–°çš„å›¾åƒç¼“å­˜åˆ°å›¾åƒç¼“å†²åŒºï¼ˆä¸æ·±åº¦ä¸º 1 çš„é˜Ÿåˆ—ç›¸ä¼¼ï¼‰ï¼Œä¸æ­¤åŒæ—¶ï¼Œåº”ç”¨ä¼šåˆ†æä¸Šä¸€ä¸ªå›¾åƒã€‚å¦‚æœ CameraX åœ¨åº”ç”¨å®Œæˆå¤„ç†ä¹‹å‰æ”¶åˆ°æ–°å›¾åƒï¼Œåˆ™æ–°å›¾åƒä¼šä¿å­˜åˆ°åŒä¸€ç¼“å†²åŒºï¼Œå¹¶è¦†ç›–ä¸Šä¸€ä¸ªå›¾åƒã€‚ è¯·æ³¨æ„ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<code>ImageAnalysis.Builder.setImageQueueDepth()</code> ä¸èµ·ä»»ä½•ä½œç”¨ï¼Œç¼“å†²åŒºå†…å®¹å§‹ç»ˆä¼šè¢«è¦†ç›–ã€‚æ‚¨å¯ä»¥é€šè¿‡ä½¿ç”¨ <a href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis?hl=zh-cn#STRATEGY_KEEP_ONLY_LATEST"><code>STRATEGY_KEEP_ONLY_LATEST</code></a> è°ƒç”¨ <code>setBackpressureStrategy()</code> æ¥å¯ç”¨è¯¥éé˜»å¡æ¨¡å¼ã€‚å¦‚éœ€è¯¦ç»†äº†è§£æ‰§è¡Œå™¨çš„ç›¸å…³å½±å“ï¼Œè¯·å‚é˜… <a href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis?hl=zh-cn#STRATEGY_KEEP_ONLY_LATEST"><code>STRATEGY_KEEP_ONLY_LATEST</code></a> çš„å‚è€ƒæ–‡æ¡£ã€‚</li><li><strong>é˜»å¡</strong>ï¼šåœ¨è¯¥æ¨¡å¼ä¸‹ï¼Œå†…éƒ¨æ‰§è¡Œå™¨å¯ä»¥å‘å†…éƒ¨å›¾åƒé˜Ÿåˆ—æ·»åŠ å¤šä¸ªå›¾åƒï¼Œå¹¶ä»…åœ¨é˜Ÿåˆ—å·²æ»¡æ—¶æ‰å¼€å§‹ä¸¢å¸§ã€‚ç³»ç»Ÿä¼šåœ¨æ•´ä¸ªç›¸æœºè®¾å¤‡ä¸Šè¿›è¡Œå±è”½ï¼šå¦‚æœç›¸æœºè®¾å¤‡å…·æœ‰å¤šä¸ªç»‘å®šç”¨ä¾‹ï¼Œé‚£ä¹ˆåœ¨ CameraX å¤„ç†è¿™äº›å›¾åƒæ—¶ï¼Œç³»ç»Ÿä¼šå±è”½æ‰€æœ‰è¿™äº›ç”¨ä¾‹ã€‚ä¾‹å¦‚ï¼Œå¦‚æœé¢„è§ˆå’Œå›¾åƒåˆ†æéƒ½å·²ç»‘å®šåˆ°æŸä¸ªç›¸æœºè®¾å¤‡ï¼Œé‚£ä¹ˆåœ¨ CameraX å¤„ç†å›¾åƒæ—¶ï¼Œç³»ç»Ÿä¹Ÿä¼šå±è”½ç›¸åº”é¢„è§ˆã€‚æ‚¨å¯ä»¥é€šè¿‡å°† <a href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis?hl=zh-cn#strategy_block_producer"><code>STRATEGY_BLOCK_PRODUCER</code></a> ä¼ é€’åˆ° <a href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis.Builder?hl=zh-cn#setBackpressureStrategy(int)"><code>setBackpressureStrategy()</code></a> æ¥å¯ç”¨é˜»å¡æ¨¡å¼ã€‚æ­¤å¤–ï¼Œæ‚¨è¿˜å¯ä»¥é€šè¿‡ä½¿ç”¨ <a href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis.Builder?hl=zh-cn#setImageQueueDepth(int)">ImageAnalysis.Builder.setImageQueueDepth()</a> æ¥é…ç½®å›¾åƒé˜Ÿåˆ—æ·±åº¦ã€‚</li></ul><p>å¦‚æœåˆ†æå™¨å»¶è¿Ÿä½ä¸”æ€§èƒ½é«˜ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ç”¨äºåˆ†æå›¾åƒçš„æ€»æ—¶é—´ä½äº CameraX å¸§çš„æ—¶é•¿ï¼ˆä¾‹å¦‚ï¼Œ60fps ç”¨æ—¶ 16 æ¯«ç§’ï¼‰ï¼Œé‚£ä¹ˆä¸Šè¿°ä¸¤ç§æ“ä½œæ¨¡å¼å‡å¯æä¾›é¡ºç•…çš„æ€»ä½“ä½“éªŒã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œé˜»å¡æ¨¡å¼ä»éå¸¸æœ‰ç”¨ï¼Œä¾‹å¦‚åœ¨å¤„ç†éå¸¸çŸ­æš‚çš„ç³»ç»ŸæŠ–åŠ¨æ—¶ã€‚</p><p>å¦‚æœåˆ†æå™¨å»¶è¿Ÿé«˜ä¸”æ€§èƒ½é«˜ï¼Œåˆ™éœ€è¦ç»“åˆä½¿ç”¨é˜»å¡æ¨¡å¼å’Œè¾ƒé•¿çš„é˜Ÿåˆ—æ¥æŠµè¡¥å»¶è¿Ÿã€‚ä½†è¯·æ³¨æ„ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåº”ç”¨ä»å¯ä»¥å¤„ç†æ‰€æœ‰å¸§ã€‚</p><p>å¦‚æœåˆ†æå™¨å»¶è¿Ÿé«˜ä¸”è€—æ—¶é•¿ï¼ˆåˆ†æå™¨æ— æ³•å¤„ç†æ‰€æœ‰å¸§ï¼‰ï¼Œéé˜»å¡æ¨¡å¼å¯èƒ½æ›´ä¸ºé€‚ç”¨ï¼Œå› ä¸ºåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç³»ç»Ÿå¿…é¡»é’ˆå¯¹åˆ†æè·¯å¾„è¿›è¡Œä¸¢å¸§ï¼Œä½†è¦è®©å…¶ä»–åŒæ—¶ç»‘å®šçš„ç”¨ä¾‹ä»èƒ½çœ‹åˆ°æ‰€æœ‰å¸§ã€‚</p><h3 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h3><p>å¦‚éœ€åœ¨æ‚¨çš„åº”ç”¨ä¸­ä½¿ç”¨å›¾åƒåˆ†æï¼Œè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š</p><ul><li>æ„å»º <a href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis?hl=zh-cn"><code>ImageAnalysis</code></a> ç”¨ä¾‹ã€‚</li><li>åˆ›å»º <a href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis.Analyzer?hl=zh-cn"><code>ImageAnalysis.Analyzer</code></a>ã€‚</li><li><a href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis#setAnalyzer(java.util.concurrent.Executor,%20androidx.camera.core.ImageAnalysis.Analyzer)">å°†åˆ†æå™¨è®¾ä¸º</a> <code>ImageAnalysis</code>ã€‚</li><li>å°†ç”Ÿå‘½å‘¨æœŸæ‰€æœ‰è€…ã€ç›¸æœºé€‰æ‹©å™¨å’Œ <code>ImageAnalysis</code> ç”¨ä¾‹<a href="https://developer.android.google.cn/reference/androidx/camera/lifecycle/ProcessCameraProvider#bindToLifecycle(androidx.lifecycle.LifecycleOwner,%20androidx.camera.core.CameraSelector,%20androidx.camera.core.UseCase...)">ç»‘å®š</a>åˆ°ç”Ÿå‘½å‘¨æœŸã€‚</li></ul><p>ç»‘å®šåï¼ŒCameraX ä¼šç«‹å³å°†å›¾åƒå‘é€åˆ°å·²æ³¨å†Œçš„åˆ†æå™¨ã€‚ å®Œæˆåˆ†æåï¼Œè°ƒç”¨ <a href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis?hl=zh-cn#clearAnalyzer()"><code>ImageAnalysis.clearAnalyzer()</code></a> æˆ–è§£é™¤ç»‘å®š <code>ImageAnalysis</code> ç”¨ä¾‹ä»¥åœæ­¢åˆ†æã€‚</p><h4 id="æ„å»º-ImageAnalysis-ç”¨ä¾‹"><a href="#æ„å»º-ImageAnalysis-ç”¨ä¾‹" class="headerlink" title="æ„å»º ImageAnalysis ç”¨ä¾‹"></a>æ„å»º ImageAnalysis ç”¨ä¾‹</h4><p><a href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis?hl=zh-cn"><code>ImageAnalysis</code></a> å¯å°†åˆ†æå™¨ï¼ˆå›¾åƒä½¿ç”¨æ–¹ï¼‰è¿æ¥åˆ° CameraXï¼ˆå›¾åƒç”Ÿæˆæ–¹ï¼‰ã€‚åº”ç”¨å¯ä»¥ä½¿ç”¨ <a href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis.Builder?hl=zh-cn"><code>ImageAnalysis.Builder</code></a> æ¥æ„å»º <code>ImageAnalysis</code> å¯¹è±¡ã€‚å€ŸåŠ© <code>ImageAnalysis.Builder</code>ï¼Œåº”ç”¨å¯ä»¥è¿›è¡Œä»¥ä¸‹é…ç½®ï¼š</p><ul><li>å›¾åƒè¾“å‡ºå‚æ•°ï¼š<ul><li>æ ¼å¼ï¼šCameraX å¯é€šè¿‡ <a href="https://developer.android.google.cn/reference/kotlin/androidx/camera/core/ImageAnalysis.Builder?hl=zh-cn#setOutputImageFormat(kotlin.Int)"><code>setOutputImageFormat(int)</code></a> æ”¯æŒ <a href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis?hl=zh-cn#OUTPUT_IMAGE_FORMAT_YUV_420_888"><code>YUV_420_888</code></a> å’Œ <a href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis?hl=zh-cn#OUTPUT_IMAGE_FORMAT_RGBA_8888"><code>RGBA_8888</code></a>ã€‚é»˜è®¤æ ¼å¼ä¸º <code>YUV_420_888</code>ã€‚</li><li><a href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis.Builder?hl=zh-cn#setTargetResolution(android.util.Size)">Resolution</a> å’Œ <a href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis.Builder?hl=zh-cn#setTargetAspectRatio(int)">AspectRatio</a>ï¼šæ‚¨å¯ä»¥è®¾ç½®å…¶ä¸­ä¸€ä¸ªå‚æ•°ï¼Œä½†è¯·æ³¨æ„ï¼Œæ‚¨ä¸èƒ½åŒæ—¶è®¾ç½®è¿™ä¸¤ä¸ªå€¼ã€‚</li><li><a href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis.Builder?hl=zh-cn#setTargetRotation(int)">æ—‹è½¬è§’åº¦</a>ã€‚</li><li><a href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis.Builder?hl=zh-cn#setTargetName(java.lang.String)">ç›®æ ‡åç§°</a>ï¼šä½¿ç”¨è¯¥å‚æ•°è¿›è¡Œè°ƒè¯•ã€‚</li></ul></li><li>å›¾åƒæµæ§åˆ¶ï¼š<ul><li><a href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis.Builder?hl=zh-cn#setBackgroundExecutor(java.util.concurrent.Executor)">åå°æ‰§è¡Œå™¨</a></li><li><a href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis.Builder?hl=zh-cn#setImageQueueDepth(int)">å›¾åƒé˜Ÿåˆ—æ·±åº¦ï¼ˆåˆ†æå™¨å’Œ CamaraX ä¹‹é—´ï¼‰</a></li><li><a href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis.Builder?hl=zh-cn#setBackpressureStrategy(int)">èƒŒå‹ç­–ç•¥</a></li></ul></li></ul><p>åº”ç”¨å¯ä»¥è®¾ç½®åˆ†è¾¨ç‡æˆ–å®½é«˜æ¯”ï¼Œä½†ä¸èƒ½åŒæ—¶è®¾ç½®è¿™ä¸¤ä¸ªå€¼ã€‚ç¡®åˆ‡çš„è¾“å‡ºåˆ†è¾¨ç‡å–å†³äºåº”ç”¨è¯·æ±‚çš„å¤§å°ï¼ˆæˆ–å®½é«˜æ¯”ï¼‰å’Œç¡¬ä»¶åŠŸèƒ½ï¼Œå¹¶å¯èƒ½ä¸è¯·æ±‚çš„å¤§å°æˆ–å®½é«˜æ¯”ä¸åŒã€‚å¦‚éœ€äº†è§£åˆ†è¾¨ç‡åŒ¹é…ç®—æ³•ï¼Œè¯·å‚é˜…æœ‰å…³ <a href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis.Builder?hl=zh-cn#setTargetResolution(android.util.Size)"><code>setTargetResolution()</code></a> çš„æ–‡æ¡£</p><p>åº”ç”¨å¯ä»¥å°†è¾“å‡ºå›¾åƒåƒç´ é…ç½®ä¸ºé‡‡ç”¨ YUVï¼ˆé»˜è®¤ï¼‰æˆ– RGBA é¢œè‰²ç©ºé—´ã€‚è®¾ç½® RGBA è¾“å‡ºæ ¼å¼æ—¶ï¼ŒCameraX ä¼šåœ¨å†…éƒ¨å°†å›¾åƒä» YUV é¢œè‰²ç©ºé—´è½¬æ¢ä¸º RGBA é¢œè‰²ç©ºé—´ï¼Œå¹¶å°†å›¾åƒä½æ‰“åŒ…åˆ° ImageProxy ç¬¬ä¸€ä¸ªå¹³é¢ï¼ˆå…¶ä»–ä¸¤ä¸ªå¹³é¢æœªä½¿ç”¨ï¼‰çš„ <a href="https://developer.android.google.cn/reference/androidx/camera/core/ImageProxy.PlaneProxy?hl=zh-cn#getBuffer()"><code>ByteBuffer</code></a> ä¸­ï¼Œåºåˆ—å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ImageProxy.getPlanes()[0].buffer[0]: alpha</span><br><span class="line">ImageProxy.getPlanes()[0].buffer[1]: red</span><br><span class="line">ImageProxy.getPlanes()[0].buffer[2]: green</span><br><span class="line">ImageProxy.getPlanes()[0].buffer[3]: blue</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>åœ¨æ‰§è¡Œè®¾å¤‡æ— æ³•æ»¡è¶³å¸§é€Ÿç‡è¦æ±‚çš„å¤æ‚å›¾åƒåˆ†ææ—¶ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æœ¬ä¸»é¢˜çš„<a href="https://developer.android.google.cn/training/camerax/analyze?hl=zh-cn#operating_modes">æ“ä½œæ¨¡å¼</a>éƒ¨åˆ†æ‰€è¿°çš„ç­–ç•¥å°† CameraX é…ç½®ä¸ºä¸¢å¸§ã€‚</p><h4 id="åˆ›å»ºåˆ†æå™¨"><a href="#åˆ›å»ºåˆ†æå™¨" class="headerlink" title="åˆ›å»ºåˆ†æå™¨"></a>åˆ›å»ºåˆ†æå™¨</h4><p>åº”ç”¨å¯ä»¥é€šè¿‡å®ç° <a href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis.Analyzer?hl=zh-cn"><code>ImageAnalysis.Analyzer</code></a> æ¥å£å¹¶æ›¿æ¢ <a href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis.Analyzer?hl=zh-cn#analyze(androidx.camera.core.ImageProxy)"><code>analyze(ImageProxy image)</code></a> æ¥åˆ›å»ºåˆ†æå™¨ã€‚ åœ¨æ¯ä¸ªåˆ†æå™¨ä¸­ï¼Œåº”ç”¨éƒ½ä¼šæ”¶åˆ°ä¸€ä¸ª <a href="https://developer.android.google.cn/reference/androidx/camera/core/ImageProxy?hl=zh-cn"><code>ImageProxy</code></a>ï¼Œå®ƒæ˜¯ <a href="https://developer.android.google.cn/reference/android/media/Image?hl=zh-cn">Media.Image</a> çš„å°è£…å®¹å™¨ã€‚å¯ä»¥ä½¿ç”¨ <a href="https://developer.android.google.cn/reference/androidx/camera/core/ImageProxy?hl=zh-cn#getFormat()"><code>ImageProxy.getFormat()</code></a> æ¥æŸ¥è¯¢å›¾åƒæ ¼å¼ã€‚è¯¥æ ¼å¼ä½¿ç”¨åº”ç”¨é€šè¿‡ <code>ImageAnalysis.Builder</code> æä¾›çš„ä»¥ä¸‹å€¼ä¹‹ä¸€è¡¨ç¤ºï¼š</p><ul><li>å¦‚æœåº”ç”¨è¯·æ±‚äº† <code>OUTPUT_IMAGE_FORMAT_RGBA_8888</code>ï¼Œåˆ™ä¸º <code>ImageFormat.RGBA_8888</code>ã€‚</li><li>å¦‚æœåº”ç”¨è¯·æ±‚äº† <code>OUTPUT_IMAGE_FORMAT_YUV_420_888</code>ï¼Œåˆ™ä¸º <code>ImageFormat.YUV_420_888</code>ã€‚</li></ul><p>å¦‚éœ€äº†è§£é¢œè‰²ç©ºé—´é…ç½®ä»¥åŠå¯æ£€ç´¢åƒç´ å­—èŠ‚çš„ä½ç½®ï¼Œè¯·å‚é˜…<a href="https://developer.android.google.cn/training/camerax/analyze?hl=zh-cn#build_imageanalysis_use_case">æ„å»º ImageAnalysis ç”¨ä¾‹</a>ã€‚</p><p>åœ¨åˆ†æå™¨ä¸­ï¼Œåº”ç”¨åº”æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p><ol><li>å°½å¿«åˆ†æç»™å®šçš„å¸§ï¼Œæœ€å¥½åœ¨ç»™å®šçš„å¸§é€Ÿç‡æ—¶é—´é™åˆ¶å†…è¿›è¡Œåˆ†æï¼ˆä¾‹å¦‚ï¼Œå¦‚æœå¸§é€Ÿç‡ä¸º 30 fpsï¼Œåˆ™ç”¨æ—¶åº”ä½äº 32 æ¯«ç§’ï¼‰ã€‚å¦‚æœåº”ç”¨æ— æ³•è¶³å¤Ÿå¿«åœ°åˆ†æå¸§ï¼Œè¯·è€ƒè™‘é‡‡ç”¨ä¸€ç§<a href="https://developer.android.google.cn/training/camerax/analyze?hl=zh-cn#operating_modes">å—æ”¯æŒçš„ä¸¢å¸§æœºåˆ¶</a>ã€‚</li><li>é€šè¿‡è°ƒç”¨ <a href="https://developer.android.google.cn/reference/androidx/camera/core/ImageProxy?hl=zh-cn#close()"><code>ImageProxy.close()</code></a> å°† <code>ImageProxy</code> å‘å¸ƒåˆ° CameraXã€‚è¯·æ³¨æ„ï¼Œæ‚¨ä¸åº”è°ƒç”¨å·²å°è£… Media.Image çš„ close å‡½æ•° (<code>Media.Image.close()</code>)ã€‚</li></ol><p>åº”ç”¨å¯ä»¥ç›´æ¥ä½¿ç”¨ ImageProxy ä¸­çš„å·²å°è£… <code>Media.Image</code>ã€‚ è¯·ä¸è¦å¯¹å·²å°è£…çš„å›¾åƒè°ƒç”¨ <code>Media.Image.close()</code>ï¼Œå› ä¸ºè¿™ä¼šç ´å CameraX ä¸­çš„å›¾åƒåˆ†äº«æœºåˆ¶ï¼›è¯·æ”¹ä¸ºä½¿ç”¨ <a href="https://developer.android.google.cn/reference/androidx/camera/core/ImageProxy?hl=zh-cn#close()"><code>ImageProxy.close()</code></a> å°†åº•å±‚ <code>Media.Image</code> å‘å¸ƒåˆ° CameraXã€‚</p><h4 id="é’ˆå¯¹-ImageAnalysis-é…ç½®åˆ†æå™¨"><a href="#é’ˆå¯¹-ImageAnalysis-é…ç½®åˆ†æå™¨" class="headerlink" title="é’ˆå¯¹ ImageAnalysis é…ç½®åˆ†æå™¨"></a>é’ˆå¯¹ ImageAnalysis é…ç½®åˆ†æå™¨</h4><p>åˆ›å»ºåˆ†æå™¨åï¼Œä½¿ç”¨ <a href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis#setAnalyzer(java.util.concurrent.Executor,%20androidx.camera.core.ImageAnalysis.Analyzer)"><code>ImageAnalysis.setAnalyzer()</code></a> æ³¨å†Œè¯¥åˆ†æå™¨ä»¥å¼€å§‹åˆ†æã€‚å®Œæˆåˆ†æåï¼Œä½¿ç”¨ <a href="https://developer.android.google.cn/reference/androidx/camera/core/ImageAnalysis?hl=zh-cn#clearAnalyzer()"><code>ImageAnalysis.clearAnalyzer()</code></a> ç§»é™¤å·²æ³¨å†Œçš„åˆ†æå™¨ã€‚</p><p>æ‚¨åªèƒ½å°†ä¸€ä¸ªåˆ†æå™¨é…ç½®ä¸ºæ´»åŠ¨çŠ¶æ€ï¼Œç”¨äºåˆ†æå›¾åƒã€‚è°ƒç”¨ <code>ImageAnalysis.setAnalyzer()</code> ä¼šæ›¿æ¢å·²æ³¨å†Œçš„åˆ†æå™¨ï¼ˆå¦‚æœå·²å­˜åœ¨è¯¥åˆ†æå™¨ï¼‰ã€‚åº”ç”¨å¯ä»¥åœ¨ç»‘å®šç”¨ä¾‹ä¹‹å‰æˆ–ä¹‹åéšæ—¶è®¾ç½®æ–°çš„åˆ†æå™¨ã€‚</p><h4 id="å°†-ImageAnalysis-ç»‘å®šåˆ°ç”Ÿå‘½å‘¨æœŸ"><a href="#å°†-ImageAnalysis-ç»‘å®šåˆ°ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="å°† ImageAnalysis ç»‘å®šåˆ°ç”Ÿå‘½å‘¨æœŸ"></a>å°† ImageAnalysis ç»‘å®šåˆ°ç”Ÿå‘½å‘¨æœŸ</h4><p><strong>æ³¨æ„</strong>ï¼šè¯¥æ­¥éª¤é€‚ç”¨äºæ‰€æœ‰ CameraX ç”¨ä¾‹ã€‚å¦‚éœ€è¯¦ç»†äº†è§£ç»‘å®šå’Œç”Ÿå‘½å‘¨æœŸè‡ªå®šä¹‰ï¼Œè¯·å‚é˜… <a href="https://developer.android.google.cn/training/camerax/architecture?hl=zh-cn#api-model">CameraX API æ¨¡å‹</a>ã€‚</p><p>å¼ºçƒˆå»ºè®®æ‚¨ä½¿ç”¨ <a href="https://developer.android.google.cn/reference/androidx/camera/lifecycle/ProcessCameraProvider#bindToLifecycle(androidx.lifecycle.LifecycleOwner,%20androidx.camera.core.CameraSelector,%20androidx.camera.core.UseCase...)"><code>ProcessCameraProvider.bindToLifecycle()</code></a> å‡½æ•°å°† <code>ImageAnalysis</code> ç»‘å®šåˆ°ç°æœ‰çš„ AndroidX ç”Ÿå‘½å‘¨æœŸã€‚è¯·æ³¨æ„ï¼Œ<code>bindToLifecycle()</code> å‡½æ•°ä¼šè¿”å›é€‰å®šçš„ <a href="https://developer.android.google.cn/reference/androidx/camera/core/Camera?hl=zh-cn"><code>Camera</code></a> è®¾å¤‡ï¼Œè¯¥å‡½æ•°å¯ç”¨äºå¾®è°ƒæ›å…‰ç­‰é«˜çº§è®¾ç½®ã€‚å¦‚éœ€è¯¦ç»†äº†è§£å¦‚ä½•æ§åˆ¶ç›¸æœºè¾“å‡ºï¼Œè¯·å‚é˜…<a href="https://developer.android.google.cn/training/camerax/configuration?hl=zh-cn#camera-output">æ­¤æŒ‡å—</a>ã€‚</p><p>ä»¥ä¸‹ç¤ºä¾‹ç»“åˆäº†ä¸Šè¿°æ­¥éª¤ä¸­çš„æ‰€æœ‰æ“ä½œï¼Œå°† CameraX <code>ImageAnalysis</code> å’Œ <code>Preview</code> ç”¨ä¾‹ç»‘å®šåˆ°äº† <code>lifeCycle</code> æ‰€æœ‰è€…ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> imageAnalysis = ImageAnalysis.Builder()</span><br><span class="line">    <span class="comment">// enable the following line if RGBA output is needed.</span></span><br><span class="line">    <span class="comment">// .setOutputImageFormat(ImageAnalysis.OUTPUT_IMAGE_FORMAT_RGBA_8888)</span></span><br><span class="line">    .setTargetResolution(Size(<span class="number">1280</span>, <span class="number">720</span>))</span><br><span class="line">    .setBackpressureStrategy(ImageAnalysis.STRATEGY_KEEP_ONLY_LATEST)</span><br><span class="line">    .build()</span><br><span class="line">imageAnalysis.setAnalyzer(executor, ImageAnalysis.Analyzer &#123; imageProxy -&gt;</span><br><span class="line">    <span class="keyword">val</span> rotationDegrees = imageProxy.imageInfo.rotationDegrees</span><br><span class="line">    <span class="comment">// insert your code here.</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// after done, release the ImageProxy object</span></span><br><span class="line">    imageProxy.close()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">cameraProvider.bindToLifecycle(<span class="keyword">this</span> <span class="keyword">as</span> LifecycleOwner, cameraSelector, imageAnalysis, preview)</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://developer.android.google.cn/training/camerax">Android CameraX</a></p>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
          <category> CameraX </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> CameraX </tag>
            
            <tag> Jetpack </tag>
            
            <tag> ç›¸æœº </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä½¿ç”¨ sourceSets ç®¡ç†é£å‘³ç‰¹å®šçš„ AndroidManifest.xml</title>
      <link href="/post/b3b8a43c.html"/>
      <url>/post/b3b8a43c.html</url>
      
        <content type="html"><![CDATA[<p>å½“ä½¿ç”¨ <code>sourceSets</code> ç®¡ç†é£å‘³ç‰¹å®šçš„ <code>AndroidManifest.xml</code> é…ç½®æ—¶ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªåŸºæœ¬çš„ä»£ç ç¤ºä¾‹</p><h2 id="é¡¹ç›®ç»“æ„"><a href="#é¡¹ç›®ç»“æ„" class="headerlink" title="é¡¹ç›®ç»“æ„"></a>é¡¹ç›®ç»“æ„</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">app/</span><br><span class="line">|-- src/</span><br><span class="line">|   |-- main/</span><br><span class="line">|   |   |-- AndroidManifest.xml (åŒ…å«å…¬ç”¨é…ç½®)</span><br><span class="line">|   |   |-- java/</span><br><span class="line">|   |   |-- res/</span><br><span class="line">|   |</span><br><span class="line">|   |-- xiaomi/</span><br><span class="line">|   |   |-- AndroidManifest.xml (é£å‘³ç‰¹å®šé…ç½®)</span><br><span class="line">|   |</span><br><span class="line">|   |-- other/</span><br><span class="line">|   |   |-- AndroidManifest.xml (é£å‘³ç‰¹å®šé…ç½®)</span><br><span class="line">|   |</span><br><span class="line">|   |-- ...</span><br></pre></td></tr></table></figure><h2 id="app-build-gradle"><a href="#app-build-gradle" class="headerlink" title="app&#x2F;build.gradle"></a>app&#x2F;build.gradle</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    <span class="comment">// ... å…¶ä»–é…ç½® ...</span></span><br><span class="line"></span><br><span class="line">    sourceSets &#123;</span><br><span class="line">        xiaomi &#123;</span><br><span class="line">            <span class="comment">// æŒ‡å®šé£å‘³ç‰¹å®šçš„ AndroidManifest.xml æ–‡ä»¶</span></span><br><span class="line">            manifest.srcFile <span class="string">&#x27;src/xiaomi/AndroidManifest.xml&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        other &#123;</span><br><span class="line">            <span class="comment">// æŒ‡å®šå¦ä¸€ä¸ªé£å‘³ç‰¹å®šçš„ AndroidManifest.xml æ–‡ä»¶</span></span><br><span class="line">            manifest.srcFile <span class="string">&#x27;src/other/AndroidManifest.xml&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="src-main-AndroidManifest-xmlï¼ˆå…¬ç”¨é…ç½®ï¼‰"><a href="#src-main-AndroidManifest-xmlï¼ˆå…¬ç”¨é…ç½®ï¼‰" class="headerlink" title="src&#x2F;main&#x2F;AndroidManifest.xmlï¼ˆå…¬ç”¨é…ç½®ï¼‰"></a>src&#x2F;main&#x2F;AndroidManifest.xmlï¼ˆå…¬ç”¨é…ç½®ï¼‰</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">package</span>=<span class="string">&quot;com.example.app&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- å…¬ç”¨é…ç½®é¡¹ --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- ... --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="src-xiaomi-AndroidManifest-xmlï¼ˆé£å‘³ç‰¹å®šé…ç½®ï¼‰"><a href="#src-xiaomi-AndroidManifest-xmlï¼ˆé£å‘³ç‰¹å®šé…ç½®ï¼‰" class="headerlink" title="src&#x2F;xiaomi&#x2F;AndroidManifest.xmlï¼ˆé£å‘³ç‰¹å®šé…ç½®ï¼‰"></a>src&#x2F;xiaomi&#x2F;AndroidManifest.xmlï¼ˆé£å‘³ç‰¹å®šé…ç½®ï¼‰</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">package</span>=<span class="string">&quot;com.example.app&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- é£å‘³ç‰¹å®šé…ç½®é¡¹ --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- ... --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="src-other-AndroidManifest-xmlï¼ˆå¦ä¸€ä¸ªé£å‘³ç‰¹å®šé…ç½®ï¼‰"><a href="#src-other-AndroidManifest-xmlï¼ˆå¦ä¸€ä¸ªé£å‘³ç‰¹å®šé…ç½®ï¼‰" class="headerlink" title="src&#x2F;other&#x2F;AndroidManifest.xmlï¼ˆå¦ä¸€ä¸ªé£å‘³ç‰¹å®šé…ç½®ï¼‰"></a>src&#x2F;other&#x2F;AndroidManifest.xmlï¼ˆå¦ä¸€ä¸ªé£å‘³ç‰¹å®šé…ç½®ï¼‰</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">xmlCopy code</span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">package</span>=<span class="string">&quot;com.example.app&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- å¦ä¸€ä¸ªé£å‘³ç‰¹å®šé…ç½®é¡¹ --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- ... --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åœ¨ <code>sourceSets</code> ä¸­åˆ†åˆ«ä¸º <code>xiaomi</code> å’Œ <code>other</code> é£å‘³æŒ‡å®šäº†ä¸åŒçš„ <code>AndroidManifest.xml</code> æ–‡ä»¶ã€‚æ¯ä¸ªé£å‘³çš„é…ç½®å°†ä¼šè¦†ç›–é»˜è®¤çš„ <code>main</code> æ–‡ä»¶å¤¹ä¸‹çš„ <code>AndroidManifest.xml</code> æ–‡ä»¶ä¸­ç›¸åº”çš„éƒ¨åˆ†ã€‚</p><p>é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå¯ä»¥çµæ´»åœ°ç®¡ç†ä¸åŒé£å‘³çš„é…ç½®ï¼Œå¹¶ç¡®ä¿é£å‘³ç‰¹å®šçš„é…ç½®èƒ½å¤Ÿæ­£ç¡®åœ°è¢«åº”ç”¨ï¼ŒåŒæ—¶ä¿ç•™å…¬ç”¨çš„é…ç½®ã€‚å¯ä»¥å®é™…éœ€æ±‚è¿›è¡Œç›¸åº”çš„è°ƒæ•´å’Œå®šåˆ¶ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>åœ¨ <code>sourceSets</code> ä¸­ä½¿ç”¨ <code>manifest.srcFile</code> å¯ä»¥å°†é£å‘³ç‰¹å®šçš„ <code>AndroidManifest.xml</code> æ–‡ä»¶æ›¿æ¢é»˜è®¤çš„æ¸…å•æ–‡ä»¶ã€‚</p><p>å¦‚æœåœ¨æŒ‡å®šçš„é£å‘³ç‰¹å®šæ¸…å•æ–‡ä»¶ä¸­æœªå®šä¹‰çš„éƒ¨åˆ†ï¼Œå°†ä¼šä» <code>main</code> æ–‡ä»¶å¤¹ä¸‹çš„é»˜è®¤ <code>AndroidManifest.xml</code> æ–‡ä»¶è¿›è¡Œåˆå¹¶ã€‚</p><p>é’ˆå¯¹é£å‘³ç‰¹å®šçš„é…ç½®ï¼Œå°†é…ç½®æ”¾åœ¨ <code>xiaomi</code> æˆ– <code>other</code> æ–‡ä»¶å¤¹ä¸‹çš„é£å‘³ç‰¹å®š <code>AndroidManifest.xml</code> æ–‡ä»¶ä¸­ã€‚</p><p>å¯¹äºå…¬ç”¨é…ç½®ï¼Œä¿ç•™åœ¨ <code>main</code> æ–‡ä»¶å¤¹ä¸‹çš„é»˜è®¤ <code>AndroidManifest.xml</code> æ–‡ä»¶ä¸­ã€‚</p><p>å†è¯´ä¸€ä¸‹ <code>sourceSets</code>çš„å¸¸ç”¨é…ç½®ï¼Œå…·ä½“çœ‹ä¸‹é¢ä»£ç ç¤ºä¾‹</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    productFlavors &#123;</span><br><span class="line">        xiaomi &#123;</span><br><span class="line">            <span class="comment">// xiaomiçš„é…ç½®</span></span><br><span class="line">        &#125;</span><br><span class="line">        other &#123;</span><br><span class="line">            <span class="comment">// otherçš„é…ç½®</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ›´å¤šé£å‘³...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sourceSets &#123;</span><br><span class="line">        xiaomi &#123;</span><br><span class="line">            <span class="comment">// è¿™é‡ŒæŒ‡å®šxiaomiçš„æºä»£ç å’Œèµ„æºè·¯å¾„</span></span><br><span class="line">          java.srcDirs = [<span class="string">&#x27;src/xiaomi/java&#x27;</span>]</span><br><span class="line">          res.srcDirs = [<span class="string">&#x27;src/xiaomi/res&#x27;</span>]</span><br><span class="line">          assets.srcDirs = [<span class="string">&#x27;src/xiaomi/assets&#x27;</span>]</span><br><span class="line">            manifest.srcFile <span class="string">&#x27;src/xiaomi/AndroidManifest.xml&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        other &#123;</span><br><span class="line">            <span class="comment">// è¿™é‡ŒæŒ‡å®šotherçš„æºä»£ç å’Œèµ„æºè·¯å¾„</span></span><br><span class="line">          java.srcDirs = [<span class="string">&#x27;src/xiaomi/java&#x27;</span>]</span><br><span class="line">          res.srcDirs = [<span class="string">&#x27;src/other/res&#x27;</span>]</span><br><span class="line">          assets.srcDirs = [<span class="string">&#x27;src/other/assets&#x27;</span>]</span><br><span class="line">            manifest.srcFile <span class="string">&#x27;src/other/AndroidManifest.xml&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ›´å¤šé£å‘³...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
          <category> AndroidManifest </category>
          
          <category> sourceSets </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> AndroidManifest </tag>
            
            <tag> sourceSets </tag>
            
            <tag> productFlavors </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€è‡ªå®šä¹‰ Viewã€‘ç›¸æœºé¢„è§ˆç‚¹å‡»èšç„¦æ¡†(å¸¦å¯¹ç„¦åŠ¨ç”»ï¼Œæ›å…‰è°ƒæ•´)</title>
      <link href="/post/779b2eb0.html"/>
      <url>/post/779b2eb0.html</url>
      
        <content type="html"><![CDATA[<p><img style='width: auto;    max-width: 100%;    border-radius: 12px;    display: block;    margin: 20px auto;    object-fit: contain;    box-shadow: 2px 4px 7px #999;' src='https://bu.dusays.com/2023/08/10/64d45dba73c3c.webp'><br>&emsp;&emsp;æ—¶éš”åä¸ªæœˆï¼Œä»Šå¤©å†æ¬¡æ¥åˆ†äº«é¡¹ç›®ä¸­ä½¿ç”¨åˆ°çš„è‡ªå®šä¹‰Viewï¼Œè¯ä¸å¤šè¯´ï¼Œç›´æ¥å¼€å§‹ï¼Œä¸»è¦åœ¨ç›¸æœºé¢„è§ˆçš„æ—¶å€™ç‚¹å‡»é¢„è§ˆç•Œé¢å¯¹ç„¦æ—¶ä½¿ç”¨ï¼Œå¹¶å¢åŠ äº†å¯¹ç„¦åŠ¨ç”»ï¼Œå¯è°ƒèŠ‚æ›å…‰ã€‚å¯ä»¥è®¾ç½®æ›å…‰çš„ä¸Šé™å’Œä¸‹é™ï¼Œç”¨äºè°ƒæ•´æ›å…‰æ—¶å›è°ƒï¼Œç‚¹å‡»åæ— æ“ä½œ5ç§’åéšè—ã€‚æ€»çš„æ¥è¯´å°±æ˜¯è¿™äº›ï¼Œä¸‹é¢å¼€å§‹ä¸Šä»£ç </p><h2 id="å¯¹ç„¦æ¡†"><a href="#å¯¹ç„¦æ¡†" class="headerlink" title="å¯¹ç„¦æ¡†"></a>å¯¹ç„¦æ¡†</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onMeasure</span><span class="params">(widthMeasureSpec: <span class="type">Int</span>, heightMeasureSpec: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec)</span><br><span class="line">    <span class="keyword">val</span> width = MeasureSpec.getSize(widthMeasureSpec)</span><br><span class="line">    <span class="keyword">val</span> height = MeasureSpec.getSize(heightMeasureSpec)</span><br><span class="line">    frameRadius = width / <span class="number">5f</span></span><br><span class="line">    frameRectF.left = (width / <span class="number">2f</span>) - frameRadius</span><br><span class="line">    frameRectF.right = (width / <span class="number">2f</span>) + frameRadius</span><br><span class="line">    frameRectF.top = (height / <span class="number">2f</span>) - frameRadius</span><br><span class="line">    frameRectF.bottom = (height / <span class="number">2f</span>) + frameRadius</span><br><span class="line">    _14 = frameRectF.height() / <span class="number">4f</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDraw</span><span class="params">(canvas: <span class="type">Canvas</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onDraw(canvas)</span><br><span class="line">    canvas?.apply &#123;</span><br><span class="line">        <span class="keyword">val</span> points = floatArrayOf(</span><br><span class="line">        frameRectF.left, frameRectF.top, frameRectF.left, frameRectF.top + _14,</span><br><span class="line">        frameRectF.left, frameRectF.top, frameRectF.left + _14, frameRectF.top,</span><br><span class="line">        frameRectF.left, frameRectF.bottom, frameRectF.left, frameRectF.bottom - _14,</span><br><span class="line">        frameRectF.left, frameRectF.bottom, frameRectF.left + _14, frameRectF.bottom,</span><br><span class="line">        frameRectF.right, frameRectF.top, frameRectF.right, frameRectF.top + _14,</span><br><span class="line">        frameRectF.right, frameRectF.top, frameRectF.right - _14, frameRectF.top,</span><br><span class="line">        frameRectF.right, frameRectF.bottom, frameRectF.right, frameRectF.bottom - _14,</span><br><span class="line">        frameRectF.right, frameRectF.bottom, frameRectF.right - _14, frameRectF.bottom)</span><br><span class="line">        drawLines(points, framePaint)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;è¿™ä¸ªå¯¹ç„¦æ¡†æ˜¾è€Œæ˜“è§ï¼Œå…¶å®å°±æ˜¯ç”»äº†å…«æ¡çº¿ï¼Œ_14æ˜¯ç”¨æ¥æ§åˆ¶è¾¹æ¡†çº¿æ¡çš„é•¿åº¦çš„ï¼Œæƒ³è¦è¾¹æ¡†é—´è·æ›´è¿‘ä¸€äº›ï¼Œå°±æ”¹æˆ<br><code>_14 = frameRectF.height() / 3f</code></p><h2 id="å°å¤ªé˜³"><a href="#å°å¤ªé˜³" class="headerlink" title="å°å¤ªé˜³"></a>å°å¤ªé˜³</h2><h3 id="1-æŒ‰ä½æ˜¾ç¤ºçš„ç›´çº¿"><a href="#1-æŒ‰ä½æ˜¾ç¤ºçš„ç›´çº¿" class="headerlink" title="1.æŒ‰ä½æ˜¾ç¤ºçš„ç›´çº¿"></a>1.æŒ‰ä½æ˜¾ç¤ºçš„ç›´çº¿</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDraw</span><span class="params">(canvas: <span class="type">Canvas</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onDraw(canvas)</span><br><span class="line">    canvas?.apply &#123;</span><br><span class="line">        <span class="comment">// ç”»ç›´çº¿</span></span><br><span class="line">        <span class="keyword">if</span> (showLine) &#123;</span><br><span class="line">            <span class="keyword">if</span> (circleY != circleRadius + dp8) &#123;</span><br><span class="line">                drawLine(centerOfCircle, <span class="number">0f</span>, centerOfCircle, (height * progress) - (circleRadius) - dp10, sunPaint)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (circleY != height - (circleRadius) - dp8) &#123;</span><br><span class="line">                drawLine(centerOfCircle, (height * progress) + (circleRadius) + dp10, centerOfCircle, height * <span class="number">1f</span>, sunPaint)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressLint(<span class="string">&quot;ClickableViewAccessibility&quot;</span>)</span></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onTouchEvent</span><span class="params">(event: <span class="type">MotionEvent</span>?)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">    event?.let &#123; ev -&gt;</span><br><span class="line">        <span class="keyword">when</span> (ev.action) &#123;</span><br><span class="line">            MotionEvent.ACTION_DOWN -&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (circleY &lt; <span class="number">0f</span>) &#123;</span><br><span class="line">                    circleY = height * progress</span><br><span class="line">                    lastCircleY = circleY</span><br><span class="line">                &#125;</span><br><span class="line">                posY = event.y</span><br><span class="line">                paintColor = Color.WHITE</span><br><span class="line">            &#125;</span><br><span class="line">            MotionEvent.ACTION_MOVE -&gt; &#123;</span><br><span class="line">                curPosY = event.y</span><br><span class="line">                paintColor = Color.WHITE</span><br><span class="line">                <span class="keyword">if</span> ((curPosY - posY &gt; <span class="number">0</span>) || (curPosY - posY &lt; <span class="number">0</span>)) &#123;</span><br><span class="line">                    showLine = <span class="literal">true</span></span><br><span class="line">                    invalidate()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            MotionEvent.ACTION_UP, MotionEvent.ACTION_CANCEL -&gt; &#123;</span><br><span class="line">                showLine = <span class="literal">false</span></span><br><span class="line">                invalidate()</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> -&gt; &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;ç›´çº¿å—<code>showLine</code>å½±å“æ˜¾ç¤ºæˆ–éšè—ï¼Œ<code>showLine</code>ä¼šåœ¨æ‰‹æŒ‡ç§»åŠ¨çš„æ—¶å€™ä¼šä¿®æ”¹ä¸º<code>true</code>ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šæ˜¾ç¤ºå°å¤ªé˜³åçš„ç›´çº¿ï¼›<code>circleY</code>æ˜¯è®°å½•å°å¤ªé˜³yè½´çš„ä½ç½®ï¼Œè€Œ<code>(circleY != circleRadius + dp8)</code>æ˜¯ç”¨æ¥åˆ¤æ–­å½“å‰å°å¤ªé˜³æ˜¯å¦å¤„äºæœ€ä¸Šæ–¹ï¼Œå¦‚æœä¸æ˜¯çš„è¯ï¼Œå°±ä¼šç»˜åˆ¶å°å¤ªé˜³ä¸Šæ–¹çš„ç›´çº¿ï¼Œ<code>(circleY != height - (circleRadius) - dp8)</code>åŒç†ï¼Œåˆ¤æ–­æ˜¯å¦å¤„äºæœ€ä¸‹æ–¹ã€‚</p><h3 id="2-å°å¤ªé˜³å¤–éƒ¨"><a href="#2-å°å¤ªé˜³å¤–éƒ¨" class="headerlink" title="2.å°å¤ªé˜³å¤–éƒ¨"></a>2.å°å¤ªé˜³å¤–éƒ¨</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDraw</span><span class="params">(canvas: <span class="type">Canvas</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onDraw(canvas)</span><br><span class="line">    canvas?.apply &#123;</span><br><span class="line">        <span class="comment">// ç”»åœ†,ç©ºå¿ƒåœ†</span></span><br><span class="line">        drawCircle(centerOfCircle, height * progress, circleRadius, sunPaint)</span><br><span class="line">        <span class="comment">// ç”»çº¿æ¡</span></span><br><span class="line">        <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">0</span> until <span class="number">8</span>) &#123;</span><br><span class="line">            <span class="keyword">val</span> startPointF = calculationPoint(angle - (i * <span class="number">45f</span>), circleRadius + dp3)</span><br><span class="line">            <span class="keyword">val</span> endPointF = calculationPoint(angle - (i * <span class="number">45f</span>), circleRadius + dp5)</span><br><span class="line">            borderWidth = <span class="number">5f</span></span><br><span class="line">            sunPaint.strokeWidth = borderWidth</span><br><span class="line">            canvas.drawLine(startPointF.x, startPointF.y, endPointF.x, endPointF.y, sunPaint)</span><br><span class="line">            borderWidth = <span class="number">3f</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è®¡ç®—åœ†ä¸Šä»»æ„ç‚¹çš„åæ ‡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> angle è§’åº¦</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> radius åŠå¾„</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> ç‚¹åæ ‡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">calculationPoint</span><span class="params">(angle: <span class="type">Float</span>, radius: <span class="type">Float</span>)</span></span>: PointF &#123;</span><br><span class="line">    <span class="keyword">val</span> x = (centerOfCircle) + (radius) * cos(angle * Math.PI / <span class="number">180f</span>).toFloat()</span><br><span class="line">    <span class="keyword">val</span> y = (height * progress) + (radius) * sin(angle * Math.PI / <span class="number">180f</span>).toFloat()</span><br><span class="line">    <span class="keyword">return</span> PointF(x, y)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;ç”»ç©ºå¿ƒåœ†æ²¡å•¥å¥½è¯´çš„ï¼Œ<code>height * progress</code>å…¶å®æ„ä¹‰ä¸Šä¹Ÿå°±æ˜¯<code>circleY</code>ã€‚è‡³äºå°å¤ªé˜³ä¸Šä¸‹æ»‘åŠ¨å¤–éƒ¨çº¿æ¡ä¹Ÿè·Ÿç€è½¬æ˜¯ä¸æ–­æ”¹å˜<code>angle</code>ï¼Œä»çº¿æ¡æœ€ä¸Šé¢ç§»åŠ¨åˆ°æœ€ä¸‹é¢ï¼Œå°±æ˜¯ä»0åˆ°360çš„å˜åŒ–ã€‚ä¸æ–­çš„æ”¹å˜è§’åº¦ï¼Œè¾¾åˆ°æ ¹æ®æ‰‹æŒ‡ç§»åŠ¨æ—‹è½¬çš„æ•ˆæœã€‚</p><h3 id="3-å°å¤ªé˜³å†…éƒ¨"><a href="#3-å°å¤ªé˜³å†…éƒ¨" class="headerlink" title="3.å°å¤ªé˜³å†…éƒ¨"></a>3.å°å¤ªé˜³å†…éƒ¨</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDraw</span><span class="params">(canvas: <span class="type">Canvas</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onDraw(canvas)</span><br><span class="line">    canvas?.apply &#123;</span><br><span class="line">        <span class="comment">// ç”»ä¸­é—´æœˆäº®æ•ˆæœ</span></span><br><span class="line">        <span class="keyword">if</span> (realProcess &lt; <span class="number">.5f</span>) &#123;</span><br><span class="line">            <span class="comment">// å¼ å¼¦æœˆ</span></span><br><span class="line">            <span class="keyword">val</span> left = centerOfCircle - (((circleRadius - dp2) * <span class="number">2f</span>) * abs(realProcess - <span class="number">0.5f</span>))</span><br><span class="line">            <span class="keyword">val</span> top = (height * progress) - (circleRadius - dp2)</span><br><span class="line">            <span class="keyword">val</span> right = centerOfCircle + (((circleRadius - dp2) * <span class="number">2f</span>) * abs(realProcess - <span class="number">0.5f</span>))</span><br><span class="line">            <span class="keyword">val</span> bottom = (height * progress) + (circleRadius - dp2)</span><br><span class="line">            drawOval(left, top, right, bottom, moonPaint)</span><br><span class="line">            drawArc(centerOfCircle - (circleRadius - dp2), (height * progress) - (circleRadius - dp2),</span><br><span class="line">                centerOfCircle + (circleRadius - dp2), (height * progress) + (circleRadius - dp2),</span><br><span class="line">                <span class="number">90f</span>, <span class="number">180f</span>, <span class="literal">false</span>, moonPaint)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (realProcess == <span class="number">.5f</span>) &#123;</span><br><span class="line">            <span class="comment">// ä¸‹å¼¦æœˆ</span></span><br><span class="line">            drawArc(centerOfCircle - (circleRadius - dp2), (height * progress) - (circleRadius - dp2),</span><br><span class="line">                centerOfCircle + (circleRadius - dp2), (height * progress) + (circleRadius - dp2),</span><br><span class="line">                <span class="number">90f</span>, <span class="number">180f</span>, <span class="literal">false</span>, moonPaint)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æ®‹æœˆ</span></span><br><span class="line">            <span class="keyword">val</span> save = saveLayer(<span class="literal">null</span>, <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">val</span> left = centerOfCircle - (((circleRadius - dp2) * <span class="number">2f</span>) * abs(realProcess - <span class="number">0.5f</span>))</span><br><span class="line">            <span class="keyword">val</span> top = (height * progress) - (circleRadius - dp2)</span><br><span class="line">            <span class="keyword">val</span> right = centerOfCircle + (((circleRadius - dp2) * <span class="number">2f</span>) * abs(realProcess - <span class="number">0.5f</span>))</span><br><span class="line">            <span class="keyword">val</span> bottom = (height * progress) + (circleRadius - dp2)</span><br><span class="line">            drawArc(centerOfCircle - (circleRadius - dp2 - <span class="number">1</span>), (height * progress) - (circleRadius - dp2 - <span class="number">1</span>),</span><br><span class="line">                centerOfCircle + (circleRadius - dp2 - <span class="number">1</span>), (height * progress) + (circleRadius - dp2 - <span class="number">1</span>),</span><br><span class="line">                <span class="number">90f</span>, <span class="number">180f</span>, <span class="literal">false</span>, moonPaint)</span><br><span class="line">            moonPaint.xfermode = porterDuffDstOut</span><br><span class="line">            drawOval(left, top, right, bottom, moonPaint)</span><br><span class="line">            moonPaint.xfermode = <span class="literal">null</span></span><br><span class="line">            restoreToCount(save)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;å°å¤ªé˜³ä¸­é—´çš„æœˆäº®æ•ˆæœæ˜¯å‚è€ƒäº†<a href="https://juejin.cn/post/7006142194230755341">è¹­ä¸­ç§‹çƒ­åº¦æ¥äº†~Android è‡ªå®šä¹‰Viewâ€”â€”æœˆæœ‰é˜´æ™´åœ†ç¼º</a>è¿™ä¸ªæ–‡ç« ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥å»çœ‹ä¸€ä¸‹ã€‚æ€»çš„æ¥è¯´ï¼Œè¿™ä¸ªæœˆäº®ä¸»è¦åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼Œæ®‹æœˆ &gt; ä¸‹å¼¦æœˆ &gt; å¼ å¼¦æœˆã€‚</p><p>&emsp;&emsp;æ®‹æœˆå’Œå¼ å¼¦æœˆçš„åŸç†æ˜¯ç”»äº†ä¸€ä¸ªä¸‹å¼¦æœˆï¼Œåœ¨ä¸‹å¼¦æœˆçš„åŸºç¡€ä¸Šï¼Œå†ç”»ä¸€ä¸ªæ¤­åœ†ï¼Œè¿™ä¸ªæ¤­åœ†æ˜¯é«˜åº¦å’Œä¸‹å¼¦æœˆç›¸åŒï¼Œå®½åº¦åŠ¨æ€å‘ä¸¤è¾¹å»¶ä¼¸çš„ã€‚æ¤­åœ†çš„æ•ˆæœå¦‚ä¸‹ï¼š</p><p><img style='width: auto;    max-width: 100%;    border-radius: 12px;    display: block;    margin: 20px auto;    object-fit: contain;    box-shadow: 2px 4px 7px #999;' src='https://bu.dusays.com/2023/08/10/64d45e210e7ce.gif'></p><p>&emsp;&emsp;è¿™é‡Œæ”¾å¤§äº†æ•´ä¸ªViewï¼Œä¹Ÿæ˜¯ä¸ºäº†æ›´åŠ ç›´è§‚çš„çœ‹åˆ°æ¤­åœ†çš„å˜åŒ–ã€‚çœ‹åˆ°è¿™é‡Œå°±å¯ä»¥æ˜ç™½å¼ å¼¦æœˆå…¶å®å°±æ˜¯è¿™ä¸ªæ¤­åœ†å’Œä¸‹å¼¦æœˆå æ”¾åœ¨ä¸€èµ·çš„æ•ˆæœï¼Œé‚£æ®‹æœˆæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Œè¿™é‡Œç”¨åˆ°äº†<code>PorterDuffXfermode</code>ï¼Œå¯¹äº<code>PorterDuffXfermode</code>ä¸äº†è§£çš„å¯ä»¥çœ‹ä¸‹Googleçš„<a href="https://developer.android.com/reference/android/graphics/PorterDuff.Mode.html">å®˜æ–¹æ–‡æ¡£</a>ï¼Œæ–‡ç« ä¸­ç”¨åˆ°çš„æ˜¯<code>DST_OUT</code>ï¼Œæ•ˆæœå¦‚å›¾ï¼š</p><p><img style='width: auto;    max-width: 100%;    border-radius: 12px;    display: block;    margin: 20px auto;    object-fit: contain;    box-shadow: 2px 4px 7px #999;' src='https://bu.dusays.com/2023/08/10/64d45dba39688.png'></p><p>&emsp;&emsp;ä½¿ç”¨<code>PorterDuff.Mode.DST_OUT</code>å°†å¯å˜åŒ–çš„æ¤­åœ†å’Œä¸‹å¼¦æœˆå æ”¾åœ¨ä¸€èµ·å°±å®ç°äº†æ®‹æœˆçš„æ•ˆæœã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>&emsp;&emsp;åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œé‚£ä¹ˆå¦‚ä½•ä½¿ç”¨å‘¢ï¼Œä»£ç å¦‚ä¸‹ï¼Œé¦–å…ˆæ˜¯xmlï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;androidx.constraintlayout.widget.ConstraintLayout xmlns:android=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="line">    xmlns:app=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span><br><span class="line">    xmlns:tools=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span><br><span class="line">    android:layout_width=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">    android:layout_height=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">    tools:context=<span class="string">&quot;.MainActivity&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;View</span><br><span class="line">        android:id=<span class="string">&quot;@+id/preview_view&quot;</span></span><br><span class="line">        android:layout_width=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">        android:layout_height=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">        android:background=<span class="string">&quot;@color/black&quot;</span> /&gt;</span><br><span class="line"></span><br><span class="line">    &lt;com.lazyiones.focussunview.FocusSunView</span><br><span class="line">        android:id=<span class="string">&quot;@+id/focus_sun_view&quot;</span></span><br><span class="line">        android:layout_width=<span class="string">&quot;120dp&quot;</span></span><br><span class="line">        android:layout_height=<span class="string">&quot;140dp&quot;</span></span><br><span class="line">        android:visibility=<span class="string">&quot;invisible&quot;</span></span><br><span class="line">        app:layout_constraintStart_toStartOf=<span class="string">&quot;@+id/preview_view&quot;</span></span><br><span class="line">        app:layout_constraintTop_toTopOf=<span class="string">&quot;@+id/preview_view&quot;</span> /&gt;</span><br><span class="line"></span><br><span class="line">&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;è¿™é‡Œä¸€å®šè¦æŠŠ<code>visibility</code>è®¾ç½®ä¸º<code>invisible</code>ï¼Œä¸ç„¶ç¬¬ä¸€æ¬¡æ˜¾ç¤ºæ— æ³•æ­£å¸¸å¤„ç†å®½é«˜ï¼Œå¯¹ç„¦æ¡†æ˜¾ç¤ºçš„ä½ç½®ä¼šåç¦»ï¼Œ<code>preview_view</code>é¡¾åæ€ä¹‰å°±æ˜¯é¢„è§ˆçš„Viewã€‚ä¸‹é¢æ˜¯Activityä¸­ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> focusSunView = findViewById&lt;FocusSunView&gt;(R.id.focus_sun_view)</span><br><span class="line"></span><br><span class="line">findViewById&lt;View&gt;(R.id.preview_view).setOnTouchListener &#123; _, motionEvent -&gt;</span><br><span class="line">    <span class="keyword">when</span> (motionEvent.action) &#123;</span><br><span class="line">        MotionEvent.ACTION_DOWN -&gt; &#123;</span><br><span class="line">            focusSunView.visibility = View.VISIBLE</span><br><span class="line">            focusSunView.translationX = motionEvent.x - (focusSunView.width / <span class="number">2f</span>)</span><br><span class="line">            focusSunView.translationY = motionEvent.y - (focusSunView.height / <span class="number">2f</span>)</span><br><span class="line">            focusSunView.startCountdown()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span><span class="symbol">@setOnTouchListener</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">focusSunView.setOnExposureChangeListener(<span class="keyword">object</span> : FocusSunView.OnExposureChangeListener &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onExposureChangeListener</span><span class="params">(exposure: <span class="type">Float</span>)</span></span> &#123;</span><br><span class="line">        <span class="comment">// å¤„ç†ç›¸æœºæ›å…‰</span></span><br><span class="line">        Log.e(<span class="string">&quot;FocusSunView&quot;</span>, <span class="string">&quot;onExposureChangeListener: -----------&gt; <span class="variable">$exposure</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;OKï¼Œå¤§è‡´å°±æ˜¯è¿™æ ·ï¼Œæœ‰å†™çš„ä¸å¥½çš„åœ°æ–¹æ¬¢è¿æŒ‡æ­£ã€‚</p><h2 id="æºç åœ°å€"><a href="#æºç åœ°å€" class="headerlink" title="æºç åœ°å€"></a>æºç åœ°å€</h2><p><a href="https://github.com/LazyIonEs/FocusSunView.git">FocusSunView</a></p>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
          <category> è‡ªå®šä¹‰View </category>
          
          <category> è‡ªå®šä¹‰View </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> ç›¸æœº </tag>
            
            <tag> è‡ªå®šä¹‰View </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä»¿å¢¨è¿¹24å°æ—¶å¤©æ°”è‡ªå®šä¹‰View</title>
      <link href="/post/7482f6f9.html"/>
      <url>/post/7482f6f9.html</url>
      
        <content type="html"><![CDATA[<h2 id="å…ˆçœ‹å¢¨è¿¹å¤©æ°”æ•ˆæœå›¾"><a href="#å…ˆçœ‹å¢¨è¿¹å¤©æ°”æ•ˆæœå›¾" class="headerlink" title="å…ˆçœ‹å¢¨è¿¹å¤©æ°”æ•ˆæœå›¾"></a>å…ˆçœ‹å¢¨è¿¹å¤©æ°”æ•ˆæœå›¾</h2><p><img src="https://bu.dusays.com/2023/08/10/64d43fec59021.webp" alt="5506445253_63249103744_1656936370197_694x449.gif"></p><p>å› ä¸ºéœ€æ±‚åŸå› ï¼Œæ”¹äº†ä¸€äº›æ ·å¼</p><p><img src="https://bu.dusays.com/2023/08/10/64d43febdc2a0.webp" alt="5506445253_63339371021_1657021325668_687x425.gif"></p><h2 id="å¹³æ»‘çš„çº¿"><a href="#å¹³æ»‘çš„çº¿" class="headerlink" title="å¹³æ»‘çš„çº¿"></a>å¹³æ»‘çš„çº¿</h2><p>è¯ä¸å¤šè¯´ï¼Œç›´æ¥å¼€å§‹ï¼Œé¦–å…ˆæ˜¯ç”»å‡ºè¿™æ¡æ›²çº¿ï¼Œæ‰¾åˆ°æ¯ä¸ªå°æ—¶æ¸©åº¦å¯¹åº”ç‚¹ä½ï¼Œè¿æˆä¸€æ¡çº¿ï¼Œå·¦è¾¹æ˜¾ç¤ºæœ€é«˜æ¸©åº¦å’Œæœ€ä½æ¸©åº¦ï¼Œæœ€é«˜æ¸©åº¦å¯¹åº”æ›²çº¿ä¸­çš„æœ€é«˜ç‚¹ï¼Œæœ€ä½æ¸©åº¦å¯¹åº”æ›²çº¿ä¸­çš„æœ€ä½ç‚¹ï¼Œç›´æ¥ä¸Šä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Point <span class="title function_">calculateTempPoint</span><span class="params">(<span class="type">int</span> left, <span class="type">int</span> right, <span class="type">int</span> temp)</span> &#123;</span><br><span class="line">    <span class="type">double</span> <span class="variable">minHeight</span> <span class="operator">=</span> tempBaseTop;</span><br><span class="line">    <span class="type">double</span> <span class="variable">maxHeight</span> <span class="operator">=</span> tempBaseBottom;</span><br><span class="line">    <span class="type">double</span> <span class="variable">tempY</span> <span class="operator">=</span> maxHeight - (temp - minTemp) * <span class="number">1.0</span> / (maxTemp - minTemp) * (maxHeight - minHeight);</span><br><span class="line">    <span class="type">Point</span> <span class="variable">point</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Point</span>((left + right) / <span class="number">2</span>, (<span class="type">int</span>) tempY);</span><br><span class="line">    <span class="keyword">return</span> point;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¼ å…¥ç‚¹çš„å·¦è¾¹è·ï¼Œå³è¾¹è·å’Œè¿™ä¸ªæ—¶é—´æ®µå¯¹åº”çš„æ¸©åº¦ï¼Œè¿”å›ä¸€ä¸ªPointç±»ï¼ŒPointç±»ä¸­æœ‰xï¼Œyä¸¤ä¸ªå±æ€§ï¼Œæ„é€ æ–¹æ³•å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">Point</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.x = x;</span><br><span class="line">    <span class="built_in">this</span>.y = y;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>tempBaseTop</code>å’Œ<code>tempBaseBottom</code>æ˜¯åœ¨åˆå§‹åŒ–ä¸­æŒ‰é«˜åº¦æ¯”ä¾‹æ¥åˆ†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tempBaseTop = (mHeight - bottomTextHeight) / <span class="number">3</span>;</span><br><span class="line">tempBaseBottom = (mHeight - bottomTextHeight) * <span class="number">3</span> / <span class="number">4</span>;</span><br></pre></td></tr></table></figure><p><code>bottomTextHeight</code>æ˜¯ä¸‹æ–¹æ•°å­—æ–‡æœ¬é«˜åº¦<br>è·å–æ¯ä¸ªæ¸©åº¦å¯¹åº”çš„åæ ‡è½´ä¹‹å‰ï¼Œå…ˆæ‹¿åˆ°24å°æ—¶å¤©æ°”æ•°æ®ä¸­çš„æœ€é«˜æ¸©å’Œæœ€ä½æ¸©ï¼Œè¿™æ ·å°±èƒ½ç¡®å®šæ¯ä¸ªç‚¹ä½çš„è·ç¦»yè½´çš„åæ ‡ã€‚æ‹¿åˆ°24ä¸ªåæ ‡ç‚¹åï¼Œç›´æ¥æ¥ç¬¬ä¸€æ­¥ï¼Œç”»å‡ºæ›²çº¿ï¼Œç›´æ¥ä¸Šä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Path</span> <span class="variable">path</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Path</span>();</span><br><span class="line"><span class="type">Point</span> <span class="variable">point0</span> <span class="operator">=</span> listItems.get(<span class="number">0</span>).getTempPoint();</span><br><span class="line">path.moveTo(point0.x, point0.y);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; listItems.size(); i++) &#123;</span><br><span class="line">    <span class="type">Point</span> <span class="variable">point</span> <span class="operator">=</span> listItems.get(i).getTempPoint();</span><br><span class="line">    <span class="keyword">if</span> (i != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">Point</span> <span class="variable">pointPre</span> <span class="operator">=</span> listItems.get(i - <span class="number">1</span>).getTempPoint();</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">1</span>) &#123;</span><br><span class="line">            path.lineTo(point.x, point.y);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            path.rLineTo(point.x - pointPre.x, point.y - pointPre.y);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">canvas.drawPath(path, linePaint);</span><br></pre></td></tr></table></figure><p>ç›´æ¥<code>new</code>ä¸€ä¸ª<code>Path</code>ï¼Œä½¿ç”¨<code>moveTo</code>æ–¹æ³•ç§»åŠ¨åˆ°ç¬¬ä¸€ä¸ªç‚¹ä½ï¼Œç„¶åç›´æ¥<code>for</code>å¾ªç¯ï¼Œç¬¬ä¸€ä¸ªç‚¹ä¸ç”»ï¼Œä»1å¼€å§‹ï¼Œç›´æ¥<code>lineTo</code>åˆ°æŒ‡å®šçš„xï¼Œyåæ ‡ï¼Œè¿™é‡Œç¬¬ä¸€æ¡çº¿ä½¿ç”¨äº†<code>lineTo</code>ï¼Œåé¢éƒ½æ˜¯ç”¨çš„<code>rLineTo</code>ï¼Œä¹Ÿå°±æ˜¯ä»ä¸Šä¸€æ¡çº¿çš„æœ€ç»ˆç‚¹å¼€å§‹ç”»ï¼Œå°±ä¸éœ€è¦é¢‘ç¹çš„<code>moveTo</code>äº†ã€‚æœ¬æ¥æ‰“ç®—ä½¿ç”¨ä¸‰é˜¶è´å¡å°”æ›²çº¿ç”»çš„ï¼Œç”»å‡ºæ¥ä¹‹åå‘ç°æ¯æ¡çº¿çš„è¿æ¥å¤„æœ‰å¾ˆæ˜æ˜¾çš„æŠ˜è§’ï¼Œä¸å¹³æ»‘ï¼Œå¯èƒ½æ˜¯æˆ‘ç”¨çš„æ–¹æ³•ä¸å¯¹ï¼Œæœ‰æ˜ç™½çš„å¯ä»¥è·Ÿæˆ‘è¯´è¯´ï¼Œä¸‰é˜¶è´å¡å°”ç”»å‡ºæ¥çš„å°±åƒä¸‹é¢è¿™æ ·</p><p><img src="https://bu.dusays.com/2023/08/10/64d43feaa89d4.webp" alt="5506445253_63262601417_IMG_20220705_085830.jpg"><br>å†çœ‹ä¸‹ä½¿ç”¨ç”»ç›´çº¿çš„æ–¹å¼ç”»å‡ºæ¥çš„æ•ˆæœ</p><p><img src="https://bu.dusays.com/2023/08/10/64d43fe98d6e5.webp" alt="5506445253_63264419320_IMG_20220705_091358.jpg"><br>çœ‹çš„å‡ºæ¥ï¼Œè¿™ç§çŸ­è€Œå¡åº¦å°çš„çº¿ï¼Œæ•ˆæœä¸æ˜¯å¾ˆå¤§ï¼Œå°±æ˜¯æ›´ç›´äº†ä¸€ç‚¹ï¼Œç„¶åæˆ‘ä»¬å†ç»™<code>Paint</code>è®¾ç½®<code>PathEffect</code>è¯•è¯•æ•ˆæœï¼Œä»£ç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">PathEffect</span> <span class="variable">pathEffect</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CornerPathEffect</span>(<span class="number">180</span>);</span><br><span class="line">linePaint.setPathEffect(pathEffect);</span><br></pre></td></tr></table></figure><p><code>CornerPathEffect</code>çš„ä½œç”¨æ˜¯é€šè¿‡å°†çº¿æ®µä¹‹é—´çš„ä»»ä½•é”è§’æ›¿æ¢ä¸ºæŒ‡å®šåŠå¾„çš„åœ†è§’æ¥è½¬æ¢ç»˜åˆ¶çš„å‡ ä½•å›¾å½¢ï¼ˆ<code>STROKE</code> æˆ– <code>FILL</code> æ ·å¼ï¼‰ã€‚å‚æ•°ï¼šåŠå¾„ - çº¿æ®µä¹‹é—´çš„åœ†è§’</p><p><img src="https://bu.dusays.com/2023/08/10/64d43fe98a87c.webp" alt="5506445253_63268350797_IMG_20220705_094126.jpg"><br>æ˜¯ä¸æ˜¯å¹³æ»‘äº†å¾ˆå¤šã€‚</p><h2 id="å¤©æ°”IconèƒŒæ™¯æ¡†"><a href="#å¤©æ°”IconèƒŒæ™¯æ¡†" class="headerlink" title="å¤©æ°”IconèƒŒæ™¯æ¡†"></a>å¤©æ°”IconèƒŒæ™¯æ¡†</h2><p>æ›²çº¿ç»“æŸä¹‹åå…ˆç”»å‡ºæ¯ä¸ªå¤©æ°”iconæ‰€åœ¨çš„çŸ©å½¢æ¡†ï¼Œæ¯ä¸ªçŸ©å½¢æ¡†ä¹‹é—´éƒ½æœ‰ä¸€å®šçš„ç¼éš™ï¼Œç›´æ¥ä¸Šä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Point</span> <span class="variable">point0</span> <span class="operator">=</span> listItems.get(<span class="number">0</span>).tempPoint;</span><br><span class="line"><span class="type">Path</span> <span class="variable">pathBG</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Path</span>();</span><br><span class="line">pathBG.moveTo(point0.x, point0.y);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; listItems.size(); i++) &#123;</span><br><span class="line">    <span class="type">Point</span> <span class="variable">point</span> <span class="operator">=</span> listItems.get(i).getTempPoint();</span><br><span class="line">    <span class="keyword">if</span> (i != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">Point</span> <span class="variable">pointPre</span> <span class="operator">=</span> listItems.get(i - <span class="number">1</span>).getTempPoint();</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">1</span>) &#123;</span><br><span class="line">            pathBG.lineTo(point.x, point.y);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (listItems.get(i).getIcon() != -<span class="number">1</span>)</span><br><span class="line">                pathBG.rLineTo(point.x - pointPre.x - DisplayUtil.dip2px(getContext(), <span class="number">1</span>), point.y - pointPre.y);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                pathBG.rLineTo(point.x - pointPre.x, point.y - pointPre.y);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Point</span> <span class="variable">pointBackup</span> <span class="operator">=</span> listItems.get(<span class="number">0</span>).getTempPoint();</span><br><span class="line">        <span class="keyword">if</span> (listItems.get(i).getIcon() != -<span class="number">1</span> || (getGoneBehind(i) &amp;&amp; i == listItems.size() - <span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; i; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (listItems.get(j).getIcon() != -<span class="number">1</span>) &#123;</span><br><span class="line">                    pointBackup = listItems.get(j).getTempPoint();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (listItems.get(i).getTempPoint() != pointBackup) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> mHeight - bottomTextHeight - DisplayUtil.dip2px(getContext(), <span class="number">4</span>) - point.y;</span><br><span class="line">                pathBG.rLineTo(<span class="number">0</span>, height);</span><br><span class="line">                pathBG.rLineTo(pointBackup.x - point.x + DisplayUtil.dip2px(getContext(), <span class="number">1</span>), <span class="number">0</span>);</span><br><span class="line">                canvas.drawPath(pathBG, rectPaint);</span><br><span class="line">                pathBG.reset();</span><br><span class="line">                <span class="comment">//ç§»åˆ°æ–°çš„ç‚¹å¼€å§‹ç”»</span></span><br><span class="line">                pathBG.moveTo(point.x, point.y);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">getGoneBehind</span><span class="params">(<span class="type">int</span> index)</span> &#123;</span><br><span class="line">    List&lt;Boolean&gt; data = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> index; k &lt; listItems.size(); k++) &#123;</span><br><span class="line">        data.add(listItems.get(k).res == -<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> !data.contains(<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå‰é¢å’Œç”»æ›²çº¿ä¸€æ ·ï¼ŒåŸç†å°±æ˜¯å…ˆç”»å‡ºä¸€ä¸ªå¤©æ°”iconæ‰€åœ¨çš„çŸ©å½¢æ¡†ä¸Šæ–¹çš„æ›²çº¿ï¼Œç„¶åä»æ›²çº¿çš„æœ«ç«¯å‘ä¸‹ç”»ä¸€æ¡ç›´çº¿ï¼Œåœ¨å‘å·¦ç”»è‡³çŸ©å½¢æ¡†çš„å·¦è¾¹ç•Œï¼Œç„¶åå°é—­èµ·æ¥ã€‚å¯ä»¥çœ‹åˆ°è¿™é‡Œé¢æœ‰å¾ˆå¤š<code>getIcon() != -1</code>çš„åˆ¤æ–­ï¼Œè¿™äº›æ˜¯åœ¨å¡æ•°æ®çš„æ—¶å€™åˆ¤æ–­å½“å‰æ—¶é—´æ®µçš„<code>icon</code>æ˜¯å¦å’Œä¸Šä¸€ä¸ªä¸€æ ·ï¼Œä¸€æ ·çš„è¯å°±æŠŠ<code>icon</code>æ›¿æ¢æˆ-1ï¼Œä»£ç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">icon</span> <span class="operator">=</span> list.get(<span class="number">0</span>).getIcon();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; list.size(); i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i != <span class="number">0</span> &amp;&amp; icon == list.get(i).getIcon()) &#123;</span><br><span class="line">        list.get(i).setIcon(-<span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        icon = list.get(i).getIcon();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºæ¯ä¸ªçŸ©å½¢ä¸­é—´éœ€è¦é—´éš™ï¼Œå°±åœ¨é¡¶éƒ¨å’Œåº•éƒ¨çš„çº¿æ—¶å‡å»äº†<code>1dp</code>ï¼Œä»£ç ä¸­å¯ä»¥çœ‹åˆ°é™¤äº†ç”»æ›²çº¿å¤–åªç”»äº†ä¸¤æ¡çº¿ï¼Œä½†æ˜¯å´å®ç°äº†å¡«å……çŸ©å½¢çš„æ•ˆæœï¼Œè¿™ä¸ªæ˜¯å› ä¸ºæˆ‘ç»™<code>rectPaint</code>è®¾ç½®äº†<code>Style</code>æ—¶ä¼ å…¥çš„å±æ€§æ˜¯<code>Paint.Style.FILL</code>ï¼Œè®¾ç½®<code>FILL</code>å±æ€§åï¼Œä¸‰è§’å½¢åªéœ€è¦ç”»å‡ºä¸¤æ¡çº¿å°±å¯è‡ªåŠ¨å°é—­ï¼ŒçŸ©å½¢ç”»å‡ºä¸‰æ¡çº¿ï¼Œå¦‚æœä¸æ–¹ä¾¿ä½¿ç”¨<code>FILL</code>å±æ€§çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨Pathæä¾›çš„æ–¹æ³•ï¼Œ<code>path.close();</code>ï¼Œæ•ˆæœç­‰åŒäº<code>FILL</code>ï¼Œå°é—­çŸ©å½¢åä½¿ç”¨<code>path.reset();</code>æ¸…é™¤è·¯å¾„ä¸­çš„æ‰€æœ‰çº¿æ¡å’Œæ›²çº¿ï¼Œç„¶åç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå¼€å§‹ç”»æ›²çº¿çš„ç‚¹ï¼Œå¾ªç¯ä¸‹å»ï¼Œçœ‹ä¸€ä¸‹æ•ˆæœ</p><p><img src="https://bu.dusays.com/2023/08/10/64d43fe986a2f.webp" alt="5506445253_63317592872_IMG_20220705_162537.jpg"></p><h2 id="å¤©æ°”Icon"><a href="#å¤©æ°”Icon" class="headerlink" title="å¤©æ°”Icon"></a>å¤©æ°”Icon</h2><p>çŸ©å½¢ç»“æŸä¹‹åå°±æ˜¯å¤©æ°”iconäº†ã€‚åœ¨çœ‹ä¸€ä¸‹å¢¨è¿¹å¤©æ°”çš„æ•ˆæœå›¾<br><img src="https://bu.dusays.com/2023/08/10/64d43fec59021.webp" alt="5506445253_63249103744_1656936370197_694x449.gif"></p><p>ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå¤©æ°”çš„<code>icon</code>æ˜¯åœ¨æ¯ä¸ªçŸ©å½¢çš„æ­£ä¸­é—´ï¼Œéšç€æ‰‹æŒ‡çš„æ»‘åŠ¨ï¼Œæœ€å·¦è¾¹çš„<code>icon</code>æ‰€åœ¨çš„çŸ©å½¢å¦‚æœè¢«<code>view</code>çš„å·¦è¾¹ç•Œç›–ä½ï¼ŒçŸ©å½¢ä¸­çš„<code>icon</code>ä¿æŒåœ¨<code>view</code>çš„å·¦è¾¹ç•Œå’ŒçŸ©å½¢çš„å³è¾¹ç•Œä¸­é—´ï¼Œæœ€å³è¾¹åŒç†ã€‚ä»£ç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; listItems.size(); i++) &#123;</span><br><span class="line">    <span class="type">Point</span> <span class="variable">point</span> <span class="operator">=</span> listItems.get(i).getTempPoint();</span><br><span class="line">    <span class="keyword">if</span> (i != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">Point</span> <span class="variable">pointBackup</span> <span class="operator">=</span> listItems.get(<span class="number">0</span>).getTempPoint();</span><br><span class="line">        <span class="keyword">if</span> (listItems.get(i).getIcon() != -<span class="number">1</span> || (getGoneBehind(i) &amp;&amp; i == listItems.size() - <span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">icon</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">indexBackUp</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; i; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (listItems.get(j).getIcon() != -<span class="number">1</span>) &#123;</span><br><span class="line">                    icon = listItems.get(j).getIcon();</span><br><span class="line">                    indexBackUp = j;</span><br><span class="line">                    pointBackup = listItems.get(j).getTempPoint();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (listItems.get(i).getTempPoint() != pointBackup) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">left</span> <span class="operator">=</span> (point.x - pointBackup.x) / <span class="number">2</span> + pointBackup.x - DisplayUtil.dip2px(getContext(), <span class="number">10</span>);</span><br><span class="line">                <span class="type">int</span> <span class="variable">right</span> <span class="operator">=</span> (point.x - pointBackup.x) / <span class="number">2</span> + pointBackup.x + DisplayUtil.dip2px(getContext(), <span class="number">10</span>);</span><br><span class="line">                <span class="type">int</span> <span class="variable">newLeft</span> <span class="operator">=</span> (point.x - (pointBackup.x - getItemLeftMargin(indexBackUp))) / <span class="number">2</span> + (pointBackup.x - getItemLeftMargin(indexBackUp));</span><br><span class="line">                <span class="type">int</span> <span class="variable">newRight</span> <span class="operator">=</span> ((point.x + getItemRightMargin(i)) - pointBackup.x) / <span class="number">2</span> + pointBackup.x;</span><br><span class="line">                <span class="keyword">if</span> (getItemLeftMargin(indexBackUp) &lt; <span class="number">0</span> &amp;&amp; newLeft + DisplayUtil.dip2px(getContext(), <span class="number">20</span>) &lt; point.x &amp;&amp; i - indexBackUp &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                    left = newLeft - DisplayUtil.dip2px(getContext(), <span class="number">10</span>);</span><br><span class="line">                    right = left + DisplayUtil.dip2px(getContext(), <span class="number">20</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (getItemLeftMargin(indexBackUp) &lt; <span class="number">0</span> &amp;&amp; newLeft + DisplayUtil.dip2px(getContext(), <span class="number">40</span>) &gt;= point.x &amp;&amp; i - indexBackUp &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                    left = point.x - DisplayUtil.dip2px(getContext(), <span class="number">30</span>);</span><br><span class="line">                    right = left + DisplayUtil.dip2px(getContext(), <span class="number">20</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (getItemRightMargin(i) &lt; <span class="number">0</span> &amp;&amp; newRight &gt; pointBackup.x + DisplayUtil.dip2px(getContext(), <span class="number">10</span>) &amp;&amp; i - indexBackUp &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                    right = newRight + DisplayUtil.dip2px(getContext(), <span class="number">10</span>);</span><br><span class="line">                    left = right - DisplayUtil.dip2px(getContext(), <span class="number">20</span>);</span><br><span class="line">                &#125;                            </span><br><span class="line">                <span class="keyword">if</span> (getItemLeftMargin(indexBackUp) &lt; <span class="number">0</span> &amp;&amp; getItemRightMargin(i) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                     left = pointBackup.x - getItemLeftMargin(indexBackUp) + scrollWidth / <span class="number">2</span> - DisplayUtil.dip2px(getContext(), <span class="number">10</span>);</span><br><span class="line">                     right = left + DisplayUtil.dip2px(getContext(), <span class="number">20</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">Drawable</span> <span class="variable">drawable</span> <span class="operator">=</span> ContextCompat.getDrawable(getContext(), icon);</span><br><span class="line">                drawable.setBounds(left,</span><br><span class="line">                        tempBaseBottom + DisplayUtil.dip2px(getContext(), <span class="number">5</span>),</span><br><span class="line">                        right,</span><br><span class="line">                        tempBaseBottom + DisplayUtil.dip2px(getContext(), <span class="number">25</span>));</span><br><span class="line">                drawable.draw(canvas);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆå°±æ˜¯æ‹¿åˆ°<code>icon</code>æ‰€åœ¨çŸ©å½¢ä¸Šæ–¹æ›²çº¿çš„èµ·å§‹ç‚¹ï¼Œè®°ä½èµ·å§‹ç‚¹çš„ä¸‹æ ‡ï¼Œ<code>x</code>ï¼Œ<code>y</code>å’Œ<code>icon</code>ï¼Œ<code>icon</code>æ‰€åœ¨çŸ©å½¢ä¸Šæ–¹æ›²çº¿ç»“æŸç‚¹çš„<code>x</code>è½´åæ ‡å‡å»<code>icon</code>æ‰€åœ¨çŸ©å½¢ä¸Šæ–¹æ›²çº¿èµ·å§‹ç‚¹çš„xè½´åæ ‡å°±å¯ä»¥æ‹¿åˆ°è¿™ä¸ªçŸ©å½¢çš„å®½ï¼Œå®½é™¤2åœ¨åŠ ä¸Š<code>icon</code>æ‰€åœ¨çŸ©å½¢ä¸Šæ–¹æ›²çº¿ç»“æŸç‚¹çš„xè½´åæ ‡å°±æ˜¯çŸ©å½¢ä¸­é—´ç‚¹è·ç¦»å·¦è¾¹çš„è¾¹è·ï¼Œé»˜è®¤iconçš„leftå’Œrightæ˜¯åœ¨ä¸­é—´ç‚¹çš„åŸºç¡€ä¸Šå‡å»10dpå’ŒåŠ ä¸Š10dpã€‚<br>ç„¶åå°±æ˜¯åˆ¤æ–­å½“å‰<code>icon</code>æ‰€åœ¨çš„çŸ©å½¢å·¦è¾¹ç•Œæˆ–è€…å³è¾¹ç•Œæ˜¯å¦è¶…å‡º<code>view</code>çš„è¾¹ç•Œï¼Œå› ä¸º<code>newLeft</code>æ˜¯éšç€æ‰‹æŒ‡æ»‘åŠ¨ä¸æ–­å‡å°æˆ–è€…å¢åŠ çš„ï¼Œæ‰€ä»¥éœ€è¦æ»¡è¶³å½“å‰<code>icon</code>æ‰€åœ¨çŸ©å½¢çš„å·¦è¾¹ç•Œè¶…å‡º<code>view</code>çš„è¾¹ç•Œï¼Œä¸”å·¦è¾¹ç•Œä¸èƒ½è¶…è¿‡å³è¾¹ç•Œï¼Œå³è¾¹åŒç†ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“å‰iconçš„çŸ©å½¢å¦‚æœåªå äº†ä¸€æ ¼ï¼Œå°±ä¸éœ€è¦æ”¹å˜è¾¹ç•Œï¼Œä¸€ç›´ä¿æŒåœ¨çŸ©å½¢çš„ä¸­é—´å°±å¥½ã€‚é™¤äº†è¿™ä¸¤ç§æƒ…å†µå¤–è¿˜æœ‰ä¸€ç§æƒ…å†µï¼Œå°±æ˜¯çŸ©å½¢ä¸¤è¾¹éƒ½è¶…å‡º<code>view</code>çš„è¾¹ç•Œï¼Œè¿™æ—¶å°±æ˜¯è®©å¤©æ°”<code>icon</code>ä¿æŒåœ¨<code>view</code>çš„æ­£ä¸­é—´å°±å¥½äº†ã€‚<br>é‚£ä¹ˆå¦‚ä½•æ‹¿åˆ°å½“å‰<code>icon</code>æ‰€åœ¨çŸ©å½¢ä¸Šæ–¹æ›²çº¿èµ·å§‹ç‚¹è·ç¦»<code>view</code>å·¦è¾¹ç•Œçš„è·ç¦»å‘¢ï¼Œä»£ç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* ç‚¹è·ç¦»å·¦è¾¹çš„ä½ç½®</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span>  i </span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span>  </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">getItemLeftMargin</span><span class="params">(<span class="type">int</span> i)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">left</span> <span class="operator">=</span> MARGIN_LEFT_ITEM + i * ITEM_WIDTH + ITEM_WIDTH / <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">return</span> left - scrollOffset;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* ç‚¹è·ç¦»å³è¾¹çš„ä½ç½®</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> i</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">getItemRightMargin</span><span class="params">(<span class="type">int</span> i)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">left</span> <span class="operator">=</span> MARGIN_LEFT_ITEM + i * ITEM_WIDTH + ITEM_WIDTH / <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">return</span> scrollWidth - (left - scrollOffset);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>MARGIN_LEFT_ITEM</code>ï¼šå·¦è¾¹é¢„ç•™å®½åº¦<br><code>ITEM_WIDTH</code>ï¼šæ¯ä¸ªItemçš„å®½åº¦<br><code>scrollOffset</code>ï¼šæ»šåŠ¨åç§»é‡<br><code>scrollWidth</code>ï¼š<code>HorizontalScrollView</code>çš„å®½åº¦<br>å·¦è¾¹ç•Œè·ç¦»å±å¹•å·¦è¾¹çš„ç¼–è¾‘å°±æ˜¯å½“å‰<code>icon</code>æ‰€åœ¨çŸ©å½¢ä¸Šæ–¹æ›²çº¿èµ·å§‹ç‚¹çš„xè½´å‡å»æ»‘åŠ¨çš„åç§»é‡ï¼Œå³è¾¹ç•Œè·ç¦»å³è¾¹å°±æ˜¯<code>HorizontalScrollView</code>çš„å®½åº¦å‡å»è·ç¦»å±å¹•å·¦è¾¹ç•Œçš„å€¼<br>24å°æ—¶å¤©æ°”è‡ªå®šä¹‰viewæ˜¯è¢«å¦ä¸€ä¸ªè‡ªå®šä¹‰Viewä¸­åŒ…å«çš„ï¼Œå®ƒç»§æ‰¿äº<code>HorizontalScrollView</code>ï¼Œéœ€è¦ä¿®æ”¹çš„ä»£ç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onDraw</span><span class="params">(Canvas canvas)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onDraw(canvas);</span><br><span class="line">    <span class="type">int</span> <span class="variable">offset</span> <span class="operator">=</span> computeHorizontalScrollOffset();</span><br><span class="line">    <span class="type">int</span> <span class="variable">maxOffset</span> <span class="operator">=</span> computeHorizontalScrollRange() - DisplayUtil.getScreenWidth(getContext());</span><br><span class="line">    <span class="keyword">if</span> (today24HourView != <span class="literal">null</span>) &#123;</span><br><span class="line">        today24HourView.setScrollOffset(offset, maxOffset, getWidth());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setToday24HourView</span><span class="params">(Today24HourView today24HourView)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.today24HourView = today24HourView;</span><br><span class="line">    invalidate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>computeHorizontalScrollOffsetï¼ˆï¼‰</code>è®¡ç®—æ°´å¹³æ»šåŠ¨æ¡æ‹‡æŒ‡åœ¨æ°´å¹³èŒƒå›´å†…çš„æ°´å¹³åç§»é‡<br><code>computeHorizontalScrollRangeï¼ˆï¼‰</code>æ»šåŠ¨è§†å›¾çš„æ»šåŠ¨èŒƒå›´æ˜¯å…¶æ‰€æœ‰å­è§†å›¾çš„æ€»å®½åº¦</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è®¾ç½®scrollerViewçš„æ»šåŠ¨æ¡çš„ä½ç½®ï¼Œé€šè¿‡ä½ç½®è®¡ç®—å½“å‰çš„æ—¶æ®µ</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setScrollOffset</span><span class="params">(<span class="type">int</span> offset, <span class="type">int</span> maxScrollOffset, <span class="type">int</span> scrollWidth)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.maxScrollOffset = maxScrollOffset;</span><br><span class="line">    <span class="built_in">this</span>.scrollWidth = scrollWidth;</span><br><span class="line">    scrollOffset = offset;</span><br><span class="line">    currentItemIndex = calculateItemIndex(offset);</span><br><span class="line">    invalidate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>maxScrollOffset</code>ï¼šæœ€å¤§æ»šåŠ¨è·ç¦»<br><code>scrollWidth</code>ï¼š<code>HorizontalScrollView</code>çš„å®½åº¦<br><code>scrollOffset</code>ï¼šæ»šåŠ¨åç§»é‡<br>xmlä¸­ä»£ç å¦‚ä¸‹</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">com.weather.gorgeous.custom_view.IndexHorizontalScrollView</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:layout_width</span>=<span class="string">&quot;0dp&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:fadeScrollbars</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:scrollbars</span>=<span class="string">&quot;none&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">com.weather.gorgeous.custom_view.Today24HourView</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">com.weather.gorgeous.custom_view.IndexHorizontalScrollView</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://bu.dusays.com/2023/08/10/64d43fe9a3d89.webp" alt="5506445253_63324907904_1657012359644_687x218.gif"></p><h2 id="å¤©æ°”æŒ‡é’ˆ"><a href="#å¤©æ°”æŒ‡é’ˆ" class="headerlink" title="å¤©æ°”æŒ‡é’ˆ"></a>å¤©æ°”æŒ‡é’ˆ</h2><p>æ¥ä¸‹æ¥å°±æ˜¯å½“å‰å¤©æ°”æŒ‡é’ˆäº†ï¼Œå°±æ˜¯æ ¹æ®æ‰‹æŒ‡æ»‘åŠ¨ï¼Œå‘å·¦æˆ–å‘å³åç§»ï¼Œå¹¶ä¸”æ»‘åŠ¨åˆ°ä¸åŒçš„itemï¼Œæ”¹å˜æŒ‡é’ˆä¸­çš„å†…å®¹ï¼Œä»£ç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">WeatherHoursModel</span> <span class="variable">item</span> <span class="operator">=</span> listItems.get(i);</span><br><span class="line"><span class="keyword">if</span> (currentItemIndex == i) &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">Y</span> <span class="operator">=</span> getTempBarY();</span><br><span class="line">    <span class="type">Rect</span> <span class="variable">targetRect</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Rect</span>(</span><br><span class="line">        getScrollBarX(),</span><br><span class="line">        Y - DisplayUtil.dip2px(getContext(), <span class="number">40</span>),</span><br><span class="line">        getScrollBarX() + DisplayUtil.dip2px(getContext(), <span class="number">92</span>),</span><br><span class="line">        Y - DisplayUtil.dip2px(getContext(), <span class="number">14</span>));</span><br><span class="line">    <span class="type">Drawable</span> <span class="variable">drawable</span> <span class="operator">=</span> ContextCompat.getDrawable(getContext(), R.drawable.bg_indicator_text);</span><br><span class="line">    drawable.setBounds(targetRect);</span><br><span class="line">    drawable.draw(canvas);</span><br><span class="line">    <span class="comment">//ç”»å‡ºæ¸©åº¦æç¤º</span></span><br><span class="line">    Paint.<span class="type">FontMetricsInt</span> <span class="variable">fontMetrics</span> <span class="operator">=</span> textPaint.getFontMetricsInt();</span><br><span class="line">    <span class="type">int</span> <span class="variable">baseline</span> <span class="operator">=</span> (targetRect.bottom + targetRect.top - fontMetrics.bottom - fontMetrics.top) / <span class="number">2</span>;</span><br><span class="line">    textPaint.setTextAlign(Paint.Align.CENTER);</span><br><span class="line">    textPaint.setTextSize(DisplayUtil.sp2px(getContext(), <span class="number">10</span>));</span><br><span class="line">    canvas.drawText(TimeUtils.getDateHHmm(item.getTempStamp()) + <span class="string">&quot; &quot;</span> + item.getWeather() + <span class="string">&quot;  &quot;</span> + item.getTemperature() + <span class="string">&quot;Â°&quot;</span>, targetRect.centerX(), baseline, textPaint);</span><br><span class="line">    <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> mHeight - bottomTextHeight - DisplayUtil.dip2px(getContext(), <span class="number">4</span>);</span><br><span class="line">    canvas.drawLine(targetRect.centerX(), targetRect.bottom + DisplayUtil.dip2px(getContext(), <span class="number">4</span>), targetRect.centerX(), height, indicatorLinePaint);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è®¡ç®—æ¸©åº¦æç¤ºæ–‡å­—çš„è¿åŠ¨è½¨è¿¹</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">getTempBarY</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> getScrollBarX();</span><br><span class="line">    <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> MARGIN_LEFT_ITEM;</span><br><span class="line">    <span class="type">Point</span> <span class="variable">startPoint</span> <span class="operator">=</span> <span class="literal">null</span>, endPoint;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ITEM_SIZE; i++) &#123;</span><br><span class="line">        sum += ITEM_WIDTH;</span><br><span class="line">        <span class="keyword">if</span> (x &lt; sum) &#123;</span><br><span class="line">            startPoint = listItems.get(i).getTempPoint();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (i + <span class="number">1</span> &gt;= ITEM_SIZE || startPoint == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">return</span> listItems.get(ITEM_SIZE - <span class="number">1</span>).getTempPoint().y;</span><br><span class="line">    endPoint = listItems.get(i + <span class="number">1</span>).getTempPoint();</span><br><span class="line">    <span class="type">int</span> <span class="variable">left</span> <span class="operator">=</span> MARGIN_LEFT_ITEM + i * ITEM_WIDTH;</span><br><span class="line">    <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> (<span class="type">int</span>) (startPoint.y + (x - left) * <span class="number">1.0</span> / ITEM_WIDTH * (endPoint.y - startPoint.y));</span><br><span class="line">    <span class="keyword">return</span> y;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">getScrollBarX</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> (ITEM_SIZE - <span class="number">5</span>) * ITEM_WIDTH * scrollOffset / maxScrollOffset;</span><br><span class="line">    x = x + MARGIN_LEFT_ITEM;</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://bu.dusays.com/2023/08/10/64d43fe9a0077.webp" alt="5506445253_63340840294_1657023135269_687x228.gif"></p><p>ç„¶åå°±æ˜¯å®ç°å½“å‰é€‰ä¸­çŸ©å½¢æ”¹å˜é¢œè‰²ï¼Œè¿™ä¸ªå¾ˆç®€å•ï¼Œä»£ç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (pointBackup.x &lt; getScrollBarX() + DisplayUtil.dip2px(getContext(), <span class="number">46</span>) &amp;&amp; getScrollBarX() + DisplayUtil.dip2px(getContext(), <span class="number">46</span>) &lt; point.x) &#123;</span><br><span class="line">    rectPaint.setColor(Color.parseColor(<span class="string">&quot;#33FFFFFF&quot;</span>));</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    rectPaint.setColor(Color.parseColor(<span class="string">&quot;#1AFFFFFF&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³äºä¸‹é¢çš„æ—¶é—´å­—æ®µï¼Œå’Œå·¦é¢çš„æœ€é«˜æ¸©å’Œæœ€ä½æ¸©å°±ä¸å†™äº†ï¼Œå¾ˆç®€å•ï¼Œè®¡ç®—ä¸€ä¸‹ä½ç½®å°±è¡Œï¼Œæœ‰å…´è¶£çš„å¤åˆ¶ä¸‹é¢å®Œæ•´ä»£ç </p><h2 id="å®Œæ•´ä»£ç "><a href="#å®Œæ•´ä»£ç " class="headerlink" title="å®Œæ•´ä»£ç "></a>å®Œæ•´ä»£ç </h2><p><code>Today24HourView.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Today24HourView</span> <span class="keyword">extends</span> <span class="title class_">View</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;Today24HourView&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ITEM_SIZE</span> <span class="operator">=</span> <span class="number">24</span>;  <span class="comment">//24å°æ—¶</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> ITEM_WIDTH; <span class="comment">//æ¯ä¸ªItemçš„å®½åº¦</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> MARGIN_LEFT_ITEM; <span class="comment">//å·¦è¾¹é¢„ç•™å®½åº¦</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> MARGIN_RIGHT_ITEM; <span class="comment">//å³è¾¹é¢„ç•™å®½åº¦</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> bottomTextHeight;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> scrollWidth;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> mHeight, mWidth;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> tempBaseTop;  <span class="comment">//æ¸©åº¦æŠ˜çº¿çš„ä¸Šè¾¹Yåæ ‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> tempBaseBottom; <span class="comment">//æ¸©åº¦æŠ˜çº¿çš„ä¸‹è¾¹Yåæ ‡</span></span><br><span class="line">    <span class="keyword">private</span> Paint bitmapPaint, linePaint, rectPaint, indicatorLinePaint;</span><br><span class="line">    <span class="keyword">private</span> TextPaint textPaint;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;WeatherHoursModel&gt; listItems;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">maxScrollOffset</span> <span class="operator">=</span> <span class="number">0</span>;<span class="comment">//æ»šåŠ¨æ¡æœ€é•¿æ»šåŠ¨è·ç¦»</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">scrollOffset</span> <span class="operator">=</span> <span class="number">0</span>; <span class="comment">//æ»šåŠ¨æ¡åç§»é‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">currentItemIndex</span> <span class="operator">=</span> <span class="number">0</span>; <span class="comment">//å½“å‰æ»šåŠ¨çš„ä½ç½®æ‰€å¯¹åº”çš„itemä¸‹æ ‡</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> maxTemp;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> minTemp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Today24HourView</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(context, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Today24HourView</span><span class="params">(Context context, AttributeSet attrs)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(context, attrs, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Today24HourView</span><span class="params">(Context context, AttributeSet attrs, <span class="type">int</span> defStyleAttr)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context, attrs, defStyleAttr);</span><br><span class="line">        init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        MARGIN_LEFT_ITEM = DisplayUtil.dip2px(getContext(), <span class="number">2</span>);</span><br><span class="line">        MARGIN_RIGHT_ITEM = DisplayUtil.dip2px(getContext(), <span class="number">20</span>);</span><br><span class="line">        ITEM_WIDTH = DisplayUtil.dip2px(getContext(), <span class="number">30</span>);</span><br><span class="line">        bottomTextHeight = DisplayUtil.dip2px(getContext(), <span class="number">16</span>);</span><br><span class="line">        mWidth = MARGIN_LEFT_ITEM + MARGIN_RIGHT_ITEM + ITEM_SIZE * ITEM_WIDTH;</span><br><span class="line">        mHeight = DisplayUtil.dip2px(getContext(), <span class="number">140</span>);</span><br><span class="line">        tempBaseTop = (mHeight - bottomTextHeight) / <span class="number">3</span>;</span><br><span class="line">        tempBaseBottom = (mHeight - bottomTextHeight) * <span class="number">3</span> / <span class="number">4</span>;</span><br><span class="line">        listItems = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        initPaint();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initPaint</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        rectPaint = <span class="keyword">new</span> <span class="title class_">Paint</span>();</span><br><span class="line">        rectPaint.setColor(Color.parseColor(<span class="string">&quot;#1AFFFFFF&quot;</span>));</span><br><span class="line">        rectPaint.setAntiAlias(<span class="literal">true</span>);</span><br><span class="line">        rectPaint.setStyle(Paint.Style.FILL);</span><br><span class="line">        rectPaint.setStrokeCap(Paint.Cap.ROUND);</span><br><span class="line">        rectPaint.setStrokeJoin(Paint.Join.ROUND);</span><br><span class="line">        rectPaint.setStrokeWidth(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">PathEffect</span> <span class="variable">pathEffect</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CornerPathEffect</span>(<span class="number">180</span>);</span><br><span class="line">        linePaint = <span class="keyword">new</span> <span class="title class_">Paint</span>();</span><br><span class="line">        linePaint.setColor(Color.WHITE);</span><br><span class="line">        linePaint.setPathEffect(pathEffect);</span><br><span class="line">        linePaint.setAntiAlias(<span class="literal">true</span>);</span><br><span class="line">        linePaint.setStrokeCap(Paint.Cap.ROUND);</span><br><span class="line">        linePaint.setStrokeJoin(Paint.Join.ROUND);</span><br><span class="line">        linePaint.setStyle(Paint.Style.STROKE);</span><br><span class="line">        linePaint.setStrokeWidth(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        textPaint = <span class="keyword">new</span> <span class="title class_">TextPaint</span>();</span><br><span class="line">        textPaint.setColor(Color.WHITE);</span><br><span class="line">        textPaint.setAntiAlias(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        bitmapPaint = <span class="keyword">new</span> <span class="title class_">Paint</span>();</span><br><span class="line">        bitmapPaint.setAntiAlias(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        indicatorLinePaint = <span class="keyword">new</span> <span class="title class_">Paint</span>();</span><br><span class="line">        indicatorLinePaint = <span class="keyword">new</span> <span class="title class_">Paint</span>();</span><br><span class="line">        indicatorLinePaint.setColor(Color.WHITE);</span><br><span class="line">        indicatorLinePaint.setAntiAlias(<span class="literal">true</span>);</span><br><span class="line">        indicatorLinePaint.setStrokeCap(Paint.Cap.ROUND);</span><br><span class="line">        indicatorLinePaint.setStyle(Paint.Style.STROKE);</span><br><span class="line">        indicatorLinePaint.setStrokeWidth(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setHourItems</span><span class="params">(List&lt;WeatherHoursModel&gt; listItems)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.listItems.clear();</span><br><span class="line">        List&lt;WeatherHoursModel&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(listItems);</span><br><span class="line">        maxTemp = list.get(<span class="number">0</span>).getTemperature();</span><br><span class="line">        minTemp = list.get(<span class="number">0</span>).getTemperature();</span><br><span class="line">        <span class="keyword">for</span> (WeatherHoursModel listItem : list) &#123;</span><br><span class="line">            <span class="keyword">if</span> (listItem.getTemperature() &gt; maxTemp)</span><br><span class="line">                maxTemp = listItem.getTemperature();</span><br><span class="line">            <span class="keyword">if</span> (listItem.getTemperature() &lt; minTemp)</span><br><span class="line">                minTemp = listItem.getTemperature();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">icon</span> <span class="operator">=</span> list.get(<span class="number">0</span>).getIcon();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; list.size(); i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">left</span> <span class="operator">=</span> MARGIN_LEFT_ITEM + i * ITEM_WIDTH;</span><br><span class="line">            <span class="type">int</span> <span class="variable">right</span> <span class="operator">=</span> left + ITEM_WIDTH;</span><br><span class="line">            <span class="type">Point</span> <span class="variable">point</span> <span class="operator">=</span> calculateTempPoint(left, right, list.get(i).getTemperature());</span><br><span class="line">            <span class="keyword">if</span> (i != <span class="number">0</span> &amp;&amp; icon == list.get(i).getIcon()) &#123;</span><br><span class="line">                list.get(i).setIcon(-<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                icon = list.get(i).getIcon();</span><br><span class="line">            &#125;</span><br><span class="line">            list.get(i).setTempPoint(point);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.listItems.addAll(list);</span><br><span class="line">        invalidate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Point <span class="title function_">calculateTempPoint</span><span class="params">(<span class="type">int</span> left, <span class="type">int</span> right, <span class="type">int</span> temp)</span> &#123;</span><br><span class="line">        <span class="type">double</span> <span class="variable">minHeight</span> <span class="operator">=</span> tempBaseTop;</span><br><span class="line">        <span class="type">double</span> <span class="variable">maxHeight</span> <span class="operator">=</span> tempBaseBottom;</span><br><span class="line">        <span class="type">double</span> <span class="variable">tempY</span> <span class="operator">=</span> maxHeight - (temp - minTemp) * <span class="number">1.0</span> / (maxTemp - minTemp) * (maxHeight - minHeight);</span><br><span class="line">        <span class="type">Point</span> <span class="variable">point</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Point</span>((left + right) / <span class="number">2</span>, (<span class="type">int</span>) tempY);</span><br><span class="line">        <span class="keyword">return</span> point;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onMeasure</span><span class="params">(<span class="type">int</span> widthMeasureSpec, <span class="type">int</span> heightMeasureSpec)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">        setMeasuredDimension(mWidth, mHeight);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onLayout</span><span class="params">(<span class="type">boolean</span> changed, <span class="type">int</span> left, <span class="type">int</span> top, <span class="type">int</span> right, <span class="type">int</span> bottom)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onLayout(changed, left, top, right, bottom);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onDraw</span><span class="params">(Canvas canvas)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onDraw(canvas);</span><br><span class="line">        onDrawLine(canvas);</span><br><span class="line"><span class="comment">//        drawLeftTempText(canvas);</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; listItems.size(); i++) &#123;</span><br><span class="line">            onDrawTemp(canvas, i);</span><br><span class="line">            onDrawText(canvas, i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">onDrawTemp</span><span class="params">(Canvas canvas, <span class="type">int</span> i)</span> &#123;</span><br><span class="line">        <span class="type">WeatherHoursModel</span> <span class="variable">item</span> <span class="operator">=</span> listItems.get(i);</span><br><span class="line">        <span class="keyword">if</span> (currentItemIndex == i) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">Y</span> <span class="operator">=</span> getTempBarY();</span><br><span class="line">            <span class="type">Rect</span> <span class="variable">targetRect</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Rect</span>(</span><br><span class="line">                    getScrollBarX(),</span><br><span class="line">                    Y - DisplayUtil.dip2px(getContext(), <span class="number">40</span>),</span><br><span class="line">                    getScrollBarX() + DisplayUtil.dip2px(getContext(), <span class="number">92</span>),</span><br><span class="line">                    Y - DisplayUtil.dip2px(getContext(), <span class="number">14</span>));</span><br><span class="line">            <span class="type">Drawable</span> <span class="variable">drawable</span> <span class="operator">=</span> ContextCompat.getDrawable(getContext(), R.drawable.bg_indicator_text);</span><br><span class="line">            drawable.setBounds(targetRect);</span><br><span class="line">            drawable.draw(canvas);</span><br><span class="line">            <span class="comment">//ç”»å‡ºæ¸©åº¦æç¤º</span></span><br><span class="line">            Paint.<span class="type">FontMetricsInt</span> <span class="variable">fontMetrics</span> <span class="operator">=</span> textPaint.getFontMetricsInt();</span><br><span class="line">            <span class="type">int</span> <span class="variable">baseline</span> <span class="operator">=</span> (targetRect.bottom + targetRect.top - fontMetrics.bottom - fontMetrics.top) / <span class="number">2</span>;</span><br><span class="line">            textPaint.setTextAlign(Paint.Align.CENTER);</span><br><span class="line">            textPaint.setTextSize(DisplayUtil.sp2px(getContext(), <span class="number">10</span>));</span><br><span class="line">            canvas.drawText(TimeUtils.getDateHHmm(item.getTempStamp()) + <span class="string">&quot; &quot;</span> + item.getWeather() + <span class="string">&quot;  &quot;</span> + item.getTemperature() + <span class="string">&quot;Â°&quot;</span>, targetRect.centerX(), baseline, textPaint);</span><br><span class="line">            <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> mHeight - bottomTextHeight - DisplayUtil.dip2px(getContext(), <span class="number">4</span>);</span><br><span class="line">            canvas.drawLine(targetRect.centerX(), targetRect.bottom + DisplayUtil.dip2px(getContext(), <span class="number">4</span>), targetRect.centerX(), height, indicatorLinePaint);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¸©åº¦çš„æŠ˜çº¿,ä¸ºäº†æŠ˜çº¿æ¯”è¾ƒå¹³æ»‘,åšäº†è´å¡å°”æ›²çº¿</span></span><br><span class="line"><span class="comment">     * ç”»äº†è´å¡å°”æ›²çº¿åä¸€ç‚¹éƒ½ä¸å¹³æ»‘,æ”¾å¼ƒ</span></span><br><span class="line"><span class="comment">     * ç›´æ¥ä½¿ç”¨ç›´çº¿è¿æ¥èµ·æ¥,ç”¨CornerPathEffectæ”¹å˜è¿æ¥å¤„çš„å¼§åº¦,é¡ºæ»‘æ— æ¯”</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> canvas</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">onDrawLine</span><span class="params">(Canvas canvas)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (listItems.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">Path</span> <span class="variable">path</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Path</span>();</span><br><span class="line">            <span class="type">Point</span> <span class="variable">point0</span> <span class="operator">=</span> listItems.get(<span class="number">0</span>).getTempPoint();</span><br><span class="line">            path.moveTo(point0.x, point0.y);</span><br><span class="line">            <span class="type">Path</span> <span class="variable">pathBG</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Path</span>();</span><br><span class="line">            pathBG.moveTo(point0.x, point0.y);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; listItems.size(); i++) &#123;</span><br><span class="line">                <span class="type">Point</span> <span class="variable">point</span> <span class="operator">=</span> listItems.get(i).getTempPoint();</span><br><span class="line">                <span class="keyword">if</span> (i != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="type">Point</span> <span class="variable">pointPre</span> <span class="operator">=</span> listItems.get(i - <span class="number">1</span>).getTempPoint();</span><br><span class="line">                    <span class="keyword">if</span> (i == <span class="number">1</span>) &#123;</span><br><span class="line">                        path.lineTo(point.x, point.y);</span><br><span class="line">                        pathBG.lineTo(point.x, point.y);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        path.rLineTo(point.x - pointPre.x, point.y - pointPre.y);</span><br><span class="line">                        <span class="keyword">if</span> (listItems.get(i).getIcon() != -<span class="number">1</span>)</span><br><span class="line">                            pathBG.rLineTo(point.x - pointPre.x - DisplayUtil.dip2px(getContext(), <span class="number">1</span>), point.y - pointPre.y);</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                            pathBG.rLineTo(point.x - pointPre.x, point.y - pointPre.y);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="type">Point</span> <span class="variable">pointBackup</span> <span class="operator">=</span> listItems.get(<span class="number">0</span>).getTempPoint();</span><br><span class="line">                    <span class="keyword">if</span> (listItems.get(i).getIcon() != -<span class="number">1</span> || (getGoneBehind(i) &amp;&amp; i == listItems.size() - <span class="number">1</span>)) &#123;</span><br><span class="line">                        <span class="type">int</span> <span class="variable">icon</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">                        <span class="type">int</span> <span class="variable">indexBackUp</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; i; j++) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (listItems.get(j).getIcon() != -<span class="number">1</span>) &#123;</span><br><span class="line">                                icon = listItems.get(j).getIcon();</span><br><span class="line">                                indexBackUp = j;</span><br><span class="line">                                pointBackup = listItems.get(j).getTempPoint();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (pointBackup.x &lt; getScrollBarX() + DisplayUtil.dip2px(getContext(), <span class="number">46</span>) &amp;&amp; getScrollBarX() + DisplayUtil.dip2px(getContext(), <span class="number">46</span>) &lt; point.x) &#123;</span><br><span class="line">                            rectPaint.setColor(Color.parseColor(<span class="string">&quot;#33FFFFFF&quot;</span>));</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            rectPaint.setColor(Color.parseColor(<span class="string">&quot;#1AFFFFFF&quot;</span>));</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (listItems.get(i).getTempPoint() != pointBackup) &#123;</span><br><span class="line">                            <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> mHeight - bottomTextHeight - DisplayUtil.dip2px(getContext(), <span class="number">4</span>) - point.y;</span><br><span class="line">                            pathBG.rLineTo(<span class="number">0</span>, height);</span><br><span class="line">                            pathBG.rLineTo(pointBackup.x - point.x + DisplayUtil.dip2px(getContext(), <span class="number">1</span>), <span class="number">0</span>);</span><br><span class="line">                            canvas.drawPath(pathBG, rectPaint);</span><br><span class="line">                            pathBG.reset();</span><br><span class="line">                            <span class="comment">//ç§»åˆ°æ–°çš„ç‚¹å¼€å§‹ç”»</span></span><br><span class="line">                            pathBG.moveTo(point.x, point.y);</span><br><span class="line"></span><br><span class="line">                            <span class="type">int</span> <span class="variable">left</span> <span class="operator">=</span> (point.x - pointBackup.x) / <span class="number">2</span> + pointBackup.x - DisplayUtil.dip2px(getContext(), <span class="number">10</span>);</span><br><span class="line">                            <span class="type">int</span> <span class="variable">right</span> <span class="operator">=</span> (point.x - pointBackup.x) / <span class="number">2</span> + pointBackup.x + DisplayUtil.dip2px(getContext(), <span class="number">10</span>);</span><br><span class="line">                            <span class="type">int</span> <span class="variable">newLeft</span> <span class="operator">=</span> (point.x - (pointBackup.x - getItemLeftMargin(indexBackUp))) / <span class="number">2</span> + (pointBackup.x - getItemLeftMargin(indexBackUp));</span><br><span class="line">                            <span class="type">int</span> <span class="variable">newRight</span> <span class="operator">=</span> ((point.x + getItemRightMargin(i)) - pointBackup.x) / <span class="number">2</span> + pointBackup.x;</span><br><span class="line">                            <span class="keyword">if</span> (getItemLeftMargin(indexBackUp) &lt; <span class="number">0</span> &amp;&amp; newLeft + DisplayUtil.dip2px(getContext(), <span class="number">20</span>) &lt; point.x &amp;&amp; i - indexBackUp &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                                left = newLeft - DisplayUtil.dip2px(getContext(), <span class="number">10</span>);</span><br><span class="line">                                right = left + DisplayUtil.dip2px(getContext(), <span class="number">20</span>);</span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (getItemLeftMargin(indexBackUp) &lt; <span class="number">0</span> &amp;&amp; newLeft + DisplayUtil.dip2px(getContext(), <span class="number">40</span>) &gt;= point.x &amp;&amp; i - indexBackUp &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                                left = point.x - DisplayUtil.dip2px(getContext(), <span class="number">30</span>);</span><br><span class="line">                                right = left + DisplayUtil.dip2px(getContext(), <span class="number">20</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (getItemRightMargin(i) &lt; <span class="number">0</span> &amp;&amp; newRight &gt; pointBackup.x + DisplayUtil.dip2px(getContext(), <span class="number">10</span>) &amp;&amp; i - indexBackUp &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                                right = newRight + DisplayUtil.dip2px(getContext(), <span class="number">10</span>);</span><br><span class="line">                                left = right - DisplayUtil.dip2px(getContext(), <span class="number">20</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (getItemLeftMargin(indexBackUp) &lt; <span class="number">0</span> &amp;&amp; getItemRightMargin(i) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                                left = pointBackup.x - getItemLeftMargin(indexBackUp) + scrollWidth / <span class="number">2</span> - DisplayUtil.dip2px(getContext(), <span class="number">10</span>);</span><br><span class="line">                                right = left + DisplayUtil.dip2px(getContext(), <span class="number">20</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="type">Drawable</span> <span class="variable">drawable</span> <span class="operator">=</span> ContextCompat.getDrawable(getContext(), icon);</span><br><span class="line">                            drawable.setBounds(left,</span><br><span class="line">                                    tempBaseBottom + DisplayUtil.dip2px(getContext(), <span class="number">5</span>),</span><br><span class="line">                                    right,</span><br><span class="line">                                    tempBaseBottom + DisplayUtil.dip2px(getContext(), <span class="number">25</span>));</span><br><span class="line">                            drawable.draw(canvas);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            canvas.drawPath(path, linePaint);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">getGoneBehind</span><span class="params">(<span class="type">int</span> index)</span> &#123;</span><br><span class="line">        List&lt;Boolean&gt; data = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> index; k &lt; listItems.size(); k++) &#123;</span><br><span class="line">            data.add(listItems.get(k).getIcon() == -<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> !data.contains(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç»˜åˆ¶åº•éƒ¨æ—¶é—´</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">onDrawText</span><span class="params">(Canvas canvas, <span class="type">int</span> i)</span> &#123;</span><br><span class="line">        textPaint.setTextAlign(Paint.Align.CENTER);</span><br><span class="line">        <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> TimeUtils.getDateHHmm(listItems.get(i).getTempStamp());</span><br><span class="line">        <span class="type">int</span> <span class="variable">left</span> <span class="operator">=</span> MARGIN_LEFT_ITEM + i * ITEM_WIDTH;</span><br><span class="line">        <span class="type">int</span> <span class="variable">right</span> <span class="operator">=</span> left + ITEM_WIDTH - <span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">bottom</span> <span class="operator">=</span> mHeight - bottomTextHeight;</span><br><span class="line">        <span class="type">Rect</span> <span class="variable">targetRect</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Rect</span>(left, bottom, right, bottom + bottomTextHeight);</span><br><span class="line">        Paint.<span class="type">FontMetricsInt</span> <span class="variable">fontMetrics</span> <span class="operator">=</span> textPaint.getFontMetricsInt();</span><br><span class="line">        <span class="type">int</span> <span class="variable">baseline</span> <span class="operator">=</span> (targetRect.bottom + targetRect.top - fontMetrics.bottom - fontMetrics.top) / <span class="number">2</span>;</span><br><span class="line">        textPaint.setTextSize(DisplayUtil.sp2px(getContext(), <span class="number">12</span>));</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">0</span>)</span><br><span class="line">            canvas.drawText(text, left + (ITEM_WIDTH - <span class="number">1</span>) / <span class="number">2</span>, baseline, textPaint);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">drawLeftTempText</span><span class="params">(Canvas canvas)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (listItems.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//ç”»æœ€å·¦ä¾§çš„æ–‡å­—</span></span><br><span class="line">            textPaint.setTextAlign(Paint.Align.LEFT);</span><br><span class="line">            textPaint.setTextSize(DisplayUtil.sp2px(getContext(), <span class="number">13</span>));</span><br><span class="line">            canvas.drawText(maxTemp + <span class="string">&quot;Â°&quot;</span>, DisplayUtil.sp2px(getContext(), <span class="number">15</span>), tempBaseTop, textPaint);</span><br><span class="line">            canvas.drawText(minTemp + <span class="string">&quot;Â°&quot;</span>, DisplayUtil.sp2px(getContext(), <span class="number">15</span>), tempBaseBottom, textPaint);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è®¾ç½®scrollerViewçš„æ»šåŠ¨æ¡çš„ä½ç½®ï¼Œé€šè¿‡ä½ç½®è®¡ç®—å½“å‰çš„æ—¶æ®µ</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setScrollOffset</span><span class="params">(<span class="type">int</span> offset, <span class="type">int</span> maxScrollOffset, <span class="type">int</span> scrollWidth)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.maxScrollOffset = maxScrollOffset;</span><br><span class="line">        <span class="built_in">this</span>.scrollWidth = scrollWidth;</span><br><span class="line">        scrollOffset = offset;</span><br><span class="line">        currentItemIndex = calculateItemIndex();</span><br><span class="line">        invalidate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç‚¹è·ç¦»å·¦è¾¹çš„ä½ç½®</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> i</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">getItemLeftMargin</span><span class="params">(<span class="type">int</span> i)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">left</span> <span class="operator">=</span> MARGIN_LEFT_ITEM + i * ITEM_WIDTH + (ITEM_WIDTH - <span class="number">1</span>) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">return</span> left - scrollOffset;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç‚¹è·ç¦»å³è¾¹çš„ä½ç½®</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> i</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">getItemRightMargin</span><span class="params">(<span class="type">int</span> i)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">left</span> <span class="operator">=</span> MARGIN_LEFT_ITEM + i * ITEM_WIDTH + (ITEM_WIDTH - <span class="number">1</span>) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">return</span> scrollWidth - (left - scrollOffset);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é€šè¿‡æ»šåŠ¨æ¡åç§»é‡è®¡ç®—å½“å‰é€‰æ‹©çš„æ—¶åˆ»</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">calculateItemIndex</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> getScrollBarX();</span><br><span class="line">        <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> MARGIN_LEFT_ITEM - ITEM_WIDTH;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; ITEM_SIZE; i++) &#123;</span><br><span class="line">            sum += ITEM_WIDTH;</span><br><span class="line">            <span class="keyword">if</span> (x &lt; sum)</span><br><span class="line">                <span class="keyword">return</span> i;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ITEM_SIZE - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">getScrollBarX</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> (ITEM_SIZE - <span class="number">5</span>) * ITEM_WIDTH * scrollOffset / maxScrollOffset;</span><br><span class="line">        x = x + MARGIN_LEFT_ITEM;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è®¡ç®—æ¸©åº¦æç¤ºæ–‡å­—çš„è¿åŠ¨è½¨è¿¹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">getTempBarY</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> getScrollBarX();</span><br><span class="line">        <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> MARGIN_LEFT_ITEM;</span><br><span class="line">        <span class="type">Point</span> <span class="variable">startPoint</span> <span class="operator">=</span> <span class="literal">null</span>, endPoint;</span><br><span class="line">        <span class="type">int</span> i;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ITEM_SIZE; i++) &#123;</span><br><span class="line">            sum += ITEM_WIDTH;</span><br><span class="line">            <span class="keyword">if</span> (x &lt; sum) &#123;</span><br><span class="line">                startPoint = listItems.get(i).getTempPoint();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (i + <span class="number">1</span> &gt;= ITEM_SIZE || startPoint == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span> listItems.get(ITEM_SIZE - <span class="number">1</span>).getTempPoint().y;</span><br><span class="line">        endPoint = listItems.get(i + <span class="number">1</span>).getTempPoint();</span><br><span class="line">        <span class="type">int</span> <span class="variable">left</span> <span class="operator">=</span> MARGIN_LEFT_ITEM + i * ITEM_WIDTH;</span><br><span class="line">        <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> (<span class="type">int</span>) (startPoint.y + (x - left) * <span class="number">1.0</span> / ITEM_WIDTH * (endPoint.y - startPoint.y));</span><br><span class="line">        <span class="keyword">return</span> y;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>IndexHorizontalScrollView.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexHorizontalScrollView</span> <span class="keyword">extends</span> <span class="title class_">HorizontalScrollView</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Today24HourView today24HourView;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">IndexHorizontalScrollView</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(context, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">IndexHorizontalScrollView</span><span class="params">(Context context, AttributeSet attrs)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(context, attrs, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">IndexHorizontalScrollView</span><span class="params">(Context context, AttributeSet attrs, <span class="type">int</span> defStyleAttr)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context, attrs, defStyleAttr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onDraw</span><span class="params">(Canvas canvas)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onDraw(canvas);</span><br><span class="line">        <span class="type">int</span> <span class="variable">offset</span> <span class="operator">=</span> computeHorizontalScrollOffset();</span><br><span class="line">        <span class="type">int</span> <span class="variable">maxOffset</span> <span class="operator">=</span> computeHorizontalScrollRange() - DisplayUtil.getScreenWidth(getContext());</span><br><span class="line">        <span class="keyword">if</span> (today24HourView != <span class="literal">null</span>) &#123;</span><br><span class="line">            today24HourView.setScrollOffset(offset, maxOffset, getWidth());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setToday24HourView</span><span class="params">(Today24HourView today24HourView)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.today24HourView = today24HourView;</span><br><span class="line">        invalidate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="xmlä¸­ä½¿ç”¨"><a href="#xmlä¸­ä½¿ç”¨" class="headerlink" title="xmlä¸­ä½¿ç”¨"></a>xmlä¸­ä½¿ç”¨</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">com.weather.gorgeous.custom_view.IndexHorizontalScrollView</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:layout_width</span>=<span class="string">&quot;0dp&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:fadeScrollbars</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:scrollbars</span>=<span class="string">&quot;none&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">com.weather.gorgeous.custom_view.Today24HourView</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">com.weather.gorgeous.custom_view.IndexHorizontalScrollView</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="Activityä¸­ä½¿ç”¨"><a href="#Activityä¸­ä½¿ç”¨" class="headerlink" title="Activityä¸­ä½¿ç”¨"></a>Activityä¸­ä½¿ç”¨</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">binding.indexHorizontalScrollView.setToday24HourView(binding.today24Hour);</span><br><span class="line">binding.today24Hour.setHourItems(data)</span><br></pre></td></tr></table></figure><h2 id="å®ä½“ç±»"><a href="#å®ä½“ç±»" class="headerlink" title="å®ä½“ç±»"></a>å®ä½“ç±»</h2><p><code>WeatherHoursModel.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WeatherHoursModel</span> &#123;</span><br><span class="line">    <span class="comment">// å¤©æ°”å›¾æ ‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> icon;</span><br><span class="line">    <span class="comment">// æ¸©åº¦</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> temperature;</span><br><span class="line">    <span class="comment">//å¤©æ°”</span></span><br><span class="line">    <span class="keyword">private</span> String weather;</span><br><span class="line">    <span class="comment">// æ—¶é—´æˆ³</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> tempStamp;</span><br><span class="line">    <span class="comment">//x,yè½´</span></span><br><span class="line">    <span class="keyword">private</span> Point tempPoint;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å·¥å…·ç±»"><a href="#å·¥å…·ç±»" class="headerlink" title="å·¥å…·ç±»"></a>å·¥å…·ç±»</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getDateHHmm</span><span class="params">(<span class="type">long</span> time)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">formatTime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;HH:mm&quot;</span>).format(<span class="keyword">new</span> <span class="title class_">Date</span>(time));</span><br><span class="line">    <span class="keyword">return</span> formatTime;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">dip2px</span><span class="params">(Context context, <span class="type">float</span> dipValue)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">float</span> <span class="variable">scale</span> <span class="operator">=</span> context.getResources().getDisplayMetrics().density;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">int</span>) (dipValue * scale + <span class="number">0.5f</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">sp2px</span><span class="params">(Context context, <span class="type">float</span> spValue)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">float</span> <span class="variable">fontScale</span> <span class="operator">=</span> context.getResources().getDisplayMetrics().scaledDensity;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">int</span>) (spValue * fontScale + <span class="number">0.5f</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getScreenWidth</span><span class="params">(Context context)</span>&#123;</span><br><span class="line">    <span class="type">DisplayMetrics</span> <span class="variable">dm</span> <span class="operator">=</span> context.getResources().getDisplayMetrics();</span><br><span class="line">    <span class="keyword">return</span> dm.widthPixels;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œæœ‰å†™çš„ä¸å¥½çš„åœ°æ–¹è¿˜è¯·æŒ‡å‡ºã€‚</p><h2 id="Demoåœ°å€"><a href="#Demoåœ°å€" class="headerlink" title="Demoåœ°å€"></a>Demoåœ°å€</h2><p><a href="https://github.com/LazyIonEs/TwentyFourHour">Github</a></p><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p><a href="https://links.jianshu.com/go?to=https://blog.csdn.net/yuton9/article/details/118187905">Android ä»¿å¢¨è¿¹å¤©æ°”24å°æ—¶é¢„æŠ¥</a><br><a href="https://www.jianshu.com/p/47810841abf9">24å°æ—¶å¤©æ°”ï¼ˆå¯æ»‘åŠ¨ï¼‰</a><br><a href="https://links.jianshu.com/go?to=https://github.com/zx391324751/MoJiDemo">MoJiDemo-ä½œè€…zx391324751</a></p>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
          <category> è‡ªå®šä¹‰View </category>
          
          <category> è‡ªå®šä¹‰View </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> è‡ªå®šä¹‰View </tag>
            
            <tag> å¤©æ°” </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
